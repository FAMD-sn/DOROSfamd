<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KCTaxi - –ü–∞–Ω–µ–ª—å –≤–æ–¥–∏—Ç–µ–ª—è (Telegram Bot)</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .order-card {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .order-header {
            font-size: 18px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
        }
        .order-detail {
            margin-bottom: 8px;
            display: flex;
        }
        .detail-label {
            font-weight: bold;
            min-width: 120px;
            color: #7f8c8d;
        }
        .detail-value {
            flex: 1;
        }
        .accept-btn {
            background-color: #27ae60;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 10px;
            width: 100%;
        }
        .status-pending {
            color: #e67e22;
            font-weight: bold;
        }
        .debug-panel {
            background-color: #f0f0f0;
            padding: 15px;
            border-radius: 8px;
            margin-top: 30px;
            font-family: monospace;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <h1>–î–æ—Å—Ç—É–ø–Ω—ã–µ –∑–∞–∫–∞–∑—ã (Telegram Bot)</h1>
    <div id="ordersList">–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–æ–≤...</div>
    
    <div class="debug-panel">
        <h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏:</h3>
        <div id="debugInfo">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</div>
    </div>

    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Telegram –±–æ—Ç–∞
        const BOT_TOKEN = "8233984213:AAE7gKUQRMeacw2X95lRSLrhUYPM-WnjVzg";
        const CHAT_ID = "7456349349";
        
        // ID —Ç–µ–∫—É—â–µ–≥–æ –≤–æ–¥–∏—Ç–µ–ª—è (–º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –ø–æ—Å–ª–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏)
        const currentDriverId = "driver_123";
        const debugInfo = document.getElementById('debugInfo');

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–æ–≤ –∏–∑ Telegram –±–æ—Ç–∞
        async function loadOrders() {
            debugInfo.textContent = "–ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∑–∞–∫–∞–∑—ã —É Telegram –±–æ—Ç–∞...";
            
            try {
                // –ü–æ–ª—É—á–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ç –±–æ—Ç–∞
                const response = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/getUpdates`);
                const data = await response.json();
                
                if (!data.ok) {
                    throw new Error(data.description || "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ—Ç –±–æ—Ç–∞");
                }
                
                // –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –∑–∞–∫–∞–∑–∞–º–∏
                const orders = data.result
                    .filter(update => update.message && update.message.chat.id == CHAT_ID)
                    .map(update => {
                        const text = update.message.text;
                        return parseOrderMessage(text);
                    })
                    .filter(order => order && order.status === "pending");
                
                debugInfo.textContent = `–ù–∞–π–¥–µ–Ω–æ –∑–∞–∫–∞–∑–æ–≤: ${orders.length}`;
                
                const ordersList = document.getElementById('ordersList');
                
                if (orders.length === 0) {
                    ordersList.innerHTML = "<div style='text-align:center; padding:20px; color:#7f8c8d;'>–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤</div>";
                    return;
                }

                ordersList.innerHTML = '';
                orders.forEach((order, index) => {
                    ordersList.innerHTML += `
                        <div class="order-card">
                            <div class="order-header">–ó–∞–∫–∞–∑ #${index + 1}</div>
                            
                            <div class="order-detail">
                                <span class="detail-label">–û—Ç–∫—É–¥–∞:</span>
                                <span class="detail-value">${order.from || '–Ω–µ —É–∫–∞–∑–∞–Ω–æ'}</span>
                            </div>
                            
                            <div class="order-detail">
                                <span class="detail-label">–ö—É–¥–∞:</span>
                                <span class="detail-value">${order.to || '–Ω–µ —É–∫–∞–∑–∞–Ω–æ'}</span>
                            </div>
                            
                            <div class="order-detail">
                                <span class="detail-label">–¢–µ–ª–µ—Ñ–æ–Ω:</span>
                                <span class="detail-value">${order.phone || '–Ω–µ —É–∫–∞–∑–∞–Ω'}</span>
                            </div>
                            
                            <div class="order-detail">
                                <span class="detail-label">–û–ø–ª–∞—Ç–∞:</span>
                                <span class="detail-value">${order.payment || '–Ω–µ —É–∫–∞–∑–∞–Ω–∞'}</span>
                            </div>
                            
                            <div class="order-detail">
                                <span class="detail-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</span>
                                <span class="detail-value">${order.comment || '–Ω–µ—Ç'}</span>
                            </div>
                            
                            <div class="order-detail">
                                <span class="detail-label">–°—Ç–∞—Ç—É—Å:</span>
                                <span class="detail-value status-pending">${order.status}</span>
                            </div>
                            
                            <button onclick="acceptOrder(${index})" class="accept-btn">
                                –ü—Ä–∏–Ω—è—Ç—å –∑–∞–∫–∞–∑
                            </button>
                        </div>
                    `;
                });
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–∞–∫–∞–∑—ã –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ –ø—Ä–∏–Ω—è—Ç–∏—è
                window.currentOrders = orders;
                
            } catch (error) {
                debugInfo.textContent = "–û—à–∏–±–∫–∞: " + error.message;
                document.getElementById('ordersList').innerHTML = `
                    <div style="color:#e74c3c; padding:20px; text-align:center;">
                        –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–æ–≤: ${error.message}
                    </div>
                `;
            }
        }

        // –ü–∞—Ä—Å–∏–Ω–≥ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –∑–∞–∫–∞–∑–æ–º –∏–∑ Telegram
        function parseOrderMessage(text) {
            try {
                // –ü—Ä–∏–º–µ—Ä —Ñ–æ—Ä–º–∞—Ç–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –±–æ—Ç–∞
                const fromMatch = text.match(/–û—Ç–∫—É–¥–∞:\s*(.+)/);
                const toMatch = text.match(/–ö—É–¥–∞:\s*(.+)/);
                const phoneMatch = text.match(/–¢–µ–ª–µ—Ñ–æ–Ω:\s*(.+)/);
                const paymentMatch = text.match(/–û–ø–ª–∞—Ç–∞:\s*(.+)/);
                const commentMatch = text.match(/–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:\s*(.+)/);
                
                return {
                    from: fromMatch ? fromMatch[1].trim() : null,
                    to: toMatch ? toMatch[1].trim() : null,
                    phone: phoneMatch ? phoneMatch[1].trim() : null,
                    payment: paymentMatch ? paymentMatch[1].trim() : null,
                    comment: commentMatch ? commentMatch[1].trim() : null,
                    status: "pending",
                    message: text
                };
            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ —Å–æ–æ–±—â–µ–Ω–∏—è:", e);
                return null;
            }
        }

        // –ü—Ä–∏–Ω—è—Ç—å –∑–∞–∫–∞–∑
        async function acceptOrder(orderIndex) {
            const order = window.currentOrders[orderIndex];
            if (!order) return;
            
            debugInfo.textContent = `–ü—Ä–∏–Ω–∏–º–∞–µ–º –∑–∞–∫–∞–∑ –∏–∑ ${order.from} –≤ ${order.to}...`;
            
            try {
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –±–æ—Ç—É –æ –ø—Ä–∏–Ω—è—Ç–∏–∏ –∑–∞–∫–∞–∑–∞
                const response = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        chat_id: CHAT_ID,
                        text: `üöï –í–æ–¥–∏—Ç–µ–ª—å –ø—Ä–∏–Ω—è–ª –∑–∞–∫–∞–∑!\n\n` +
                              `–û—Ç–∫—É–¥–∞: ${order.from}\n` +
                              `–ö—É–¥–∞: ${order.to}\n` +
                              `–í–æ–¥–∏—Ç–µ–ª—å ID: ${currentDriverId}`
                    })
                });
                
                const data = await response.json();
                
                if (!data.ok) {
                    throw new Error(data.description || "–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –±–æ—Ç—É");
                }
                
                alert('–í—ã —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–Ω—è–ª–∏ –∑–∞–∫–∞–∑! –ë–æ—Ç —É–≤–µ–¥–æ–º–∏–ª –∫–ª–∏–µ–Ω—Ç–∞.');
                debugInfo.textContent = `–ó–∞–∫–∞–∑ –ø—Ä–∏–Ω—è—Ç! –û—Ç–≤–µ—Ç –±–æ—Ç–∞: ${JSON.stringify(data.result)}`;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤
                loadOrders();
                
            } catch (error) {
                debugInfo.textContent = "–û—à–∏–±–∫–∞: " + error.message;
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏–Ω—è—Ç–∏–∏ –∑–∞–∫–∞–∑–∞: ' + error.message);
            }
        }

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–∫–∞–∑—ã –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.onload = loadOrders;
        window.acceptOrder = acceptOrder;
    </script>
</body>
</html>
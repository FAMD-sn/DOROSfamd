<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Khujand City Taxi</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

    <style>
        /* --- –û–±—â–∏–µ —Å—Ç–∏–ª–∏ –∏ —Ç–µ–º–Ω–∞—è —Ç–µ–º–∞ --- */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #1c1c1c; /* –û—á–µ–Ω—å —Ç–µ–º–Ω—ã–π —Ñ–æ–Ω */
            color: #e0e0e0; /* –°–≤–µ—Ç–ª—ã–π —Ç–µ–∫—Å—Ç */
            margin: 0;
            padding: 0;
            line-height: 1.6;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        header {
            background-color: #2a2a2a; /* –¢–µ–º–Ω–µ–µ —Å–µ—Ä–∞—è —à–∞–ø–∫–∞ */
            padding: 15px 25px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
            border-bottom: 1px solid #3a3a3a;
        }

        header img {
            height: 45px;
            margin-right: 15px;
            border-radius: 5px;
        }

        header h1 {
            margin: 0;
            font-size: 1.8em;
            color: #00bcd4; /* –Ø—Ä–∫–∏–π –∞–∫—Ü–µ–Ω—Ç –¥–ª—è –Ω–∞–∑–≤–∞–Ω–∏—è */
        }

        #auth-status {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        #user-email {
            font-weight: bold;
            color: #a0a0a0;
        }

        .container {
            flex-grow: 1;
            max-width: 1300px;
            margin: 25px auto;
            padding: 30px;
            background-color: #252525; /* –¢–µ–º–Ω—ã–π —Ñ–æ–Ω –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ */
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.6);
            border: 1px solid #333;
        }

        h2, h3 {
            color: #00bcd4; /* –ê–∫—Ü–µ–Ω—Ç–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ */
            border-bottom: 2px solid #3a3a3a;
            padding-bottom: 10px;
            margin-bottom: 25px;
        }

        /* --- –§–æ—Ä–º—ã –∏ —ç–ª–µ–º–µ–Ω—Ç—ã –≤–≤–æ–¥–∞ --- */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #c0c0c0;
        }

        .form-group input[type="text"],
        .form-group input[type="email"],
        .form-group input[type="password"],
        .form-group input[type="tel"],
        .form-group input[type="number"],
        .form-group input[type="datetime-local"],
        .form-group select,
        .form-group textarea {
            width: calc(100% - 20px);
            padding: 12px;
            border: 1px solid #444;
            border-radius: 6px;
            background-color: #333;
            color: #f0f0f0;
            box-sizing: border-box;
            font-size: 1em;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: #00bcd4;
            box-shadow: 0 0 0 3px rgba(0, 188, 212, 0.3);
            outline: none;
        }

        .form-group input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.2); /* –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä —á–µ–∫–±–æ–∫—Å–∞ */
            vertical-align: middle;
        }

        /* --- –ö–Ω–æ–ø–∫–∏ --- */
        button {
            background-color: #007bff; /* –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è —Å–∏–Ω—è—è –∫–Ω–æ–ø–∫–∞ */
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1.1em;
            transition: background-color 0.3s ease, transform 0.2s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        button:hover {
            background-color: #0056b3;
            transform: translateY(-2px);
        }

        button:active {
            transform: translateY(0);
        }

        .btn-green {
            background-color: #28a745;
        }
        .btn-green:hover {
            background-color: #218838;
        }

        .btn-red {
            background-color: #dc3545;
        }
        .btn-red:hover {
            background-color: #c82333;
        }

        .btn-blue-light {
            background-color: #17a2b8;
        }
        .btn-blue-light:hover {
            background-color: #138496;
        }

        /* --- –ö–∞—Ä—Ç–∞ --- */
        #map {
            height: 450px;
            width: 100%;
            border-radius: 8px;
            margin-bottom: 25px;
            border: 1px solid #444;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.3);
        }

        /* --- –°–µ–∫—Ü–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (—Å–∫—Ä—ã—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) --- */
        .auth-section, .client-section, .driver-section, .admin-section {
            display: none; /* –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–∫—Ä—ã—Ç–æ, –±—É–¥–µ—Ç –ø–æ–∫–∞–∑–∞–Ω–æ —á–µ—Ä–µ–∑ JS */
            padding-top: 20px;
        }

        /* --- –ö–∞—Ä—Ç–æ—á–∫–∏ –∑–∞–∫–∞–∑–æ–≤/–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π --- */
        .order-card, .user-card {
            background-color: #333;
            border: 1px solid #4a4a4a;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            transition: transform 0.2s ease;
        }

        .order-card:hover, .user-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
        }

        .order-card h3, .user-card p strong {
            color: #00bcd4;
            margin-top: 0;
            margin-bottom: 10px;
        }

        .order-card p, .user-card p {
            margin-bottom: 8px;
        }

        /* --- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è --- */
        .notification {
            background-color: #28a745; /* –ó–µ–ª–µ–Ω—ã–π –¥–ª—è —É—Å–ø–µ—Ö–∞ */
            color: white;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            display: none; /* –°–∫—Ä—ã—Ç–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
            animation: fadeInOut 5s forwards; /* –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è/–∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏—è */
        }

        .notification.error {
            background-color: #dc3545; /* –ö—Ä–∞—Å–Ω—ã–π –¥–ª—è –æ—à–∏–±–æ–∫ */
        }

        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(-10px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-10px); }
        }

        /* --- –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π –¥–∏–∑–∞–π–Ω --- */
        @media (max-width: 768px) {
            header {
                flex-direction: column;
                align-items: flex-start;
            }
            #auth-status {
                margin-top: 10px;
                width: 100%;
                justify-content: flex-end;
            }
            header h1 {
                font-size: 1.5em;
            }
            .container {
                margin: 15px;
                padding: 20px;
            }
            button {
                width: 100%;
                margin-right: 0;
                margin-bottom: 15px;
            }
            .form-group input, .form-group select, .form-group textarea {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <header>
        <div style="display: flex; align-items: center;">
            <img src="https://dorosfamd.com/logotaxi.png" alt="Khujand City Taxi Logo">
            <h1>Khujand City Taxi</h1>
        </div>
        <div id="auth-status">
            <span id="user-email"></span>
            <button id="logout-btn" style="display: none;">–í—ã–π—Ç–∏</button>
        </div>
    </header>

    <div class="container">
        <section id="auth-section" class="auth-section">
            <h2>–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
            <div class="form-group">
                <label for="auth-email">Email:</label>
                <input type="email" id="auth-email" placeholder="example@mail.com">
            </div>
            <div class="form-group">
                <label for="auth-password">–ü–∞—Ä–æ–ª—å:</label>
                <input type="password" id="auth-password" placeholder="–ú–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤">
            </div>
            <button id="login-btn" class="btn-green">–í–æ–π—Ç–∏</button>
            <button id="signup-btn" class="btn-blue-light">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
            <p id="auth-error" class="notification error" style="display: none;"></p>
        </section>

        <section id="client-section" class="client-section">
            <h2>–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –∑–∞–∫–∞–∑</h2>
            <form id="order-form">
                <div class="form-group">
                    <label for="phone-number">üìû –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞:</label>
                    <input type="tel" id="phone-number" placeholder="+992 XXX XX XX XX" required>
                </div>
                <div class="form-group">
                    <label for="from-location">üìç –û—Ç–∫—É–¥–∞ (–Ω–∞ –∫–∞—Ä—Ç–µ –∏–ª–∏ –ø–æ–∏—Å–∫):</label>
                    <input type="text" id="from-location" placeholder="–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–µ" required>
                </div>
                <div class="form-group">
                    <label for="to-location">üìç –ö—É–¥–∞ (–Ω–∞ –∫–∞—Ä—Ç–µ –∏–ª–∏ –ø–æ–∏—Å–∫):</label>
                    <input type="text" id="to-location" placeholder="–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–µ">
                </div>
                <div id="map"></div>
                <button type="button" id="select-from-map-btn" class="btn-blue-light">–í—ã–±—Ä–∞—Ç—å –û—Ç–∫—É–¥–∞ –Ω–∞ –∫–∞—Ä—Ç–µ</button>
                <button type="button" id="select-to-map-btn" class="btn-blue-light">–í—ã–±—Ä–∞—Ç—å –ö—É–¥–∞ –Ω–∞ –∫–∞—Ä—Ç–µ</button>

                <h3>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ–ø—Ü–∏–∏:</h3>
                <div class="form-group">
                    <input type="checkbox" id="luggage"> <label for="luggage">–ß–µ–º–æ–¥–∞–Ω—ã (+4 —Å–æ–º–æ–Ω–∏)</label>
                </div>
                <div class="form-group">
                    <input type="checkbox" id="kids"> <label for="kids">–° –¥–µ—Ç—å–º–∏ (+0 —Å–æ–º–æ–Ω–∏)</label>
                </div>
                <div class="form-group">
                    <input type="checkbox" id="ac"> <label for="ac">–ö–æ–Ω–¥–∏—Ü–∏–æ–Ω–µ—Ä (+1 —Å–æ–º–æ–Ω–∏)</label>
                </div>
                <div class="form-group">
                    <input type="checkbox" id="female-driver"> <label for="female-driver">–ñ–µ–Ω—â–∏–Ω–∞ –∑–∞ —Ä—É–ª—ë–º (+40%)</label>
                </div>
                <div class="form-group">
                    <label for="tips">–ß–∞–µ–≤—ã–µ (—Å–æ–º–æ–Ω–∏):</label>
                    <input type="number" id="tips" min="0" value="0">
                </div>

                <div class="form-group">
                    <label for="tariff">–¢–∞—Ä–∏—Ñ:</label>
                    <select id="tariff">
                        <option value="economy">–≠–∫–æ–Ω–æ–º</option>
                        <option value="comfort">–ö–æ–º—Ñ–æ—Ä—Ç (+30%)</option>
                        <option value="business">–ë–∏–∑–Ω–µ—Å (+20%)</option>
                        <option value="delivery">–î–æ—Å—Ç–∞–≤–∫–∞ (+3 —Å–æ–º–æ–Ω–∏)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="comment">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</label>
                    <textarea id="comment" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è"></textarea>
                </div>
                <div class="form-group">
                    <label for="payment-method">–û–ø–ª–∞—Ç–∞:</label>
                    <select id="payment-method">
                        <option value="cash">–ù–∞–ª–∏—á–Ω—ã–µ</option>
                        <option value="card">–ö–∞—Ä—Ç–∞</option>
                        <option value="khujandcitybank">KhujandCityBank</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="time-option">–í—Ä–µ–º—è –ø–æ–¥–∞—á–∏:</label>
                    <select id="time-option">
                        <option value="now">–°–µ–π—á–∞—Å</option>
                        <option value="later">–í—ã–±—Ä–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –≤—Ä–µ–º—è</option>
                    </select>
                    <input type="datetime-local" id="pickup-time" style="display: none;">
                </div>
                <div class="form-group">
                    <input type="checkbox" id="signboard"> <label for="signboard">–í—Å—Ç—Ä–µ—á–∞ —Å —Ç–∞–±–ª–∏—á–∫–æ–π (+4 —Å–æ–º–æ–Ω–∏)</label>
                </div>
                <p>–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å: <span id="estimated-price">0.00</span> —Å–æ–º–æ–Ω–∏</p>
                <button type="submit" class="btn-green">–ó–∞–∫–∞–∑–∞—Ç—å —Ç–∞–∫—Å–∏</button>
            </form>

            <hr>
            <h3>–ú–æ–∏ –∞–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–∫–∞–∑—ã</h3>
            <div id="client-active-orders-list"></div>
            <h3>–ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤</h3>
            <div id="client-orders-history"></div>
            <div id="client-order-notification" class="notification"></div>
        </section>

        <section id="driver-section" class="driver-section">
            <h2>–î–æ—Å—Ç—É–ø–Ω—ã–µ –∑–∞–∫–∞–∑—ã</h2>
            <div id="available-orders-list"></div>

            <hr>
            <h2>–ú–æ–∏ –ø—Ä–∏–Ω—è—Ç—ã–µ –∑–∞–∫–∞–∑—ã</h2>
            <div id="accepted-orders-list"></div>

            <hr>
            <h2>–ú–æ—è –∏—Å—Ç–æ—Ä–∏—è –ø–æ–µ–∑–¥–æ–∫</h2>
            <div id="driver-history-list"></div>
        </section>

        <section id="admin-section" class="admin-section">
            <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</h2>
            <div class="form-group">
                <label for="admin-user-search">–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ Email:</label>
                <input type="email" id="admin-user-search" placeholder="–ü–æ–∏—Å–∫ –ø–æ email">
            </div>
            <button id="admin-search-user-btn" class="btn-blue-light">–ù–∞–π—Ç–∏</button>
            <div id="user-list"></div>

            <hr>
            <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞–º–∏</h2>
            <div class="form-group">
                <label for="admin-order-search">–ü–æ–∏—Å–∫ –∑–∞–∫–∞–∑–æ–≤ (ID, –∞–¥—Ä–µ—Å):</label>
                <input type="text" id="admin-order-search" placeholder="–ü–æ–∏—Å–∫ –ø–æ ID –∏–ª–∏ –∞–¥—Ä–µ—Å—É">
            </div>
            <button id="admin-search-order-btn" class="btn-blue-light">–ù–∞–π—Ç–∏</button>
            <div id="admin-orders-list"></div>
        </section>
    </div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script>
        // --- 1. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Firebase ---
        // –ó–ê–ú–ï–ù–ò–¢–ï –≠–¢–û –°–í–û–ò–ú–ò –î–ê–ù–ù–´–ú–ò –ò–ó –ö–û–ù–°–û–õ–ò FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyAu-3nDoDijgkmFozFuGNhSsODArolpwA4",
            authDomain: "muzaffar-taxi-427fa.firebaseapp.com",
            projectId: "muzaffar-taxi-427fa",
            storageBucket: "muzaffar-Taxi-427fa.firebasestorage.app",
            messagingSenderId: "1076361280717",
            appId: "1:1076361280717:web:226ca42c35b740fd07fd84"
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- 2. –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –∏ –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ---
        const ADMIN_EMAIL = 'KC@taxi.com';
        const TELEGRAM_BOT_TOKEN = '8233984213:AAE7gKUQRMeacw2X95lRSLrhUYPM-WnjVzg';
        const TELEGRAM_CHAT_ID = '-1002861984015'; // ID —á–∞—Ç–∞, –∫—É–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –∑–∞–∫–∞–∑—ã

        // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
        const authSection = document.getElementById('auth-section');
        const clientSection = document.getElementById('client-section');
        const driverSection = document.getElementById('driver-section');
        const adminSection = document.getElementById('admin-section');

        const logoutBtn = document.getElementById('logout-btn');
        const userEmailSpan = document.getElementById('user-email');
        const authError = document.getElementById('auth-error');

        let userRole = 'client'; // –†–æ–ª—å —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        let currentMap = null; // –ò–Ω—Å—Ç–∞–Ω—Å –∫–∞—Ä—Ç—ã Leaflet
        let fromMarker = null;
        let toMarker = null;
        let selectingLocationFor = null; // 'from' –∏–ª–∏ 'to'
        const initialMapCenter = [38.5733, 68.7735]; // –¶–µ–Ω—Ç—Ä –∫–∞—Ä—Ç—ã (–î—É—à–∞–Ω–±–µ)

        // --- 3. –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ ---

        function showNotification(message, isError = false) {
            const notificationDiv = authError; // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—Ç –∂–µ —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã
            notificationDiv.textContent = message;
            notificationDiv.classList.remove('error');
            if (isError) {
                notificationDiv.classList.add('error');
            }
            notificationDiv.style.display = 'block';
            setTimeout(() => {
                notificationDiv.style.display = 'none';
            }, 5000); // –°–∫—Ä—ã—Ç—å —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
        }

        async function reverseGeocode(lat, lon) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=18&addressdetails=1`);
                const data = await response.json();
                return data.display_name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∞–¥—Ä–µ—Å';
            } catch (error) {
                console.error('Error in reverse geocoding:', error);
                return `${lat.toFixed(4)}, ${lon.toFixed(4)}`; // –í–µ—Ä–Ω—É—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã, –µ—Å–ª–∏ –∞–¥—Ä–µ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω
            }
        }

        async function geocodeAddress(address) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1`);
                const data = await response.json();
                if (data.length > 0) {
                    return { lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon) };
                }
                return null;
            } catch (error) {
                console.error('Error in geocoding:', error);
                return null;
            }
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // –†–∞–¥–∏—É—Å –ó–µ–º–ª–∏ –≤ –∫–º
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a =
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            const distance = R * c;
            return distance; // –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –≤ –∫–º
        }

        async function sendTelegramMessage(text) {
            try {
                const response = await fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        chat_id: TELEGRAM_CHAT_ID,
                        text: text,
                        parse_mode: 'HTML' // –î–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                    })
                });
                const data = await response.json();
                if (!data.ok) {
                    console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram:', data);
                }
            } catch (error) {
                console.error('–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –≤ Telegram:', error);
            }
        }

        // --- 4. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º —Ä–∞–∑–¥–µ–ª–æ–≤ ---
        function displayContentBasedOnRole(role) {
            authSection.style.display = 'none';
            clientSection.style.display = 'none';
            driverSection.style.display = 'none';
            adminSection.style.display = 'none';

            if (role === 'client') {
                clientSection.style.display = 'block';
                initMap();
                loadClientOrders();
            } else if (role === 'driver') {
                driverSection.style.display = 'block';
                loadAvailableOrders();
                loadAcceptedDriverOrders();
                loadDriverHistory();
            } else if (role === 'admin') {
                adminSection.style.display = 'block';
                loadUsersForAdmin();
                loadOrdersForAdmin();
            }
        }

        // --- 5. –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ---
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                userEmailSpan.textContent = user.email;
                logoutBtn.style.display = 'inline-block';
                authSection.style.display = 'none';

                const userDoc = await db.collection('users').doc(user.email).get();
                if (userDoc.exists) {
                    userRole = userDoc.data().role;
                } else {
                    // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç –≤ Firestore (–ø–µ—Ä–≤—ã–π –≤—Ö–æ–¥ –ø–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏), —Å–æ–∑–¥–∞–µ–º –µ–≥–æ –∫–∞–∫ –∫–ª–∏–µ–Ω—Ç–∞
                    userRole = 'client';
                    await db.collection('users').doc(user.email).set({
                        email: user.email,
                        role: userRole
                    });
                }

                // –°–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–æ–µ –ø—Ä–∞–≤–∏–ª–æ –¥–ª—è –∞–¥–º–∏–Ω–∞
                if (user.email === ADMIN_EMAIL) {
                    userRole = 'admin';
                    await db.collection('users').doc(user.email).set({
                        email: user.email,
                        role: userRole
                    }, { merge: true }); // –û–±–Ω–æ–≤–∏—Ç—å, –µ—Å–ª–∏ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
                }

                displayContentBasedOnRole(userRole);

            } else {
                userEmailSpan.textContent = '';
                logoutBtn.style.display = 'none';
                authSection.style.display = 'block';
                // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —Ä–∞–∑–¥–µ–ª—ã, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
                clientSection.style.display = 'none';
                driverSection.style.display = 'none';
                adminSection.style.display = 'none';
            }
        });

        document.getElementById('login-btn').addEventListener('click', async () => {
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            try {
                await auth.signInWithEmailAndPassword(email, password);
                showNotification('–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!', false);
            } catch (error) {
                showNotification(`–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ${error.message}`, true);
            }
        });

        document.getElementById('signup-btn').addEventListener('click', async () => {
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                // –ü—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –≤—Å–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∫–ª–∏–µ–Ω—Ç—ã
                await db.collection('users').doc(userCredential.user.email).set({
                    email: userCredential.user.email,
                    role: 'client'
                });
                showNotification('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –í—ã –≤–æ—à–ª–∏ –∫–∞–∫ –∫–ª–∏–µ–Ω—Ç.', false);
            } catch (error) {
                showNotification(`–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ${error.message}`, true);
            }
        });

        logoutBtn.addEventListener('click', async () => {
            await auth.signOut();
            showNotification('–í—ã –≤—ã—à–ª–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞.', false);
        });

        // --- 6. –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –∫–∞—Ä—Ç—ã Leaflet ---
        function initMap() {
            if (currentMap) {
                currentMap.remove(); // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∏–Ω—Å—Ç–∞–Ω—Å –∫–∞—Ä—Ç—ã, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
            }
            currentMap = L.map('map').setView(initialMapCenter, 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(currentMap);

            currentMap.on('click', async (e) => {
                const latlng = e.latlng;
                const address = await reverseGeocode(latlng.lat, latlng.lng);

                if (selectingLocationFor === 'from') {
                    if (fromMarker) currentMap.removeLayer(fromMarker);
                    fromMarker = L.marker(latlng).addTo(currentMap)
                        .bindPopup(`–û—Ç–∫—É–¥–∞: ${address}`).openPopup();
                    document.getElementById('from-location').value = address;
                } else if (selectingLocationFor === 'to') {
                    if (toMarker) currentMap.removeLayer(toMarker);
                    toMarker = L.marker(latlng).addTo(currentMap)
                        .bindPopup(`–ö—É–¥–∞: ${address}`).openPopup();
                    document.getElementById('to-location').value = address;
                }
                selectingLocationFor = null; // –°–±—Ä–æ—Å–∏—Ç—å —Ä–µ–∂–∏–º –≤—ã–±–æ—Ä–∞
                calculatePrice(); // –ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å —Ü–µ–Ω—É –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ —Ç–æ—á–µ–∫
            });

            document.getElementById('select-from-map-btn').addEventListener('click', () => {
                selectingLocationFor = 'from';
                showNotification('–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å —Ç–æ—á–∫—É "–û—Ç–∫—É–¥–∞"', false);
            });

            document.getElementById('select-to-map-btn').addEventListener('click', () => {
                selectingLocationFor = 'to';
                showNotification('–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å —Ç–æ—á–∫—É "–ö—É–¥–∞"', false);
            });

            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–æ–≤ –ø–æ –≤–≤–æ–¥—É –∞–¥—Ä–µ—Å–∞
            document.getElementById('from-location').addEventListener('change', async (e) => {
                const address = e.target.value;
                const coords = await geocodeAddress(address);
                if (coords) {
                    if (fromMarker) currentMap.removeLayer(fromMarker);
                    fromMarker = L.marker([coords.lat, coords.lon]).addTo(currentMap)
                        .bindPopup(`–û—Ç–∫—É–¥–∞: ${address}`).openPopup();
                    currentMap.setView([coords.lat, coords.lon], 15);
                    calculatePrice();
                } else {
                    showNotification('–ê–¥—Ä–µ—Å "–û—Ç–∫—É–¥–∞" –Ω–µ –Ω–∞–π–¥–µ–Ω.', true);
                }
            });

            document.getElementById('to-location').addEventListener('change', async (e) => {
                const address = e.target.value;
                const coords = await geocodeAddress(address);
                if (coords) {
                    if (toMarker) currentMap.removeLayer(toMarker);
                    toMarker = L.marker([coords.lat, coords.lon]).addTo(currentMap)
                        .bindPopup(`–ö—É–¥–∞: ${address}`).openPopup();
                    currentMap.setView([coords.lat, coords.lon], 15);
                    calculatePrice();
                } else {
                    showNotification('–ê–¥—Ä–µ—Å "–ö—É–¥–∞" –Ω–µ –Ω–∞–π–¥–µ–Ω.', true);
                }
            });
        }

        // --- 7. –†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –ø–æ–µ–∑–¥–∫–∏ ---
        const estimatedPriceSpan = document.getElementById('estimated-price');

        document.querySelectorAll('#order-form input, #order-form select').forEach(element => {
            element.addEventListener('change', calculatePrice);
            element.addEventListener('input', calculatePrice); // –î–ª—è —á–∞–µ–≤—ã—Ö –∏ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ –≤–≤–æ–¥–∞
        });

        function calculatePrice() {
            let basePrice = 0;
            let distanceKm = 0;

            if (fromMarker && toMarker) {
                distanceKm = calculateDistance(
                    fromMarker.getLatLng().lat, fromMarker.getLatLng().lng,
                    toMarker.getLatLng().lat, toMarker.getLatLng().lng
                );

                if (distanceKm >= 1 && distanceKm <= 4) {
                    basePrice = 10;
                } else if (distanceKm > 4) {
                    basePrice = 10 + (distanceKm - 4) * 2.5;
                }
            }

            let totalPrice = basePrice;

            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ–ø—Ü–∏–∏
            if (document.getElementById('luggage').checked) totalPrice += 4;
            // if (document.getElementById('kids').checked) totalPrice += 0; // +0 —Å–æ–º–æ–Ω–∏, —Ç–∞–∫ —á—Ç–æ –Ω–µ –≤–ª–∏—è–µ—Ç
            if (document.getElementById('ac').checked) totalPrice += 1;
            if (document.getElementById('signboard').checked) totalPrice += 4;

            const tariff = document.getElementById('tariff').value;
            if (tariff === 'comfort') totalPrice *= 1.30;
            if (tariff === 'business') totalPrice *= 1.20;
            if (tariff === 'delivery') totalPrice += 3;

            if (document.getElementById('female-driver').checked) totalPrice *= 1.40;

            const tips = parseFloat(document.getElementById('tips').value) || 0;
            totalPrice += tips;

            estimatedPriceSpan.textContent = totalPrice.toFixed(2);
        }

        // --- 8. –ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª ---
        const orderForm = document.getElementById('order-form');
        const clientActiveOrdersList = document.getElementById('client-active-orders-list');
        const clientOrdersHistoryList = document.getElementById('client-orders-history');
        const clientOrderNotification = document.getElementById('client-order-notification');

        document.getElementById('time-option').addEventListener('change', (e) => {
            document.getElementById('pickup-time').style.display = e.target.value === 'later' ? 'block' : 'none';
        });

        orderForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!fromMarker || !toMarker) {
                showNotification('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–æ—á–∫–∏ –û—Ç–∫—É–¥–∞ –∏ –ö—É–¥–∞ –Ω–∞ –∫–∞—Ä—Ç–µ.', true);
                return;
            }

            const pickupTimeElement = document.getElementById('pickup-time');
            const selectedTime = document.getElementById('time-option').value === 'later'
                ? new Date(pickupTimeElement.value)
                : new Date();

            if (document.getElementById('time-option').value === 'later' && !pickupTimeElement.value) {
                showNotification('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è –ø–æ–¥–∞—á–∏.', true);
                return;
            }

            const orderData = {
                phoneNumber: document.getElementById('phone-number').value,
                from: {
                    address: document.getElementById('from-location').value,
                    coords: new firebase.firestore.GeoPoint(fromMarker.getLatLng().lat, fromMarker.getLatLng().lng)
                },
                to: {
                    address: document.getElementById('to-location').value,
                    coords: new firebase.firestore.GeoPoint(toMarker.getLatLng().lat, toMarker.getLatLng().lng)
                },
                options: {
                    luggage: document.getElementById('luggage').checked,
                    kids: document.getElementById('kids').checked,
                    ac: document.getElementById('ac').checked,
                    femaleDriver: document.getElementById('female-driver').checked,
                    signboard: document.getElementById('signboard').checked
                },
                tips: parseFloat(document.getElementById('tips').value) || 0,
                tariff: document.getElementById('tariff').value,
                comment: document.getElementById('comment').value,
                paymentMethod: document.getElementById('payment-method').value,
                timeOption: document.getElementById('time-option').value,
                pickupTime: selectedTime,
                estimatedPrice: parseFloat(estimatedPriceSpan.textContent),
                status: 'pending', // pending, accepted, cancelled, completed, waiting
                clientId: auth.currentUser.email,
                driverId: null,
                driverInfo: null, // –ò–º—è –≤–æ–¥–∏—Ç–µ–ª—è, –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞, –≥–æ—Å –Ω–æ–º–µ—Ä –º–∞—à–∏–Ω—ã, –º–∞—Ä–∫–∞, —Ü–≤–µ—Ç
                waitingStartedAt: null, // –î–ª—è –≤–æ–¥–∏—Ç–µ–ª—è
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                const docRef = await db.collection('orders').add(orderData);
                showNotification('–ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!', false);
                orderForm.reset();
                if (fromMarker) { currentMap.removeLayer(fromMarker); fromMarker = null; }
                if (toMarker) { currentMap.removeLayer(toMarker); toMarker = null; }
                document.getElementById('pickup-time').style.display = 'none'; // –°–∫—Ä—ã—Ç—å –ø–æ–ª–µ –≤—Ä–µ–º–µ–Ω–∏
                calculatePrice(); // –°–±—Ä–æ—Å —Ü–µ–Ω—ã

                await sendTelegramMessage(
                    `<b>–ù–æ–≤—ã–π –∑–∞–∫–∞–∑ #${docRef.id}</b>\n` +
                    `<b>–û—Ç–∫—É–¥–∞:</b> ${orderData.from.address}\n` +
                    `<b>–ö—É–¥–∞:</b> ${orderData.to.address || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}\n` +
                    `<b>–¢–µ–ª–µ—Ñ–æ–Ω:</b> ${orderData.phoneNumber}\n` +
                    `<b>–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è —Ü–µ–Ω–∞:</b> ${orderData.estimatedPrice.toFixed(2)} —Å–æ–º–æ–Ω–∏\n` +
                    `<b>–¢–∞—Ä–∏—Ñ:</b> ${orderData.tariff}\n` +
                    `<b>–û–ø—Ü–∏–∏:</b> ${Object.keys(orderData.options).filter(k => orderData.options[k]).join(', ') || '–ù–µ—Ç'}\n` +
                    (orderData.comment ? `<b>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</b> ${orderData.comment}\n` : '') +
                    `<b>–û–ø–ª–∞—Ç–∞:</b> ${orderData.paymentMethod}\n` +
                    `<b>–í—Ä–µ–º—è:</b> ${orderData.timeOption === 'now' ? '–°–µ–π—á–∞—Å' : orderData.pickupTime.toLocaleString('ru-RU')}`
                );

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞:', error);
                showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.', true);
            }
        });

        function loadClientOrders() {
            if (!auth.currentUser) return;

            db.collection('orders')
                .where('clientId', '==', auth.currentUser.email)
                .orderBy('createdAt', 'desc')
                .onSnapshot(snapshot => {
                    clientActiveOrdersList.innerHTML = '';
                    clientOrdersHistoryList.innerHTML = '';

                    snapshot.forEach(doc => {
                        const order = doc.data();
                        const orderId = doc.id;
                        const orderCard = document.createElement('div');
                        orderCard.classList.add('order-card');
                        orderCard.innerHTML = `
                            <h3>–ó–∞–∫–∞–∑ #${orderId}</h3>
                            <p><strong>–û—Ç–∫—É–¥–∞:</strong> ${order.from.address}</p>
                            <p><strong>–ö—É–¥–∞:</strong> ${order.to.address || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</p>
                            <p><strong>–¶–µ–Ω–∞:</strong> ${order.estimatedPrice.toFixed(2)} —Å–æ–º–æ–Ω–∏</p>
                            <p><strong>–°—Ç–∞—Ç—É—Å:</strong> <span style="color: ${getOrderStatusColor(order.status)}; font-weight: bold;">${getOrderStatusText(order.status)}</span></p>
                            ${order.driverInfo ? `
                                <p><strong>–í–æ–¥–∏—Ç–µ–ª—å:</strong> ${order.driverInfo.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'} (${order.driverInfo.phone || '–ù–µ—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–∞'})</p>
                                <p><strong>–ú–∞—à–∏–Ω–∞:</strong> ${order.driverInfo.carModel || ''} ${order.driverInfo.carColor || ''} (${order.driverInfo.carPlate || '–ù–µ—Ç –Ω–æ–º–µ—Ä–∞'})</p>
                            ` : ''}
                            <p><strong>–í—Ä–µ–º—è –ø–æ–¥–∞—á–∏:</strong> ${order.pickupTime ? new Date(order.pickupTime.toDate()).toLocaleString('ru-RU') : '–°–µ–π—á–∞—Å'}</p>
                            <p><strong>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</strong> ${order.comment || '–ù–µ—Ç'}</p>
                        `;

                        if (order.status === 'pending') {
                            orderCard.innerHTML += `
                                <button class="cancel-order-btn btn-red" data-id="${orderId}">–û—Ç–º–µ–Ω–∏—Ç—å</button>
                                <button class="edit-order-btn btn-blue-light" data-id="${orderId}">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                            `;
                            clientActiveOrdersList.appendChild(orderCard);
                        } else if (order.status === 'accepted' || order.status === 'waiting') {
                             orderCard.innerHTML += `
                                <button class="cancel-order-btn btn-red" data-id="${orderId}">–û—Ç–º–µ–Ω–∏—Ç—å</button>
                                <button class="edit-order-btn btn-blue-light" data-id="${orderId}">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                            `; // –ú–æ–∂–Ω–æ —Ä–∞–∑—Ä–µ—à–∏—Ç—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–≥–æ –º–æ–º–µ–Ω—Ç–∞
                            clientActiveOrdersList.appendChild(orderCard);

                            if (!localStorage.getItem(`client_notified_${orderId}`)) {
                                clientOrderNotification.textContent = `–í–∞—à –∑–∞–∫–∞–∑ #${orderId} –ø—Ä–∏–Ω—è—Ç –≤–æ–¥–∏—Ç–µ–ª–µ–º ${order.driverInfo.name || ''}!`;
                                clientOrderNotification.style.display = 'block';
                                setTimeout(() => clientOrderNotification.style.display = 'none', 7000);
                                localStorage.setItem(`client_notified_${orderId}`, 'true');
                            }
                        } else { // cancelled, completed
                            clientOrdersHistoryList.appendChild(orderCard);
                        }
                    });

                    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫
                    clientActiveOrdersList.querySelectorAll('.cancel-order-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => cancelClientOrder(e.target.dataset.id));
                    });
                    clientActiveOrdersList.querySelectorAll('.edit-order-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => editClientOrder(e.target.dataset.id));
                    });
                });
        }

        async function cancelClientOrder(orderId) {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–º–µ–Ω–∏—Ç—å —ç—Ç–æ—Ç –∑–∞–∫–∞–∑?')) {
                try {
                    await db.collection('orders').doc(orderId).update({ status: 'cancelled' });
                    showNotification('–ó–∞–∫–∞–∑ –æ—Ç–º–µ–Ω–µ–Ω.', false);
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –æ—Ç–º–µ–Ω—ã –∑–∞–∫–∞–∑–∞:', error);
                    showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–º–µ–Ω–∏—Ç—å –∑–∞–∫–∞–∑.', true);
                }
            }
        }

        async function editClientOrder(orderId) {
            showNotification('–§—É–Ω–∫—Ü–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞ –ø–æ–∫–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞.', true);
            // TODO: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∑–∞–≥—Ä—É–∑–∫—É –¥–∞–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–∞ –≤ —Ñ–æ—Ä–º—É –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
        }

        // --- 9. –í–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª ---
        const availableOrdersList = document.getElementById('available-orders-list');
        const acceptedOrdersList = document.getElementById('accepted-orders-list');
        const driverHistoryList = document.getElementById('driver-history-list');

        function loadAvailableOrders() {
            db.collection('orders')
                .where('status', '==', 'pending')
                .orderBy('createdAt', 'asc')
                .onSnapshot(snapshot => {
                    availableOrdersList.innerHTML = '';
                    if (snapshot.empty) {
                        availableOrdersList.innerHTML = '<p>–ü–æ–∫–∞ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤.</p>';
                    }
                    snapshot.forEach(doc => {
                        const order = doc.data();
                        const orderId = doc.id;
                        const orderCard = document.createElement('div');
                        orderCard.classList.add('order-card');
                        orderCard.innerHTML = `
                            <h3>–ó–∞–∫–∞–∑ #${orderId}</h3>
                            <p><strong>–û—Ç–∫—É–¥–∞:</strong> ${order.from.address}</p>
                            <p><strong>–ö—É–¥–∞:</strong> ${order.to.address || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</p>
                            <p><strong>–¶–µ–Ω–∞:</strong> ${order.estimatedPrice.toFixed(2)} —Å–æ–º–æ–Ω–∏</p>
                            <p><strong>–¢–µ–ª–µ—Ñ–æ–Ω –∫–ª–∏–µ–Ω—Ç–∞:</strong> ${order.phoneNumber}</p>
                            <p><strong>–í—Ä–µ–º—è –ø–æ–¥–∞—á–∏:</strong> ${order.pickupTime ? new Date(order.pickupTime.toDate()).toLocaleString('ru-RU') : '–°–µ–π—á–∞—Å'}</p>
                            <p><strong>–¢–∞—Ä–∏—Ñ:</strong> ${order.tariff}</p>
                            <p><strong>–û–ø—Ü–∏–∏:</strong> ${Object.keys(order.options).filter(k => order.options[k]).join(', ') || '–ù–µ—Ç'}</p>
                            <p><strong>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</strong> ${order.comment || '–ù–µ—Ç'}</p>
                            <button class="accept-order-btn btn-green" data-id="${orderId}">–ü—Ä–∏–Ω—è—Ç—å –∑–∞–∫–∞–∑</button>
                        `;
                        availableOrdersList.appendChild(orderCard);
                    });

                    availableOrdersList.querySelectorAll('.accept-order-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => acceptOrder(e.target.dataset.id));
                    });
                });
        }

        async function acceptOrder(orderId) {
            if (!auth.currentUser) {
                showNotification('–í—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã.', true);
                return;
            }

            // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ driverInfo –Ω—É–∂–Ω–æ –ø–æ–ª—É—á–∞—Ç—å –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è –≤–æ–¥–∏—Ç–µ–ª—è –≤ Firestore
            const driverInfo = {
                name: auth.currentUser.email.split('@')[0], // –ü—Ä–æ—Å—Ç–æ –∏–º—è –∏–∑ email
                phone: '+992987654321', // –ü—Ä–∏–º–µ—Ä
                carPlate: '01TAXI99', // –ü—Ä–∏–º–µ—Ä
                carModel: 'Hyundai Elantra', // –ü—Ä–∏–º–µ—Ä
                carColor: '–ë–µ–ª—ã–π' // –ü—Ä–∏–º–µ—Ä
            };

            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –ø—Ä–∏–Ω—è—Ç –ª–∏ –∑–∞–∫–∞–∑ —É–∂–µ
                const orderDoc = await db.collection('orders').doc(orderId).get();
                if (orderDoc.exists && orderDoc.data().status !== 'pending') {
                    showNotification('–≠—Ç–æ—Ç –∑–∞–∫–∞–∑ —É–∂–µ –ø—Ä–∏–Ω—è—Ç –∏–ª–∏ –æ—Ç–º–µ–Ω–µ–Ω.', true);
                    return;
                }

                await db.collection('orders').doc(orderId).update({
                    status: 'accepted',
                    driverId: auth.currentUser.email,
                    driverInfo: driverInfo
                });
                showNotification(`–ó–∞–∫–∞–∑ #${orderId} –ø—Ä–∏–Ω—è—Ç!`, false);

                await sendTelegramMessage(
                    `–ó–∞–∫–∞–∑ <b>#${orderId}</b> –ø—Ä–∏–Ω—è—Ç –≤–æ–¥–∏—Ç–µ–ª–µ–º: <b>${auth.currentUser.email}</b>`
                );

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏–Ω—è—Ç–∏–∏ –∑–∞–∫–∞–∑–∞:', error);
                showNotification(`–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–∏–Ω—è—Ç—å –∑–∞–∫–∞–∑: ${error.message}`, true);
            }
        }

        function loadAcceptedDriverOrders() {
            if (!auth.currentUser) return;

            db.collection('orders')
                .where('driverId', '==', auth.currentUser.email)
                .where('status', 'in', ['accepted', 'waiting']) // –í–æ–¥–∏—Ç–µ–ª—å –≤–∏–¥–∏—Ç –ø—Ä–∏–Ω—è—Ç—ã–µ –∏ –≤ –æ–∂–∏–¥–∞–Ω–∏–∏
                .orderBy('createdAt', 'desc')
                .onSnapshot(snapshot => {
                    acceptedOrdersList.innerHTML = '';
                    if (snapshot.empty) {
                        acceptedOrdersList.innerHTML = '<p>–£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–∏–Ω—è—Ç—ã—Ö –∑–∞–∫–∞–∑–æ–≤.</p>';
                    }
                    snapshot.forEach(doc => {
                        const order = doc.data();
                        const orderId = doc.id;
                        const orderCard = document.createElement('div');
                        orderCard.classList.add('order-card');
                        orderCard.innerHTML = `
                            <h3>–ú–æ–π –∑–∞–∫–∞–∑ #${orderId}</h3>
                            <p><strong>–û—Ç–∫—É–¥–∞:</strong> ${order.from.address}</p>
                            <p><strong>–ö—É–¥–∞:</strong> ${order.to.address || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</p>
                            <p><strong>–¶–µ–Ω–∞:</strong> ${order.estimatedPrice.toFixed(2)} —Å–æ–º–æ–Ω–∏</p>
                            <p><strong>–¢–µ–ª–µ—Ñ–æ–Ω –∫–ª–∏–µ–Ω—Ç–∞:</strong> ${order.phoneNumber}</p>
                            <p><strong>–°—Ç–∞—Ç—É—Å:</strong> <span style="color: ${getOrderStatusColor(order.status)}; font-weight: bold;">${getOrderStatusText(order.status)}</span></p>
                            <p><strong>–í—Ä–µ–º—è –ø–æ–¥–∞—á–∏:</strong> ${order.pickupTime ? new Date(order.pickupTime.toDate()).toLocaleString('ru-RU') : '–°–µ–π—á–∞—Å'}</p>
                            <hr>
                            <button class="driver-cancel-order-btn btn-red" data-id="${orderId}">–û—Ç–º–µ–Ω–∏—Ç—å</button>
                            <button class="driver-edit-order-btn btn-blue-light" data-id="${orderId}">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                            <button class="driver-toggle-waiting-btn ${order.waiting ? 'btn-red' : 'btn-blue-light'}" data-id="${orderId}" data-waiting="${order.waiting || false}">
                                ${order.waiting ? '–í—ã–∫–ª—é—á–∏—Ç—å –æ–∂–∏–¥–∞–Ω–∏–µ' : '–í–∫–ª—é—á–∏—Ç—å –æ–∂–∏–¥–∞–Ω–∏–µ'}
                            </button>
                            <button class="complete-order-btn btn-green" data-id="${orderId}">–ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–∞–∫–∞–∑</button>
                        `;
                        acceptedOrdersList.appendChild(orderCard);
                    });

                    acceptedOrdersList.querySelectorAll('.driver-cancel-order-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => driverCancelOrder(e.target.dataset.id));
                    });
                    acceptedOrdersList.querySelectorAll('.driver-edit-order-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => driverEditOrder(e.target.dataset.id));
                    });
                    acceptedOrdersList.querySelectorAll('.driver-toggle-waiting-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => toggleWaiting(e.target.dataset.id, e.target.dataset.waiting === 'true'));
                    });
                     acceptedOrdersList.querySelectorAll('.complete-order-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => completeOrder(e.target.dataset.id));
                    });
                });
        }

        function loadDriverHistory() {
            if (!auth.currentUser) return;

            db.collection('orders')
                .where('driverId', '==', auth.currentUser.email)
                .where('status', '==', 'completed')
                .orderBy('createdAt', 'desc')
                .onSnapshot(snapshot => {
                    driverHistoryList.innerHTML = '';
                    if (snapshot.empty) {
                        driverHistoryList.innerHTML = '<p>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö –ø–æ–µ–∑–¥–æ–∫.</p>';
                    }
                    snapshot.forEach(doc => {
                        const order = doc.data();
                        const orderId = doc.id;
                        const orderCard = document.createElement('div');
                        orderCard.classList.add('order-card');
                        orderCard.innerHTML = `
                            <h3>–ó–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–π –∑–∞–∫–∞–∑ #${orderId}</h3>
                            <p><strong>–û—Ç–∫—É–¥–∞:</strong> ${order.from.address}</p>
                            <p><strong>–ö—É–¥–∞:</strong> ${order.to.address || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</p>
                            <p><strong>–ò—Ç–æ–≥–æ–≤–∞—è —Ü–µ–Ω–∞:</strong> ${order.estimatedPrice.toFixed(2)} —Å–æ–º–æ–Ω–∏</p>
                            <p><strong>–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è:</strong> ${order.completedAt ? new Date(order.completedAt.toDate()).toLocaleString('ru-RU') : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</p>
                        `;
                        driverHistoryList.appendChild(orderCard);
                    });
                });
        }

        async function driverCancelOrder(orderId) {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–º–µ–Ω–∏—Ç—å —ç—Ç–æ—Ç –∑–∞–∫–∞–∑? –û–Ω –≤–µ—Ä–Ω–µ—Ç—Å—è –≤ —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö.')) {
                try {
                    await db.collection('orders').doc(orderId).update({ status: 'pending', driverId: null, driverInfo: null });
                    showNotification('–ó–∞–∫–∞–∑ –æ—Ç–º–µ–Ω–µ–Ω –∏ –≤–æ–∑–≤—Ä–∞—â–µ–Ω –≤ —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö.', false);
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –æ—Ç–º–µ–Ω—ã –∑–∞–∫–∞–∑–∞ –≤–æ–¥–∏—Ç–µ–ª–µ–º:', error);
                    showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–º–µ–Ω–∏—Ç—å –∑–∞–∫–∞–∑.', true);
                }
            }
        }

        async function driverEditOrder(orderId) {
            showNotification('–§—É–Ω–∫—Ü–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞ –≤–æ–¥–∏—Ç–µ–ª–µ–º –ø–æ–∫–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞.', true);
            // TODO: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ª–æ–≥–∏–∫—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –≤–æ–¥–∏—Ç–µ–ª—è
        }

        async function toggleWaiting(orderId, currentWaitingStatus) {
            const newWaitingStatus = !currentWaitingStatus;
            try {
                if (newWaitingStatus) {
                    await db.collection('orders').doc(orderId).update({
                        status: 'waiting',
                        waiting: true,
                        waitingStartedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    showNotification('–†–µ–∂–∏–º –æ–∂–∏–¥–∞–Ω–∏—è –≤–∫–ª—é—á–µ–Ω. –ù–∞—á–∏–Ω–∞–µ—Ç—Å—è –æ—Ç—Å—á–µ—Ç –≤—Ä–µ–º–µ–Ω–∏.', false);
                } else {
                    const orderDoc = await db.collection('orders').doc(orderId).get();
                    if (orderDoc.exists && orderDoc.data().waitingStartedAt) {
                        const startedAt = orderDoc.data().waitingStartedAt.toDate();
                        const now = new Date();
                        const minutesWaited = Math.ceil((now - startedAt) / (1000 * 60)); // –ú–∏–Ω—É—Ç—ã
                        const waitingCost = minutesWaited * 0.5; // 0.5 —Å–æ–º–æ–Ω–∏ –∑–∞ –º–∏–Ω—É—Ç—É
                        const currentPrice = orderDoc.data().estimatedPrice;
                        const newPrice = currentPrice + waitingCost;

                        await db.collection('orders').doc(orderId).update({
                            status: 'accepted', // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞—Ç—É—Å –∫ accepted
                            waiting: false,
                            waitingStartedAt: null,
                            estimatedPrice: newPrice
                        });
                        showNotification(`–†–µ–∂–∏–º –æ–∂–∏–¥–∞–Ω–∏—è –≤—ã–∫–ª—é—á–µ–Ω. –î–æ–±–∞–≤–ª–µ–Ω–æ ${waitingCost.toFixed(2)} —Å–æ–º–æ–Ω–∏ –∑–∞ ${minutesWaited} –º–∏–Ω—É—Ç –æ–∂–∏–¥–∞–Ω–∏—è. –ù–æ–≤–∞—è —Ü–µ–Ω–∞: ${newPrice.toFixed(2)}`, false);
                    } else {
                        await db.collection('orders').doc(orderId).update({
                            status: 'accepted', // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞—Ç—É—Å –∫ accepted
                            waiting: false,
                            waitingStartedAt: null
                        });
                        showNotification('–†–µ–∂–∏–º –æ–∂–∏–¥–∞–Ω–∏—è –≤—ã–∫–ª—é—á–µ–Ω.', false);
                    }
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –æ–∂–∏–¥–∞–Ω–∏—è:', error);
                showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ä–µ–∂–∏–º –æ–∂–∏–¥–∞–Ω–∏—è.', true);
            }
        }

        async function completeOrder(orderId) {
             if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∑–∞–≤–µ—Ä—à–∏—Ç—å —ç—Ç–æ—Ç –∑–∞–∫–∞–∑?')) {
                try {
                    await db.collection('orders').doc(orderId).update({
                        status: 'completed',
                        completedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    showNotification('–ó–∞–∫–∞–∑ –∑–∞–≤–µ—Ä—à–µ–Ω!', false);
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞:', error);
                    showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≤–µ—Ä—à–∏—Ç—å –∑–∞–∫–∞–∑.', true);
                }
             }
        }

        // --- 10. –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª ---
        const userListDiv = document.getElementById('user-list');
        const adminOrderListDiv = document.getElementById('admin-orders-list');
        const adminUserSearchInput = document.getElementById('admin-user-search');
        const adminOrderSearchInput = document.getElementById('admin-order-search');

        document.getElementById('admin-search-user-btn').addEventListener('click', loadUsersForAdmin);
        document.getElementById('admin-search-order-btn').addEventListener('click', loadOrdersForAdmin);

        function loadUsersForAdmin() {
            let usersRef = db.collection('users');
            const searchTerm = adminUserSearchInput.value.trim().toLowerCase();

            if (searchTerm) {
                // –ü–æ–∏—Å–∫ –ø–æ email, –Ω–∞—á–∏–Ω–∞—é—â–µ–º—É—Å—è —Å searchTerm
                usersRef = usersRef.where('email', '>=', searchTerm).where('email', '<=', searchTerm + '\uf8ff');
            }

            usersRef.onSnapshot(snapshot => {
                userListDiv.innerHTML = '';
                if (snapshot.empty) {
                    userListDiv.innerHTML = '<p>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</p>';
                }
                snapshot.forEach(doc => {
                    const user = doc.data();
                    if (user.email === ADMIN_EMAIL) return; // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –∞–¥–º–∏–Ω–∞ –≤ —Å–ø–∏—Å–∫–µ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

                    const userCard = document.createElement('div');
                    userCard.classList.add('user-card');
                    userCard.innerHTML = `
                        <p><strong>Email:</strong> ${user.email}</p>
                        <p><strong>–†–æ–ª—å:</strong> ${user.role}</p>
                        ${user.role !== 'driver' ? `<button class="assign-driver-btn btn-green" data-email="${user.email}">–ù–∞–∑–Ω–∞—á–∏—Ç—å –≤–æ–¥–∏—Ç–µ–ª–µ–º</button>` : ''}
                        ${user.role === 'driver' ? `<button class="remove-driver-btn btn-red" data-email="${user.email}">–£–≤–æ–ª–∏—Ç—å –≤–æ–¥–∏—Ç–µ–ª—è</button>` : ''}
                    `;
                    userListDiv.appendChild(userCard);
                });

                userListDiv.querySelectorAll('.assign-driver-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => assignDriver(e.target.dataset.email));
                });
                userListDiv.querySelectorAll('.remove-driver-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => removeDriver(e.target.dataset.email));
                });
            });
        }

        async function assignDriver(email) {
            try {
                await db.collection('users').doc(email).update({ role: 'driver' });
                showNotification(`${email} –Ω–∞–∑–Ω–∞—á–µ–Ω –≤–æ–¥–∏—Ç–µ–ª–µ–º.`, false);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–∏ –≤–æ–¥–∏—Ç–µ–ª—è:', error);
                showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–∑–Ω–∞—á–∏—Ç—å –≤–æ–¥–∏—Ç–µ–ª—è.', true);
            }
        }

        async function removeDriver(email) {
            try {
                await db.collection('users').doc(email).update({ role: 'client' });
                showNotification(`${email} –±–æ–ª—å—à–µ –Ω–µ –≤–æ–¥–∏—Ç–µ–ª—å.`, false);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–≤–æ–ª—å–Ω–µ–Ω–∏–∏ –≤–æ–¥–∏—Ç–µ–ª—è:', error);
                showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å —É–≤–æ–ª–∏—Ç—å –≤–æ–¥–∏—Ç–µ–ª—è.', true);
            }
        }

        function loadOrdersForAdmin() {
            let ordersRef = db.collection('orders');
            const searchTerm = adminOrderSearchInput.value.trim().toLowerCase();

            ordersRef.orderBy('createdAt', 'desc').onSnapshot(snapshot => {
                adminOrderListDiv.innerHTML = '';
                if (snapshot.empty) {
                    adminOrderListDiv.innerHTML = '<p>–ó–∞–∫–∞–∑—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</p>';
                }
                snapshot.forEach(doc => {
                    const order = doc.data();
                    const orderId = doc.id;

                    const match = searchTerm === '' ||
                                  orderId.toLowerCase().includes(searchTerm) ||
                                  (order.from && order.from.address && order.from.address.toLowerCase().includes(searchTerm)) ||
                                  (order.to && order.to.address && order.to.address.toLowerCase().includes(searchTerm)) ||
                                  (order.clientId && order.clientId.toLowerCase().includes(searchTerm)) ||
                                  (order.driverId && order.driverId.toLowerCase().includes(searchTerm));

                    if (match) {
                        const orderCard = document.createElement('div');
                        orderCard.classList.add('order-card');
                        orderCard.innerHTML = `
                            <h3>–ó–∞–∫–∞–∑ #${orderId}</h3>
                            <p><strong>–ö–ª–∏–µ–Ω—Ç:</strong> ${order.clientId}</p>
                            <p><strong>–û—Ç–∫—É–¥–∞:</strong> ${order.from.address}</p>
                            <p><strong>–ö—É–¥–∞:</strong> ${order.to.address || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</p>
                            <p><strong>–¶–µ–Ω–∞:</strong> ${order.estimatedPrice.toFixed(2)} —Å–æ–º–æ–Ω–∏</p>
                            <p><strong>–°—Ç–∞—Ç—É—Å:</strong> <span style="color: ${getOrderStatusColor(order.status)}; font-weight: bold;">${getOrderStatusText(order.status)}</span></p>
                            ${order.driverId ? `<p><strong>–í–æ–¥–∏—Ç–µ–ª—å:</strong> ${order.driverId}</p>` : ''}
                            <p><strong>–¢–µ–ª–µ—Ñ–æ–Ω –∫–ª–∏–µ–Ω—Ç–∞:</strong> ${order.phoneNumber}</p>
                            <p><strong>–í—Ä–µ–º—è –ø–æ–¥–∞—á–∏:</strong> ${order.pickupTime ? new Date(order.pickupTime.toDate()).toLocaleString('ru-RU') : '–°–µ–π—á–∞—Å'}</p>
                            <button class="admin-cancel-order-btn btn-red" data-id="${orderId}">–û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–∫–∞–∑</button>
                        `;
                        adminOrderListDiv.appendChild(orderCard);
                    }
                });

                adminOrderListDiv.querySelectorAll('.admin-cancel-order-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => adminCancelOrder(e.target.dataset.id));
                });
            });
        }

        async function adminCancelOrder(orderId) {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–º–µ–Ω–∏—Ç—å —ç—Ç–æ—Ç –∑–∞–∫–∞–∑?')) {
                try {
                    await db.collection('orders').doc(orderId).update({ status: 'cancelled' });
                    showNotification('–ó–∞–∫–∞–∑ –æ—Ç–º–µ–Ω–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.', false);
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ –∑–∞–∫–∞–∑–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º:', error);
                    showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–º–µ–Ω–∏—Ç—å –∑–∞–∫–∞–∑.', true);
                }
            }
        }

        // --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Å—Ç–∞—Ç—É—Å–æ–≤ ---
        function getOrderStatusColor(status) {
            switch (status) {
                case 'pending': return '#ffc107'; // –ñ–µ–ª—Ç—ã–π
                case 'accepted': return '#007bff'; // –°–∏–Ω–∏–π
                case 'waiting': return '#fd7e14'; // –û—Ä–∞–Ω–∂–µ–≤—ã–π
                case 'completed': return '#28a745'; // –ó–µ–ª–µ–Ω—ã–π
                case 'cancelled': return '#dc3545'; // –ö—Ä–∞—Å–Ω—ã–π
                default: return '#e0e0e0';
            }
        }

        function getOrderStatusText(status) {
            switch (status) {
                case 'pending': return '–í –æ–∂–∏–¥–∞–Ω–∏–∏';
                case 'accepted': return '–ü—Ä–∏–Ω—è—Ç';
                case 'waiting': return '–û–∂–∏–¥–∞–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞';
                case 'completed': return '–ó–∞–≤–µ—Ä—à—ë–Ω';
                case 'cancelled': return '–û—Ç–º–µ–Ω—ë–Ω';
                default: return '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
            }
        }
    </script>
</body>
</html>

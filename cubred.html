<meta name='viewport' content='width=device-width, initial-scale=1'/><!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chaos Dodge: Mechanics Expansion</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #050505;
            font-family: 'Segoe UI', sans-serif;
            touch-action: none;
            color: white;
            user-select: none;
        }

        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }

        canvas {
            display: block;
            background: radial-gradient(circle, #1a1a2e 0%, #000000 100%);
        }

        #ui-layer {
            position: absolute;
            top: 20px;
            left: 0;
            width: 100%;
            pointer-events: none;
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 5;
        }

        #in-game-exit {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 10;
            padding: 10px 20px;
            background: rgba(255, 50, 50, 0.7);
            color: white;
            border: 2px solid white;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            pointer-events: auto;
            display: none;
        }

        .stat {
            font-size: 1.2rem;
            font-weight: bold;
            background: rgba(0,0,0,0.5);
            padding: 5px 15px;
            border-radius: 20px;
        }

        .menu-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            text-align: center;
            overflow-y: auto;
            padding: 20px 0;
        }

        .hidden { display: none !important; }

        button {
            padding: 12px 25px;
            font-size: 1rem;
            background: #fff;
            color: #000;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            margin: 5px;
        }
        
        button:active { transform: scale(0.95); }

        input[type="number"] {
            padding: 10px;
            font-size: 1.2rem;
            width: 90px;
            text-align: center;
            border-radius: 10px;
            border: 2px solid #ff4b2b;
            background: #222;
            color: white;
        }

        #debug-ui { background: rgba(30, 0, 0, 0.98); border: 2px solid #ff0000; }
        .debug-row { margin: 10px 0; display: flex; align-items: center; gap: 10px; flex-wrap: wrap; justify-content: center; }
        .toggle-btn { background: #444; color: white; width: 120px; }
        .toggle-btn.on { background: #00ff00; color: black; }

        .shop-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 20px;
            max-width: 90vw;
        }

        .shop-item {
            background: #222;
            padding: 10px;
            border-radius: 12px;
            border: 2px solid transparent;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .shop-item.owned { background: #333; }
        .shop-item.enabled { border-color: #00ff00; }
        .shop-item.disabled { border-color: #ff0000; }

        .currency { color: #ffd700; font-weight: bold; margin-bottom: 10px; font-size: 1.5rem; }
    </style>
</head>
<body>

<div id="game-container">
    <canvas id="gameCanvas"></canvas>
    <button id="in-game-exit">–í–´–•–û–î</button>

    <div id="ui-layer">
        <div id="scoreDisplay" class="stat">–°—á–µ—Ç: 0</div>
        <div id="coinsDisplay" class="stat" style="color:#ffd700">ü™ô: 0</div>
    </div>

    <!-- Main Menu -->
    <div id="overlay" class="menu-overlay">
        <h1 id="menuTitle">CHAOS DODGE</h1>
        <div style="margin-bottom: 20px;">
            <label id="diffLabel">–°–ª–æ–∂–Ω–æ—Å—Ç—å (1-100):</label><br>
            <input type="number" id="difficultyInput" value="5">
        </div>
        <button id="startBtn">–ò–ì–†–ê–¢–¨</button>
        <button id="openShopBtn" style="background:#ffd700">–ú–ê–ì–ê–ó–ò–ù</button>
        <button id="openDebugBtn" style="background:#ff3333; color:white;">DEBUG</button>
    </div>

    <!-- Shop Menu -->
    <div id="shop-ui" class="menu-overlay hidden">
        <h1>–ú–ê–ì–ê–ó–ò–ù –ú–û–î–û–í</h1>
        <div class="currency">ü™ô: <span id="shopCoins">0</span></div>
        <div class="shop-grid">
            <div class="shop-item" id="mod-green" data-type="green" data-price="30">
                <div style="color:#2ecc71; font-size:1.5rem">‚ñ†</div>
                <div>–§–µ–π–∫–∏</div><div class="status-label">30</div>
            </div>
            <div class="shop-item" id="mod-blue" data-type="blue" data-price="60">
                <div style="color:#00d2ff; font-size:1.5rem">‚ñ†</div>
                <div>–ë–æ–º–±—ã</div><div class="status-label">60</div>
            </div>
            <div class="shop-item" id="mod-yellow" data-type="yellow" data-price="100">
                <div style="color:#f1c40f; font-size:1.5rem">‚òÖ</div>
                <div>–•–∞–æ—Å</div><div class="status-label">100</div>
            </div>
            <!-- New items -->
            <div class="shop-item" id="mod-purple" data-type="purple" data-price="150">
                <div style="color:#9b59b6; font-size:1.5rem">‚óÜ</div>
                <div>–¢–µ–ª–µ–ø–æ—Ä—Ç</div><div class="status-label">150</div>
            </div>
            <div class="shop-item" id="mod-orange" data-type="orange" data-price="200">
                <div style="color:#e67e22; font-size:1.5rem">‚ñ≤</div>
                <div>–û—Ö–æ—Ç–Ω–∏–∫</div><div class="status-label">200</div>
            </div>
            <div class="shop-item" id="mod-ghost" data-type="ghost" data-price="250">
                <div style="color:#ecf0f1; font-size:1.5rem">üëª</div>
                <div>–ü—Ä–∏–∑—Ä–∞–∫</div><div class="status-label">250</div>
            </div>
        </div>
        <button id="closeShopBtn">–ù–ê–ó–ê–î</button>
    </div>

    <!-- Debug Menu -->
    <div id="debug-ui" class="menu-overlay hidden">
        <h1 style="color:#ff0000">DEBUG</h1>
        <div class="debug-row">
            <span>–ú–æ–Ω–µ—Ç—ã:</span>
            <input type="number" id="debugCoinsInput" value="9999">
            <button id="setCoinsBtn">–°–ï–¢</button>
        </div>
        <div class="debug-row">
            <span>GodMode:</span>
            <button id="godModeBtn" class="toggle-btn">–í–´–ö–õ</button>
            <span>NoLimit:</span>
            <button id="noLimitBtn" class="toggle-btn">–í–´–ö–õ</button>
        </div>
        <button id="unlockAllBtn" style="background:#00d2ff">–û–¢–ö–†–´–¢–¨ –í–°–ï –¢–ò–ü–´</button>
        <button id="closeDebugBtn" style="margin-top:20px">–ó–ê–ö–†–´–¢–¨</button>
    </div>
</div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const exitBtn = document.getElementById('in-game-exit');
    
    let coins = parseInt(localStorage.getItem('chaos_coins')) || 0;
    let unlocked = JSON.parse(localStorage.getItem('chaos_unlocked')) || { 
        red: true, green: false, blue: false, yellow: false, 
        purple: false, orange: false, ghost: false 
    };
    let enabled = JSON.parse(localStorage.getItem('chaos_enabled')) || { 
        red: true, green: false, blue: false, yellow: false,
        purple: false, orange: false, ghost: false 
    };

    let godMode = false;
    let noDifficultyLimit = false;
    let gameActive = false;
    let score = 0;
    let baseDifficulty = 1;
    let enemies = [];
    let animationId;
    
    const player = { x: 0, y: 0, size: 25 };

    function initCanvas() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', initCanvas);
    initCanvas();

    function getRandomShape() {
        const pts = [];
        const count = 3 + Math.floor(Math.random() * 7);
        for(let i=0; i<count; i++) pts.push({ x: Math.random(), y: Math.random() });
        return pts;
    }

    function spawn() {
        const d = noDifficultyLimit ? baseDifficulty : Math.min(100, baseDifficulty);
        const chance = 0.02 + (d * 0.012);
        if (Math.random() > chance) return;

        let pools = ['red'];
        const types = ['green', 'blue', 'yellow', 'purple', 'orange', 'ghost'];
        types.forEach(t => { if(enabled[t]) pools.push(t); });

        const type = pools[Math.floor(Math.random() * pools.length)];
        const size = 20 + Math.random() * 20;
        const speed = (2 + Math.random() * 2) * (1 + d * 0.035);
        
        const side = Math.floor(Math.random() * 4);
        let x, y, vx, vy;
        if (side === 0) { x = Math.random()*canvas.width; y = -size; vx = (Math.random()-0.5)*4; vy = speed; }
        else if (side === 1) { x = canvas.width+size; y = Math.random()*canvas.height; vx = -speed; vy = (Math.random()-0.5)*4; }
        else if (side === 2) { x = Math.random()*canvas.width; y = canvas.height+size; vx = (Math.random()-0.5)*4; vy = -speed; }
        else { x = -size; y = Math.random()*canvas.height; vx = speed; vy = (Math.random()-0.5)*4; }

        enemies.push({
            x, y, vx, vy, size, type,
            color: {
                red: '#ff4b2b', green: '#2ecc71', blue: '#00d2ff', 
                yellow: '#f1c40f', purple: '#9b59b6', orange: '#e67e22', ghost: '#ecf0f1'
            }[type],
            shape: type === 'yellow' ? getRandomShape() : null,
            state: 'move', t: 0,
            teleported: false,
            visible: true,
            ghostTimer: 0
        });
    }

    function loop() {
        if (!gameActive) return;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        spawn();

        ctx.globalAlpha = godMode ? 0.5 : 1.0;
        ctx.fillStyle = godMode ? "#00ff00" : "#fff";
        ctx.shadowBlur = 15;
        ctx.shadowColor = ctx.fillStyle;
        ctx.fillRect(player.x, player.y, player.size, player.size);
        ctx.shadowBlur = 0;
        ctx.globalAlpha = 1.0;

        for (let i = enemies.length - 1; i >= 0; i--) {
            const e = enemies[i];
            
            // Behaviors
            if (e.type === 'blue') {
                if (e.state === 'move') {
                    e.x += e.vx; e.y += e.vy;
                    if (Math.hypot(e.x - canvas.width/2, e.y - canvas.height/2) < 120) e.state = 'wait';
                } else if (e.state === 'wait') {
                    e.t++;
                    if (e.t > 30) e.state = 'boom';
                } else {
                    e.size += 12;
                    if (e.size > 250) { enemies.splice(i,1); continue; }
                }
            } else if (e.type === 'purple') {
                e.x += e.vx; e.y += e.vy;
                if (!e.teleported && Math.hypot(e.x - player.x, e.y - player.y) < 150) {
                    e.x = Math.random() * (canvas.width - e.size);
                    e.y = Math.random() * (canvas.height - e.size);
                    e.teleported = true;
                }
            } else if (e.type === 'orange') {
                const angle = Math.atan2(player.y - e.y, player.x - e.x);
                const curAngle = Math.atan2(e.vy, e.vx);
                const newAngle = curAngle + (angle - curAngle) * 0.05;
                const mag = Math.hypot(e.vx, e.vy);
                e.vx = Math.cos(newAngle) * mag;
                e.vy = Math.sin(newAngle) * mag;
                e.x += e.vx; e.y += e.vy;
            } else if (e.type === 'ghost') {
                e.x += e.vx; e.y += e.vy;
                e.ghostTimer++;
                if (e.ghostTimer > 60) {
                    e.visible = !e.visible;
                    e.ghostTimer = 0;
                }
            } else {
                e.x += e.vx; e.y += e.vy;
            }

            // Hit test
            if (!godMode && e.type !== 'green' && (e.type !== 'blue' || e.state === 'boom')) {
                if (player.x < e.x + e.size && player.x + player.size > e.x &&
                    player.y < e.y + e.size && player.y + player.size > e.y) {
                    stopGame("–ö–†–ê–•");
                    return;
                }
            }

            // Draw
            if (e.visible || e.type !== 'ghost') {
                ctx.fillStyle = e.color;
                ctx.shadowBlur = 10;
                ctx.shadowColor = e.color;
                if (e.type === 'blue' && e.state === 'wait') ctx.globalAlpha = Math.sin(Date.now()/50)*0.5+0.5;

                if (e.shape) {
                    ctx.beginPath();
                    ctx.moveTo(e.x + e.shape[0].x * e.size, e.y + e.shape[0].y * e.size);
                    for(let j=1; j<e.shape.length; j++) ctx.lineTo(e.x + e.shape[j].x * e.size, e.y + e.shape[j].y * e.size);
                    ctx.closePath();
                    ctx.fill();
                } else if (e.type === 'orange') {
                    ctx.beginPath();
                    ctx.moveTo(e.x, e.y);
                    ctx.lineTo(e.x + e.size, e.y + e.size/2);
                    ctx.lineTo(e.x, e.y + e.size);
                    ctx.closePath();
                    ctx.fill();
                } else if (e.type === 'purple') {
                    ctx.fillRect(e.x, e.y, e.size, e.size);
                    ctx.strokeStyle = "white";
                    ctx.strokeRect(e.x - 2, e.y - 2, e.size + 4, e.size + 4);
                } else {
                    ctx.fillRect(e.x, e.y, e.size, e.size);
                }
                ctx.globalAlpha = 1.0;
            }

            if (e.x < -500 || e.x > canvas.width+500 || e.y < -500 || e.y > canvas.height+500) {
                enemies.splice(i, 1);
                score++;
                if (score % 15 === 0) {
                    coins++;
                    saveData();
                }
            }
        }
        
        document.getElementById('scoreDisplay').innerText = `–°—á–µ—Ç: ${score}`;
        document.getElementById('coinsDisplay').innerText = `ü™ô: ${coins}`;
        animationId = requestAnimationFrame(loop);
    }

    function saveData() {
        localStorage.setItem('chaos_coins', coins);
        localStorage.setItem('chaos_unlocked', JSON.stringify(unlocked));
        localStorage.setItem('chaos_enabled', JSON.stringify(enabled));
    }

    function updateShop() {
        document.getElementById('shopCoins').innerText = coins;
        const types = ['green', 'blue', 'yellow', 'purple', 'orange', 'ghost'];
        types.forEach(type => {
            const btn = document.getElementById('mod-' + type);
            const label = btn.querySelector('.status-label');
            if (unlocked[type]) {
                btn.classList.add('owned');
                if (enabled[type]) { btn.classList.add('enabled'); btn.classList.remove('disabled'); label.innerText = "–í–ö–õ"; }
                else { btn.classList.add('disabled'); btn.classList.remove('enabled'); label.innerText = "–í–´–ö–õ"; }
            } else label.innerText = btn.dataset.price;
        });
    }

    function stopGame(title = "CHAOS DODGE") {
        gameActive = false;
        cancelAnimationFrame(animationId);
        document.getElementById('menuTitle').innerText = title;
        document.getElementById('overlay').classList.remove('hidden');
        exitBtn.style.display = 'none';
        ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    document.getElementById('startBtn').onclick = () => {
        let val = parseInt(document.getElementById('difficultyInput').value) || 1;
        baseDifficulty = noDifficultyLimit ? val : Math.max(1, Math.min(100, val));
        score = 0; enemies = []; gameActive = true;
        document.getElementById('overlay').classList.add('hidden');
        exitBtn.style.display = 'block';
        loop();
    };

    exitBtn.onclick = () => stopGame();

    document.getElementById('openShopBtn').onclick = () => { updateShop(); document.getElementById('shop-ui').classList.remove('hidden'); };
    document.getElementById('closeShopBtn').onclick = () => document.getElementById('shop-ui').classList.add('hidden');
    document.getElementById('openDebugBtn').onclick = () => document.getElementById('debug-ui').classList.remove('hidden');
    document.getElementById('closeDebugBtn').onclick = () => document.getElementById('debug-ui').classList.add('hidden');
    
    document.getElementById('setCoinsBtn').onclick = () => {
        coins = parseInt(document.getElementById('debugCoinsInput').value) || 0;
        saveData();
        updateShop();
    };

    document.getElementById('godModeBtn').onclick = function() {
        godMode = !godMode;
        this.innerText = godMode ? "–í–ö–õ" : "–í–´–ö–õ";
        this.className = "toggle-btn" + (godMode ? " on" : "");
    };

    document.getElementById('noLimitBtn').onclick = function() {
        noDifficultyLimit = !noDifficultyLimit;
        this.innerText = noDifficultyLimit ? "–í–ö–õ" : "–í–´–ö–õ";
        this.className = "toggle-btn" + (noDifficultyLimit ? " on" : "");
    };

    document.getElementById('unlockAllBtn').onclick = () => {
        const types = ['red', 'green', 'blue', 'yellow', 'purple', 'orange', 'ghost'];
        types.forEach(t => { unlocked[t] = true; enabled[t] = true; });
        saveData();
        updateShop();
    };

    const move = (e) => {
        const p = e.touches ? e.touches[0] : e;
        player.x = Math.max(0, Math.min(canvas.width - player.size, p.clientX - player.size/2));
        player.y = Math.max(0, Math.min(canvas.height - player.size, p.clientY - player.size/2));
    };
    canvas.addEventListener('mousemove', move);
    canvas.addEventListener('touchmove', e => { if(gameActive) e.preventDefault(); move(e); }, {passive:false});

    document.querySelectorAll('.shop-item').forEach(item => {
        item.onclick = () => {
            const type = item.dataset.type;
            if (!unlocked[type]) {
                const price = parseInt(item.dataset.price);
                if (coins >= price) { coins -= price; unlocked[type] = true; enabled[type] = true; }
            } else enabled[type] = !enabled[type];
            saveData();
            updateShop();
        };
    });
</script>
</body>
</html>


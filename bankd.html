<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>DOROSBANK PREMIUM ¬∑ –¶–∏—Ñ—Ä–æ–≤–∞—è —ç–∫–æ—Å–∏—Å—Ç–µ–º–∞</title>
  <!-- Material Icons + Font Awesome + Google Fonts -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:ital,wght@0,300;0,400;0,500;0,600;0,700;0,800;1,400&display=swap" rel="stylesheet">
  <!-- QR Code –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode@2.3.4/minified/html5-qrcode.min.js"></script>
  <!-- Firebase SDK 8.10.0 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
  <style>
    /* ========== –ü–†–ï–ú–ò–ê–õ–¨–ù–´–ô –î–ò–ó–ê–ô–ù 2025 ========== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Inter', sans-serif;
    }

    :root {
      --primary: #0a1e3c;
      --primary-dark: #05122b;
      --accent: #00c3a5;
      --accent-soft: #6bffe1;
      --accent-glow: #4dffd9;
      --bg: #0b1428;
      --card-bg: #14223b;
      --surface: #1e314f;
      --text: #ffffff;
      --text-sec: #a0b8d9;
      --text-muted: #6e8bb8;
      --danger: #ff5575;
      --success: #2ed06e;
      --warning: #ffb545;
      --gold: #f0b400;
      --radius-card: 32px;
      --radius-btn: 50px;
      --shadow-card: 0 25px 50px -12px rgba(0,0,0,0.8), 0 0 0 1px rgba(255,255,255,0.06);
      --shadow-glow: 0 0 30px rgba(0,195,165,0.4);
      --glass: rgba(20, 34, 59, 0.7);
    }

    body {
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      font-weight: 400;
      line-height: 1.5;
      overflow-x: hidden;
    }

    /* –£—Ç–∏–ª–∏—Ç—ã */
    .hidden { display: none !important; }

    /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä */
    .container {
      max-width: 1440px;
      margin: 0 auto;
      padding: 0 28px;
    }

    /* ===== –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø ===== */
    #auth-screen {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at 80% 20%, #1e3452, #0a1425);
      padding: 20px;
    }

    .auth-card {
      background: var(--glass);
      backdrop-filter: blur(18px);
      border-radius: 64px;
      padding: 60px 48px;
      width: 100%;
      max-width: 560px;
      border: 1px solid rgba(255,255,255,0.08);
      box-shadow: var(--shadow-card);
      animation: appear 0.5s ease;
    }

    @keyframes appear { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

    .auth-logo {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 16px;
      margin-bottom: 48px;
    }
    .auth-logo .material-icons { font-size: 60px; color: var(--accent); filter: drop-shadow(0 0 15px var(--accent)); }
    .auth-logo span { font-size: 44px; font-weight: 800; background: linear-gradient(135deg, #fff, var(--accent-soft)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

    .auth-tabs {
      display: flex; gap: 12px; background: rgba(5, 18, 43, 0.6); padding: 6px; border-radius: 80px; margin-bottom: 40px;
    }
    .auth-tab {
      flex: 1; padding: 16px; text-align: center; font-weight: 600; border-radius: 60px; cursor: pointer; color: var(--text-muted); transition: 0.2s;
    }
    .auth-tab.active { background: var(--accent); color: #0a1425; box-shadow: 0 5px 20px var(--accent); }

    .auth-input {
      width: 100%; padding: 20px 28px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 60px; font-size: 18px; color: white; margin-bottom: 22px;
    }
    .auth-input:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(0,195,165,0.2); }

    .auth-btn {
      width: 100%; padding: 20px; background: linear-gradient(145deg, var(--accent), #00a089); border: none; border-radius: 60px; font-weight: 700; font-size: 20px; color: #0a1425; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 12px; transition: 0.2s; margin: 24px 0 16px;
    }
    .auth-btn:hover { transform: scale(1.02); box-shadow: var(--shadow-glow); }

    /* ===== –•–ï–î–ï–† ===== */
    .app-header {
      background: var(--glass); backdrop-filter: blur(12px); border-bottom: 1px solid rgba(255,255,255,0.05); padding: 16px 0; position: sticky; top: 0; z-index: 90;
    }
    .header-row { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px; }
    .logo { display: flex; align-items: center; gap: 12px; }
    .logo .material-icons { font-size: 40px; color: var(--accent); }
    .logo span { font-size: 26px; font-weight: 700; background: linear-gradient(135deg, #fff, var(--accent-soft)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

    .user-menu { display: flex; align-items: center; gap: 28px; flex-wrap: wrap; }
    .user-name { font-weight: 500; font-size: 18px; color: var(--text-sec); }
    .admin-badge { background: var(--gold); color: #0a1425; padding: 6px 20px; border-radius: 60px; font-weight: 700; font-size: 14px; }
    .logout-btn { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: white; padding: 12px 28px; border-radius: 60px; display: flex; align-items: center; gap: 10px; cursor: pointer; transition: 0.2s; }
    .logout-btn:hover { background: rgba(255,255,255,0.15); border-color: var(--accent); }

    /* ===== –û–°–ù–û–í–ù–û–ô –õ–ï–ô–ê–£–¢ ===== */
    .app-wrapper { display: flex; gap: 32px; padding: 40px 0; }
    .sidebar { width: 280px; flex-shrink: 0; }
    .nav-menu { background: var(--card-bg); border-radius: 48px; padding: 20px 8px; position: sticky; top: 100px; border: 1px solid rgba(255,255,255,0.05); }
    .nav-item { display: flex; align-items: center; gap: 16px; padding: 18px 24px; border-radius: 60px; color: var(--text-muted); transition: 0.2s; cursor: pointer; font-size: 18px; font-weight: 500; }
    .nav-item .material-icons { font-size: 28px; }
    .nav-item:hover { background: rgba(255,255,255,0.05); color: white; }
    .nav-item.active { background: linear-gradient(90deg, var(--accent) 0%, transparent 90%); color: white; box-shadow: 0 8px 20px rgba(0,195,165,0.3); }

    .main-content { flex: 1; min-width: 0; }

    /* –ë–∞–ª–∞–Ω—Å */
    .balance-widget {
      background: linear-gradient(145deg, var(--card-bg), #0e1a2c); border-radius: 48px; padding: 36px 40px; margin-bottom: 32px; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; border: 1px solid rgba(255,255,255,0.05);
    }
    .balance-info h3 { color: var(--text-muted); font-weight: 400; font-size: 16px; letter-spacing: 2px; margin-bottom: 8px; }
    .balance-amount { font-size: 64px; font-weight: 700; color: white; text-shadow: 0 5px 20px rgba(0,195,165,0.4); }
    .active-card-badge { background: var(--accent); color: #0a1425; padding: 6px 18px; border-radius: 60px; font-weight: 700; margin-left: 20px; }
    .balance-actions { display: flex; gap: 16px; flex-wrap: wrap; }

    .btn-round {
      background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: white; padding: 16px 32px; border-radius: 60px; font-weight: 600; display: flex; align-items: center; gap: 12px; cursor: pointer; transition: 0.2s; backdrop-filter: blur(5px);
    }
    .btn-round.primary { background: var(--accent); color: #0a1425; border: none; box-shadow: 0 8px 20px rgba(0,195,165,0.3); }
    .btn-round:hover { transform: translateY(-2px); background: rgba(255,255,255,0.15); }
    .btn-round.primary:hover { background: #00b39b; }

    /* –ö–∞—Ä—Ç–∞ –ø—Ä–µ–≤—å—é */
    .card-preview {
      background: linear-gradient(135deg, #1d3557, #0f2b4b); border-radius: 48px; padding: 28px 36px; margin-bottom: 40px; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; border: 1px solid rgba(255,255,255,0.15); box-shadow: 0 30px 50px -20px black; position: relative; overflow: hidden;
    }
    .card-preview::after { content: ''; position: absolute; top: -50%; right: -10%; width: 300px; height: 300px; background: radial-gradient(circle, rgba(255,255,255,0.1), transparent 70%); border-radius: 50%; pointer-events: none; }
    .card-preview-left { z-index: 2; }
    .card-type { color: rgba(255,255,255,0.6); font-size: 14px; letter-spacing: 2px; text-transform: uppercase; }
    .card-number { font-family: 'Courier New', monospace; font-size: 28px; font-weight: 600; letter-spacing: 4px; color: white; text-shadow: 0 2px 10px rgba(0,0,0,0.5); }
    .card-holder { font-size: 18px; color: rgba(255,255,255,0.8); text-transform: uppercase; }
    .card-expiry { color: rgba(255,255,255,0.7); font-size: 20px; font-weight: 500; z-index: 2; }

    /* –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è */
    .quick-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 24px; margin-bottom: 48px; }
    .quick-item {
      background: var(--card-bg); border-radius: 36px; padding: 28px 16px; text-align: center; transition: 0.2s; cursor: pointer; border: 1px solid rgba(255,255,255,0.05);
    }
    .quick-item:hover { transform: translateY(-6px); background: #1f3a5f; border-color: var(--accent); }
    .quick-item .material-icons { font-size: 48px; color: var(--accent); margin-bottom: 16px; }
    .quick-item span:last-child { font-size: 18px; font-weight: 600; }

    /* –ö–∞—Ä—Ç–æ—á–∫–∏ —Ä–∞–∑–¥–µ–ª–æ–≤ */
    .section-card { background: var(--card-bg); border-radius: 48px; padding: 36px; margin-bottom: 32px; border: 1px solid rgba(255,255,255,0.05); }
    .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 28px; flex-wrap: wrap; gap: 16px; }
    .section-header h2 { font-size: 28px; font-weight: 600; background: linear-gradient(135deg, #fff, var(--accent-soft)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

    /* –°–ø–∏—Å–æ–∫ –∫–∞—Ä—Ç */
    #cards-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px,1fr)); gap: 24px; margin: 24px 0; }
    .card-item-preview {
      background: #0f1a2b; border-radius: 36px; padding: 28px; border: 1px solid rgba(255,255,255,0.05); transition: 0.2s; cursor: pointer;
    }
    .card-item-preview:hover { border-color: var(--accent); transform: scale(1.02); }

    /* –ú–∞–≥–∞–∑–∏–Ω */
    .shop-grid { display: grid; grid-template-columns: repeat(3,1fr); gap: 30px; }
    .shop-item { background: rgba(5,18,43,0.8); backdrop-filter: blur(8px); border-radius: 48px; padding: 36px 24px; text-align: center; border: 1px solid rgba(255,255,255,0.05); transition: 0.2s; }
    .shop-item:hover { border-color: var(--accent); box-shadow: var(--shadow-glow); }
    .shop-item .material-icons { font-size: 72px; color: var(--accent); }
    .shop-item h4 { font-size: 28px; margin: 16px 0; }
    .card-price { font-size: 36px; font-weight: 800; color: var(--accent); margin: 20px 0; }
    .btn-shop { background: transparent; border: 2px solid var(--accent); color: white; padding: 16px 32px; border-radius: 60px; font-weight: 700; width: 100%; cursor: pointer; transition: 0.2s; }
    .btn-shop:hover { background: var(--accent); color: #0a1425; }

    /* –°–∫–∞–Ω–µ—Ä QR */
    #qr-reader-area { background: #0a1425; border-radius: 48px; padding: 32px; margin-top: 20px; }
    #qr-reader { width: 100%; border-radius: 36px; overflow: hidden; background: black; }
    #qr-reader button { background: var(--accent); border: none; padding: 12px 24px; border-radius: 60px; color: black; font-weight: 600; margin: 10px; }

    /* –°–µ—Ç–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤ */
    .services-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 24px;
      margin-top: 24px;
    }
    .service-card {
      background: linear-gradient(145deg, #1a2740, #101b30);
      border-radius: 36px;
      padding: 28px;
      border: 1px solid rgba(255,255,255,0.05);
      transition: 0.3s;
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }
    .service-card:hover {
      transform: translateY(-8px);
      border-color: var(--accent);
      box-shadow: var(--shadow-glow);
    }
    .service-card .badge {
      position: absolute;
      top: 20px;
      right: 20px;
      background: var(--accent);
      color: #0a1425;
      padding: 6px 16px;
      border-radius: 60px;
      font-weight: 700;
      font-size: 12px;
    }
    .service-icon {
      font-size: 48px;
      color: var(--accent);
      margin-bottom: 20px;
    }
    .service-title {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 12px;
    }
    .service-desc {
      color: var(--text-sec);
      margin-bottom: 24px;
      line-height: 1.6;
    }
    .service-link {
      display: inline-flex;
      align-items: center;
      gap: 12px;
      color: var(--accent);
      font-weight: 600;
      text-decoration: none;
    }

    /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
    .modal {
      position: fixed; top:0;left:0;width:100%;height:100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(16px); display: flex; align-items: center; justify-content: center; z-index: 2000; padding: 24px;
    }
    .modal-content {
      background: var(--card-bg); border-radius: 64px; padding: 48px; width: 100%; max-width: 600px; border: 1px solid rgba(255,255,255,0.1); animation: modalIn 0.3s ease;
    }
    @keyframes modalIn { from { opacity:0; transform: scale(0.9); } to { opacity:1; transform: scale(1); } }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px; }
    .modal-header h3 { font-size: 32px; font-weight: 700; }
    .modal-close { background: none; border: none; color: var(--text-muted); font-size: 48px; cursor: pointer; line-height: 1; }
    .modal-close:hover { color: var(--danger); }

    .form-group { margin-bottom: 28px; }
    .form-group label { display: block; margin-bottom: 12px; color: var(--text-sec); font-size: 18px; font-weight: 500; }
    .form-control { width: 100%; padding: 18px 28px; background: rgba(5,18,43,0.8); border: 1px solid rgba(255,255,255,0.1); border-radius: 60px; color: white; font-size: 18px; }
    .form-control:focus { outline: none; border-color: var(--accent); }

    .alert { padding: 18px 24px; border-radius: 60px; margin: 24px 0; display: flex; align-items: center; gap: 12px; font-size: 16px; }
    .alert-success { background: rgba(46,208,110,0.15); color: var(--success); border: 1px solid var(--success); }
    .alert-danger { background: rgba(255,85,117,0.15); color: var(--danger); border: 1px solid var(--danger); }

    .modal-footer { display: flex; gap: 20px; justify-content: flex-end; margin-top: 32px; }

    /* –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ */
    .transaction { display: flex; justify-content: space-between; align-items: center; padding: 20px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
    .transaction-date { font-size: 14px; color: var(--text-muted); display: flex; align-items: center; gap: 8px; }
    .transaction-description { font-size: 18px; font-weight: 600; }
    .transaction-amount { font-size: 22px; font-weight: 700; }
    .positive { color: var(--success); }
    .negative { color: var(--danger); }

    /* QR */
    .qr-panel { text-align: center; padding: 32px; }
    #qrcode-display canvas, #qrcode-modal canvas { border-radius: 32px; background: white; padding: 16px; margin: 24px auto; box-shadow: 0 20px 40px black; }
    #qr-reader { border-radius: 36px; }

    /* –ê–¥–∞–ø—Ç–∏–≤ */
    @media (max-width: 1000px) {
      .app-wrapper { flex-direction: column; }
      .sidebar { width: 100%; }
      .nav-menu { display: flex; flex-wrap: wrap; gap: 8px; }
      .nav-item { flex: 1; justify-content: center; }
      .quick-grid { grid-template-columns: repeat(2,1fr); }
      .shop-grid { grid-template-columns: 1fr; }
    }
    @media (max-width: 600px) {
      .balance-amount { font-size: 40px; }
      .auth-card { padding: 36px 24px; }
    }
  </style>
</head>
<body>

<!-- –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø -->
<div id="auth-screen">
  <div class="auth-card">
    <div class="auth-logo"><span class="material-icons">account_balance</span><span>DOROSBANK</span></div>
    <div class="auth-tabs"><div class="auth-tab active" id="tab-login">–í—Ö–æ–¥</div><div class="auth-tab" id="tab-reg">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</div></div>
    <div id="login-form">
      <input type="email" id="login-email" class="auth-input" placeholder="–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –ø–æ—á—Ç–∞">
      <input type="password" id="login-password" class="auth-input" placeholder="–ü–∞—Ä–æ–ª—å">
      <button id="login-btn" class="auth-btn"><span class="material-icons">login</span> –í–æ–π—Ç–∏</button>
      <p style="text-align:center;"><a href="#" id="show-register" style="color:var(--accent);">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</a></p>
    </div>
    <div id="register-form" style="display:none;">
      <input type="text" id="register-fullname" class="auth-input" placeholder="–ü–æ–ª–Ω–æ–µ –∏–º—è">
      <input type="tel" id="register-phone" class="auth-input" placeholder="–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞">
      <input type="email" id="register-email" class="auth-input" placeholder="–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –ø–æ—á—Ç–∞">
      <input type="password" id="register-password" class="auth-input" placeholder="–ü–∞—Ä–æ–ª—å (–º–∏–Ω. 6 —Å–∏–º–≤–æ–ª–æ–≤)">
      <button id="register-btn" class="auth-btn"><span class="material-icons">person_add</span> –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
      <p style="text-align:center;"><a href="#" id="show-login" style="color:var(--accent);">–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç</a></p>
    </div>
    <div id="auth-message" class="alert hidden"></div>
  </div>
</div>

<!-- –û–°–ù–û–í–ù–û–ô –ë–ê–ù–ö–û–í–°–ö–ò–ô –ò–ù–¢–ï–†–§–ï–ô–° -->
<div id="bank-screen" class="hidden">
  <header class="app-header">
    <div class="container header-row">
      <div class="logo"><span class="material-icons">account_balance</span><span>DOROSBANK</span></div>
      <div class="user-menu">
        <span class="user-name" id="user-display-name"></span>
        <span id="admin-badge" class="admin-badge hidden">–ê–î–ú–ò–ù</span>
        <button id="logout-btn" class="logout-btn"><span class="material-icons">logout</span> –í—ã–π—Ç–∏</button>
      </div>
    </div>
  </header>

  <div class="container app-wrapper">
    <!-- –ë–æ–∫–æ–≤–æ–µ –º–µ–Ω—é -->
    <aside class="sidebar">
      <div class="nav-menu">
        <div class="nav-item active" data-tab="dashboard"><span class="material-icons">space_dashboard</span> –ì–ª–∞–≤–Ω–∞—è</div>
        <div class="nav-item" data-tab="my-cards"><span class="material-icons">credit_card</span> –ú–æ–∏ –∫–∞—Ä—Ç—ã</div>
        <div class="nav-item" data-tab="buy-cards"><span class="material-icons">shopping_bag</span> –ú–∞–≥–∞–∑–∏–Ω –∫–∞—Ä—Ç</div>
        <div class="nav-item" data-tab="qr-generator"><span class="material-icons">qr_code_2</span> –ú–æ–π QR</div>
        <div class="nav-item" data-tab="qr-scanner"><span class="material-icons">qr_code_scanner</span> –°–∫–∞–Ω–µ—Ä QR</div>
        <div class="nav-item" data-tab="services"><span class="material-icons">apps</span> –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã</div>
        <div class="nav-item" data-tab="analytics"><span class="material-icons">analytics</span> –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</div>
      </div>
    </aside>

    <main class="main-content">
      <!-- DASHBOARD -->
      <div id="dashboard-tab" class="tab-content">
        <div class="balance-widget">
          <div class="balance-info"><h3>–ê–∫—Ç–∏–≤–Ω—ã–π –±–∞–ª–∞–Ω—Å</h3><div class="balance-amount" id="balance">0 TJS</div><span id="active-card-badge" class="active-card-badge">–û—Å–Ω–æ–≤–Ω–∞—è</span></div>
          <div class="balance-actions">
            <button class="btn-round primary" onclick="openModal('deposit-modal')"><span class="material-icons">add</span> –ü–æ–ø–æ–ª–Ω–∏—Ç—å</button>
            <button class="btn-round" onclick="openModal('transfer-modal')"><span class="material-icons">send</span> –ü–µ—Ä–µ–≤–µ—Å—Ç–∏</button>
            <button class="btn-round" onclick="showMyQR()"><span class="material-icons">qr_code</span> –ú–æ–π QR</button>
          </div>
        </div>
        <div class="card-preview" id="active-card-display">
          <div class="card-preview-left"><span class="card-type" id="active-card-type-label">–î–µ–±–µ—Ç–æ–≤–∞—è</span><span class="card-number" id="active-card-number">‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span><span class="card-holder" id="active-card-name">–í–õ–ê–î–ï–õ–ï–¶</span></div>
          <div class="card-expiry" id="active-card-expiry">‚àû/‚àû</div>
        </div>
        <div class="quick-grid">
          <div class="quick-item" onclick="openModal('deposit-modal')"><span class="material-icons">account_balance_wallet</span><span>–ü–æ–ø–æ–ª–Ω–∏—Ç—å</span></div>
          <div class="quick-item" onclick="openModal('transfer-modal')"><span class="material-icons">swap_horiz</span><span>–ü–µ—Ä–µ–≤–µ—Å—Ç–∏</span></div>
          <div class="quick-item" onclick="showMyQR()"><span class="material-icons">qr_code_scanner</span><span>–ú–æ–π QR</span></div>
          <div class="quick-item" onclick="showAllTransactions()"><span class="material-icons">history</span><span>–ò—Å—Ç–æ—Ä–∏—è</span></div>
        </div>
        <div class="section-card"><div class="section-header"><h2>–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</h2><button id="view-all-btn" class="btn-round">–í—Å—è –∏—Å—Ç–æ—Ä–∏—è</button></div><div id="recent-transactions"></div></div>
      </div>

      <!-- –ú–û–ò –ö–ê–†–¢–´ -->
      <div id="my-cards-tab" class="tab-content hidden"><div class="section-card"><h2>–ú–æ–∏ –∫–∞—Ä—Ç—ã</h2><div id="cards-list"></div><button id="add-card-btn" class="btn-round primary">‚ûï –í—ã–ø—É—Å—Ç–∏—Ç—å –∫–∞—Ä—Ç—É</button></div></div>

      <!-- –ú–ê–ì–ê–ó–ò–ù –ö–ê–†–¢ -->
      <div id="buy-cards-tab" class="tab-content hidden"><div class="section-card"><h2>–ü—Ä–∏–æ–±—Ä–µ—Å—Ç–∏ –∫–∞—Ä—Ç—É</h2><div class="shop-grid" id="shop-cards-container"></div></div></div>

      <!-- –ì–ï–ù–ï–†–ê–¢–û–† QR -->
      <div id="qr-generator-tab" class="tab-content hidden">
        <div class="section-card">
          <h2>QR‚Äë–∫–æ–¥ –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞</h2>
          <div style="max-width:500px;margin:auto;">
            <div class="form-group"><label>–ö–∞—Ä—Ç–∞</label><select id="qr-card-select" class="form-control"></select></div>
            <div class="form-group"><label>–°—É–º–º–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label><input type="number" id="qr-amount" class="form-control" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä 500"></div>
            <button id="generate-qr-btn" class="btn-round primary" style="width:100%;">‚ú® –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
            <div id="qr-code-result" style="display:none; margin-top:32px; text-align:center;"><div id="qrcode-display"></div><div id="qr-display-card-number"></div></div>
          </div>
        </div>
      </div>

      <!-- –°–ö–ê–ù–ï–† QR -->
      <div id="qr-scanner-tab" class="tab-content hidden">
        <div class="section-card">
          <h2>–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR‚Äë–∫–æ–¥</h2>
          <p style="color:var(--text-sec); margin-bottom:20px;">–ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ QR‚Äë–∫–æ–¥ –ø–æ–ª—É—á–∞—Ç–µ–ª—è</p>
          <div id="qr-reader-area"><div id="qr-reader"></div></div>
          <div id="scan-result" style="margin-top:24px;"></div>
        </div>
      </div>

      <!-- –í–°–ï –°–ï–†–í–ò–°–´ (8 –±–∞–Ω–∫–æ–≤—Å–∫–∏—Ö/—Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤) -->
      <div id="services-tab" class="tab-content hidden">
        <div class="section-card">
          <div class="section-header"><h2>–ü–ª–∞—Ç–µ–∂–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã DOROS</h2></div>
          <div class="services-grid" id="services-container"></div>
        </div>
      </div>

      <!-- –ê–ù–ê–õ–ò–¢–ò–ö–ê -->
      <div id="analytics-tab" class="tab-content hidden">
        <div class="section-card">
          <h2>–§–∏–Ω–∞–Ω—Å–æ–≤–∞—è —Å–≤–æ–¥–∫–∞</h2>
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:24px; margin:32px 0;">
            <div style="background:#0f1a2b; border-radius:36px; padding:28px;"><span class="material-icons" style="font-size:48px;color:var(--accent);">trending_up</span><div style="font-size:22px;">–î–æ—Ö–æ–¥—ã</div><div style="font-size:36px;font-weight:700;" id="total-income">0 TJS</div></div>
            <div style="background:#0f1a2b; border-radius:36px; padding:28px;"><span class="material-icons" style="font-size:48px;color:var(--danger);">trending_down</span><div style="font-size:22px;">–†–∞—Å—Ö–æ–¥—ã</div><div style="font-size:36px;font-weight:700;" id="total-expense">0 TJS</div></div>
          </div>
          <div>–í—Å–µ–≥–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π: <span id="tx-count">0</span></div>
        </div>
      </div>
    </main>
  </div>
</div>

<!-- –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê -->
<!-- –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ -->
<div id="deposit-modal" class="modal hidden">
  <div class="modal-content"><div class="modal-header"><h3>–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞</h3><button class="modal-close">&times;</button></div>
    <div class="modal-body">
      <div class="form-group"><label>–°—É–º–º–∞ (TJS)</label><input type="number" id="deposit-amount" class="form-control" placeholder="100"></div>
      <div class="form-group"><label>PIN –∫–∞—Ä—Ç—ã</label><input type="password" id="deposit-pin" class="form-control" maxlength="4" placeholder="****"></div>
      <div id="deposit-message" class="alert hidden"></div>
    </div>
    <div class="modal-footer"><button class="btn-round close-modal">–û—Ç–º–µ–Ω–∞</button><button id="confirm-deposit" class="btn-round primary">–ü–æ–ø–æ–ª–Ω–∏—Ç—å</button></div>
  </div>
</div>

<!-- –ü–µ—Ä–µ–≤–æ–¥ -->
<div id="transfer-modal" class="modal hidden">
  <div class="modal-content"><div class="modal-header"><h3>–ü–µ—Ä–µ–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤</h3><button class="modal-close">&times;</button></div>
    <div class="modal-body">
      <div class="form-group"><label>–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã –ø–æ–ª—É—á–∞—Ç–µ–ª—è</label><input type="text" id="recipient-card" class="form-control" placeholder="0000 0000 0000 0000"></div>
      <div class="form-group"><label>–°—É–º–º–∞ (TJS)</label><input type="number" id="transfer-amount" class="form-control" placeholder="500"></div>
      <div class="form-group"><label>–í–∞—à PIN</label><input type="password" id="transfer-pin" class="form-control" maxlength="4" placeholder="****"></div>
      <div class="form-group"><label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label><input type="text" id="transfer-comment" class="form-control" placeholder="–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞"></div>
      <div id="transfer-message" class="alert hidden"></div>
    </div>
    <div class="modal-footer"><button class="btn-round close-modal">–û—Ç–º–µ–Ω–∞</button><button id="confirm-transfer" class="btn-round primary">–ü–µ—Ä–µ–≤–µ—Å—Ç–∏</button></div>
  </div>
</div>

<!-- –î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ä—Ç—É -->
<div id="add-card-modal" class="modal hidden">
  <div class="modal-content"><div class="modal-header"><h3>–í—ã–ø—É—Å–∫ –∫–∞—Ä—Ç—ã</h3><button class="modal-close">&times;</button></div>
    <div class="modal-body">
      <div class="form-group"><label>–¢–∏–ø –∫–∞—Ä—Ç—ã</label><select id="new-card-type" class="form-control"><option value="debit">–î–µ–±–µ—Ç–æ–≤–∞—è (0 TJS)</option><option value="gold">Gold (500 TJS)</option><option value="platinum">Platinum (1000 TJS)</option></select></div>
      <div class="form-group"><label>–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ä—Ç—ã</label><input type="text" id="new-card-name" class="form-control" placeholder="–ú–æ—è –∫–∞—Ä—Ç–∞"></div>
      <div id="add-card-message" class="alert hidden"></div>
    </div>
    <div class="modal-footer"><button class="btn-round close-modal">–û—Ç–º–µ–Ω–∞</button><button id="confirm-add-card" class="btn-round primary">–í—ã–ø—É—Å—Ç–∏—Ç—å</button></div>
  </div>
</div>

<!-- QR-–º–æ–¥–∞–ª–∫–∞ –ø–æ–∫–∞–∑–∞ -->
<div id="qr-modal" class="modal hidden">
  <div class="modal-content" style="max-width:500px;text-align:center;"><div class="modal-header"><h3>–í–∞—à QR-–∫–æ–¥</h3><button class="modal-close">&times;</button></div><div id="qrcode-modal"></div><div id="qr-modal-card-number" style="font-size:20px;margin:20px 0;"></div></div>
</div>

<!-- –ú–æ–¥–∞–ª–∫–∞ –ø—Ä–µ–¥–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ–≥–æ –ø–µ—Ä–µ–≤–æ–¥–∞ (–ø–æ—Å–ª–µ —Å–∫–∞–Ω–∞) -->
<div id="scan-transfer-modal" class="modal hidden">
  <div class="modal-content"><div class="modal-header"><h3>–ü–µ—Ä–µ–≤–æ–¥ –ø–æ QR</h3><button class="modal-close">&times;</button></div>
    <div class="modal-body">
      <div class="form-group"><label>–ö–∞—Ä—Ç–∞ –ø–æ–ª—É—á–∞—Ç–µ–ª—è</label><input type="text" id="scan-recipient-card" class="form-control" readonly></div>
      <div class="form-group"><label>–°—É–º–º–∞ (TJS)</label><input type="number" id="scan-transfer-amount" class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É"></div>
      <div class="form-group"><label>–í–∞—à PIN</label><input type="password" id="scan-transfer-pin" class="form-control" maxlength="4" placeholder="****"></div>
      <div class="form-group"><label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label><input type="text" id="scan-transfer-comment" class="form-control" placeholder="..."></div>
      <div id="scan-transfer-message" class="alert hidden"></div>
    </div>
    <div class="modal-footer"><button class="btn-round close-modal">–û—Ç–º–µ–Ω–∞</button><button id="confirm-scan-transfer" class="btn-round primary">–ü–µ—Ä–µ–≤–µ—Å—Ç–∏</button></div>
  </div>
</div>

<script>
(function() {
  // ========== FIREBASE –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========
  const firebaseConfig = {
    apiKey: "AIzaSyB7DP0EZfTQE78CUj8N-_aPyfEf5MvAc5g",
    authDomain: "doroscoin.firebaseapp.com",
    databaseURL: "https://doroscoin-default-rtdb.firebaseio.com",
    projectId: "doroscoin",
    storageBucket: "doroscoin.appspot.com",
    messagingSenderId: "372256789289",
    appId: "1:372256789289:web:48d518bd16c0c5fa6e5d38"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const database = firebase.database();

  // ========== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ==========
  let currentUser = null;
  let userData = null;
  let userCards = [];
  let activeCardIndex = 0;
  const ADMIN_EMAIL = "doros@bank.tj";

  // ========== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ==========
  const formatAmount = (amt) => new Intl.NumberFormat('ru-RU', { style: 'currency', currency: 'TJS', minimumFractionDigits: 0 }).format(amt || 0);
  
  const generateCardNumber = () => {
    let num = '';
    for (let i = 0; i < 16; i++) {
      num += Math.floor(Math.random() * 10);
      if ((i + 1) % 4 === 0 && i < 15) num += ' ';
    }
    return num;
  };

  const showMessage = (el, text, success) => { 
    el.textContent = text; 
    el.className = `alert ${success ? 'alert-success' : 'alert-danger'}`; 
    el.classList.remove('hidden'); 
    if (success) setTimeout(() => el.classList.add('hidden'), 3000); 
  };

  window.openModal = (id) => document.getElementById(id)?.classList.remove('hidden');
  
  const closeAllModals = () => document.querySelectorAll('.modal').forEach(m => m.classList.add('hidden'));

  // ========== –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–• –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø ==========
  function loadUserData(uid) {
    database.ref(`users/${uid}`).once('value').then(snap => {
      userData = snap.val() || {};
      if (!userData.cards || userData.cards.length === 0) {
        const firstCard = {
          id: 'card_' + Date.now(),
          type: 'debit',
          number: generateCardNumber(),
          name: '–û—Å–Ω–æ–≤–Ω–∞—è –∫–∞—Ä—Ç–∞',
          balance: 5000,
          isPrimary: true,
          pin: '1234',
          expiry: '12/28'
        };
        userData.cards = [firstCard];
        userData.transactions = userData.transactions || [];
        userData.credits = userData.credits || [];
        database.ref(`users/${uid}`).set(userData);
      }
      userCards = userData.cards || [];
      activeCardIndex = userCards.findIndex(c => c.isPrimary);
      if (activeCardIndex === -1 && userCards.length) activeCardIndex = 0;
      updateUI();
    });
  }

  // ========== –û–ë–ù–û–í–õ–ï–ù–ò–ï –ò–ù–¢–ï–†–§–ï–ô–°–ê ==========
  function updateUI() {
    document.getElementById('user-display-name').textContent = userData?.fullName || currentUser?.email || '';
    document.getElementById('admin-badge').classList.toggle('hidden', currentUser?.email !== ADMIN_EMAIL);

    if (userCards.length) {
      const card = userCards[activeCardIndex] || userCards[0];
      document.getElementById('active-card-type-label').textContent = card.type === 'gold' ? 'Gold Card' : card.type === 'platinum' ? 'Platinum Card' : '–î–µ–±–µ—Ç–æ–≤–∞—è –∫–∞—Ä—Ç–∞';
      document.getElementById('active-card-number').textContent = card.number;
      document.getElementById('active-card-name').textContent = (card.name || '–í–ª–∞–¥–µ–ª–µ—Ü').toUpperCase();
      document.getElementById('active-card-expiry').textContent = card.expiry;
      document.getElementById('balance').textContent = formatAmount(card.balance);
    }

    // –°–ø–∏—Å–æ–∫ –∫–∞—Ä—Ç
    const cardsDiv = document.getElementById('cards-list');
    if (cardsDiv) {
      cardsDiv.innerHTML = userCards.map((c, i) => `
        <div class="card-item-preview" onclick="setActiveCard(${i})">
          ${c.isPrimary ? '<span style="background:var(--accent);color:black;padding:4px 12px;border-radius:60px;">‚úì –û—Å–Ω–æ–≤–Ω–∞—è</span>' : ''}
          <div style="font-size:22px;font-weight:600;margin:12px 0;">${c.name}</div>
          <div style="font-family:monospace;">${c.number}</div>
          <div style="font-size:26px;margin-top:16px;">${formatAmount(c.balance)}</div>
        </div>
      `).join('');
    }

    // –°–µ–ª–µ–∫—Ç –¥–ª—è QR
    const qrSelect = document.getElementById('qr-card-select');
    if (qrSelect) {
      qrSelect.innerHTML = userCards.map((c, i) => `<option value="${i}">${c.name} ‚Äî ${c.number}</option>`).join('');
    }

    // –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
    const txs = (userData.transactions || []).slice(0, 7);
    const recentDiv = document.getElementById('recent-transactions');
    if (!txs.length) {
      recentDiv.innerHTML = '<div style="text-align:center;padding:48px;">–ù–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π</div>';
    } else {
      recentDiv.innerHTML = txs.map(t => `
        <div class="transaction">
          <div class="transaction-info">
            <div class="transaction-date"><span class="material-icons">schedule</span>${new Date(t.timestamp).toLocaleString()}</div>
            <div class="transaction-description">${t.type === 'deposit' ? '–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ' : t.type === 'transfer_out' ? '–ò—Å—Ö–æ–¥—è—â–∏–π –ø–µ—Ä–µ–≤–æ–¥' : '–í—Ö–æ–¥—è—â–∏–π –ø–µ—Ä–µ–≤–æ–¥'}</div>
          </div>
          <div class="transaction-amount ${t.type === 'deposit' || t.type === 'transfer_in' ? 'positive' : 'negative'}">
            ${t.type === 'deposit' || t.type === 'transfer_in' ? '+' : '-'}${formatAmount(t.amount)}
          </div>
        </div>
      `).join('');
    }

    // –ê–Ω–∞–ª–∏—Ç–∏–∫–∞
    if (userData.transactions) {
      let inc = 0, exp = 0;
      userData.transactions.forEach(t => { 
        if (t.type === 'deposit' || t.type === 'transfer_in') inc += t.amount; 
        else if (t.type === 'transfer_out' || t.type === 'purchase') exp += t.amount; 
      });
      document.getElementById('total-income').textContent = formatAmount(inc);
      document.getElementById('total-expense').textContent = formatAmount(exp);
      document.getElementById('tx-count').textContent = userData.transactions.length;
    }
  }

  window.setActiveCard = (index) => { 
    if (index >= 0 && index < userCards.length) { 
      activeCardIndex = index; 
      updateUI(); 
    } 
  };

  window.showMyQR = () => {
    if (!userCards.length) return alert('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–∞—Ä—Ç');
    const card = userCards[activeCardIndex] || userCards[0];
    const link = `${window.location.origin}${window.location.pathname}?card=${card.number.replace(/\s/g, '')}`;
    document.getElementById('qrcode-modal').innerHTML = '';
    new QRCode(document.getElementById('qrcode-modal'), { text: link, width: 250, height: 250 });
    document.getElementById('qr-modal-card-number').textContent = card.number;
    document.getElementById('qr-modal').classList.remove('hidden');
  };

  window.showAllTransactions = () => { 
    const txs = userData.transactions || [];
    alert('–ò–°–¢–û–†–ò–Ø –¢–†–ê–ù–ó–ê–ö–¶–ò–ô:\n\n' + (txs.slice(0,20).map(t => 
      `${t.type === 'deposit' ? '‚ûï' : t.type === 'transfer_out' ? '‚ûñ' : 'üîπ'} ${formatAmount(t.amount)} ‚Äî ${new Date(t.timestamp).toLocaleString()}`
    ).join('\n') || '–ù–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π')); 
  };

  // ========== –ü–û–ü–û–õ–ù–ï–ù–ò–ï ==========
  document.getElementById('confirm-deposit')?.addEventListener('click', () => {
    const amount = parseFloat(document.getElementById('deposit-amount').value);
    const pin = document.getElementById('deposit-pin').value;
    const msg = document.getElementById('deposit-message');
    if (!amount || amount <= 0) return showMessage(msg, '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É', false);
    const card = userCards[activeCardIndex];
    if (!card) return;
    if (pin !== card.pin) return showMessage(msg, '–ù–µ–≤–µ—Ä–Ω—ã–π PIN', false);

    card.balance += amount;
    if (!userData.transactions) userData.transactions = [];
    userData.transactions.unshift({ 
      id: Date.now(), 
      type: 'deposit', 
      amount, 
      timestamp: new Date().toISOString() 
    });
    database.ref(`users/${currentUser.uid}`).set(userData).then(() => {
      showMessage(msg, `–ü–æ–ø–æ–ª–Ω–µ–Ω–æ –Ω–∞ ${formatAmount(amount)}`, true);
      setTimeout(closeAllModals, 1500);
      updateUI();
    });
  });

  // ========== –ü–ï–†–ï–í–û–î ==========
  document.getElementById('confirm-transfer')?.addEventListener('click', () => {
    const toCardRaw = document.getElementById('recipient-card').value.replace(/\s/g, '');
    const amount = parseFloat(document.getElementById('transfer-amount').value);
    const pin = document.getElementById('transfer-pin').value;
    const comment = document.getElementById('transfer-comment').value;
    const msg = document.getElementById('transfer-message');
    
    if (!toCardRaw || toCardRaw.length !== 16) return showMessage(msg, '–ù–µ–≤–µ—Ä–Ω—ã–π –Ω–æ–º–µ—Ä –∫–∞—Ä—Ç—ã (16 —Ü–∏—Ñ—Ä)', false);
    if (!amount || amount <= 0) return showMessage(msg, '–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É', false);
    
    const senderCard = userCards[activeCardIndex];
    if (pin !== senderCard.pin) return showMessage(msg, '–ù–µ–≤–µ—Ä–Ω—ã–π PIN', false);
    
    const fee = amount * 0.01; // –∫–æ–º–∏—Å—Å–∏—è 1%
    const total = amount + fee;
    if (total > senderCard.balance) return showMessage(msg, `–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ (–Ω—É–∂–Ω–æ ${formatAmount(total)} —Å —É—á—ë—Ç–æ–º –∫–æ–º–∏—Å—Å–∏–∏)`, false);

    database.ref('users').once('value').then(snap => {
      let recipientUid = null, recipientCard = null, recipientData = null;
      snap.forEach(child => {
        const u = child.val();
        if (u.cards) {
          const found = u.cards.find(c => c.number.replace(/\s/g, '') === toCardRaw);
          if (found) { recipientUid = child.key; recipientCard = found; recipientData = u; }
        }
      });
      
      if (!recipientUid) return showMessage(msg, '–ü–æ–ª—É—á–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω', false);
      if (recipientUid === currentUser.uid) return showMessage(msg, '–ù–µ–ª—å–∑—è –ø–µ—Ä–µ–≤–µ—Å—Ç–∏ —Å–∞–º–æ–º—É —Å–µ–±–µ', false);

      senderCard.balance -= total;
      recipientCard.balance = (recipientCard.balance || 0) + amount;

      const outTx = { 
        id: Date.now(), 
        type: 'transfer_out', 
        amount, 
        to: toCardRaw, 
        fee, 
        comment, 
        timestamp: new Date().toISOString() 
      };
      const inTx = { 
        id: Date.now() + 1, 
        type: 'transfer_in', 
        amount, 
        from: senderCard.number, 
        comment, 
        timestamp: new Date().toISOString() 
      };
      
      if (!userData.transactions) userData.transactions = [];
      if (!recipientData.transactions) recipientData.transactions = [];
      userData.transactions.unshift(outTx);
      recipientData.transactions.unshift(inTx);

      const updates = {};
      updates[`users/${currentUser.uid}`] = userData;
      updates[`users/${recipientUid}`] = recipientData;
      database.ref().update(updates).then(() => {
        showMessage(msg, `–ü–µ—Ä–µ–≤–µ–¥–µ–Ω–æ ${formatAmount(amount)} (–∫–æ–º–∏—Å—Å–∏—è ${formatAmount(fee)})`, true);
        setTimeout(closeAllModals, 2000);
        updateUI();
      }).catch(err => showMessage(msg, '–û—à–∏–±–∫–∞: ' + err.message, false));
    }).catch(err => showMessage(msg, '–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –±–∞–∑–µ', false));
  });

  // ========== –°–ö–ê–ù–ï–† QR ==========
  let html5QrCode = null;
  function startScanner() {
    if (!document.getElementById('qr-scanner-tab').classList.contains('hidden')) {
      const qrReaderDiv = document.getElementById('qr-reader');
      if (!qrReaderDiv) return;
      if (html5QrCode) { 
        html5QrCode.stop().catch(()=>{}); 
        html5QrCode = null; 
      }
      html5QrCode = new Html5Qrcode("qr-reader");
      const config = { fps: 10, qrbox: 250 };
      html5QrCode.start({ facingMode: "environment" }, config, (decodedText) => {
        html5QrCode.stop();
        try {
          const url = new URL(decodedText);
          const cardParam = url.searchParams.get('card');
          const amountParam = url.searchParams.get('amount');
          if (cardParam && cardParam.length === 16) {
            document.getElementById('scan-recipient-card').value = cardParam.match(/.{1,4}/g).join(' ');
            document.getElementById('scan-transfer-amount').value = amountParam || '';
            closeAllModals();
            document.getElementById('scan-transfer-modal').classList.remove('hidden');
          } else {
            alert('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π QR-–∫–æ–¥ (–æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –Ω–æ–º–µ—Ä –∫–∞—Ä—Ç—ã)');
          }
        } catch (e) { 
          alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å QR-–∫–æ–¥'); 
        }
      }, () => {});
    }
  }

  // –ü–µ—Ä–µ–≤–æ–¥ –ø–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–º—É QR
  document.getElementById('confirm-scan-transfer')?.addEventListener('click', () => {
    const toCardRaw = document.getElementById('scan-recipient-card').value.replace(/\s/g, '');
    const amount = parseFloat(document.getElementById('scan-transfer-amount').value);
    const pin = document.getElementById('scan-transfer-pin').value;
    const comment = document.getElementById('scan-transfer-comment').value;
    const msg = document.getElementById('scan-transfer-message');
    
    if (!toCardRaw || toCardRaw.length !== 16) return showMessage(msg, '–û—à–∏–±–∫–∞ –∫–∞—Ä—Ç—ã', false);
    if (!amount || amount <= 0) return showMessage(msg, '–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É', false);
    
    const senderCard = userCards[activeCardIndex];
    if (pin !== senderCard.pin) return showMessage(msg, '–ù–µ–≤–µ—Ä–Ω—ã–π PIN', false);
    
    const fee = amount * 0.01;
    const total = amount + fee;
    if (total > senderCard.balance) return showMessage(msg, `–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ (–Ω—É–∂–Ω–æ ${formatAmount(total)})`, false);

    database.ref('users').once('value').then(snap => {
      let recipientUid = null, recipientCard = null, recipientData = null;
      snap.forEach(child => {
        const u = child.val();
        if (u.cards) {
          const found = u.cards.find(c => c.number.replace(/\s/g, '') === toCardRaw);
          if (found) { recipientUid = child.key; recipientCard = found; recipientData = u; }
        }
      });
      
      if (!recipientUid) return showMessage(msg, '–ü–æ–ª—É—á–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω', false);
      if (recipientUid === currentUser.uid) return showMessage(msg, '–°–∞–º–æ–ø–µ—Ä–µ–≤–æ–¥ –∑–∞–ø—Ä–µ—â—ë–Ω', false);

      senderCard.balance -= total;
      recipientCard.balance += amount;
      
      const outTx = { id: Date.now(), type: 'transfer_out', amount, to: toCardRaw, fee, comment, timestamp: new Date().toISOString() };
      const inTx = { id: Date.now() + 1, type: 'transfer_in', amount, from: senderCard.number, comment, timestamp: new Date().toISOString() };
      
      if (!userData.transactions) userData.transactions = [];
      if (!recipientData.transactions) recipientData.transactions = [];
      userData.transactions.unshift(outTx);
      recipientData.transactions.unshift(inTx);

      const updates = {};
      updates[`users/${currentUser.uid}`] = userData;
      updates[`users/${recipientUid}`] = recipientData;
      database.ref().update(updates).then(() => {
        showMessage(msg, `–ü–µ—Ä–µ–≤–µ–¥–µ–Ω–æ ${formatAmount(amount)}`, true);
        setTimeout(() => { closeAllModals(); updateUI(); }, 1500);
      }).catch(err => showMessage(msg, err.message, false));
    }).catch(err => showMessage(msg, err.message, false));
  });

  // ========== QR-–ì–ï–ù–ï–†–ê–¢–û–† ==========
  document.getElementById('generate-qr-btn')?.addEventListener('click', () => {
    const idx = parseInt(document.getElementById('qr-card-select').value);
    const card = userCards[idx];
    if (!card) return;
    let link = `${window.location.origin}${window.location.pathname}?card=${card.number.replace(/\s/g, '')}`;
    const amount = document.getElementById('qr-amount').value;
    if (amount) link += `&amount=${amount}`;
    document.getElementById('qrcode-display').innerHTML = '';
    new QRCode(document.getElementById('qrcode-display'), { text: link, width: 250, height: 250 });
    document.getElementById('qr-display-card-number').textContent = card.number;
    document.getElementById('qr-code-result').style.display = 'block';
  });

  // ========== –ú–ê–ì–ê–ó–ò–ù –ö–ê–†–¢ ==========
  document.getElementById('shop-cards-container').innerHTML = `
    <div class="shop-item"><span class="material-icons">credit_card</span><h4>–î–µ–±–µ—Ç–æ–≤–∞—è</h4><div class="card-price">0 TJS</div><button class="btn-shop" onclick="quickPurchase('debit')">–ü–æ–ª—É—á–∏—Ç—å</button></div>
    <div class="shop-item"><span class="material-icons">star</span><h4>Gold</h4><div class="card-price">500 TJS</div><button class="btn-shop" onclick="quickPurchase('gold')">–ö—É–ø–∏—Ç—å</button></div>
    <div class="shop-item"><span class="material-icons">diamond</span><h4>Platinum</h4><div class="card-price">1000 TJS</div><button class="btn-shop" onclick="quickPurchase('platinum')">–ö—É–ø–∏—Ç—å</button></div>
  `;

  window.quickPurchase = (type) => {
    document.getElementById('new-card-type').value = type;
    document.getElementById('new-card-name').value = type === 'gold' ? 'Gold Card' : type === 'platinum' ? 'Platinum Card' : 'Debit Card';
    openModal('add-card-modal');
  };

  // ========== –î–û–ë–ê–í–õ–ï–ù–ò–ï –ö–ê–†–¢–´ ==========
  document.getElementById('confirm-add-card')?.addEventListener('click', () => {
    const type = document.getElementById('new-card-type').value;
    const name = document.getElementById('new-card-name').value.trim() || (type === 'gold' ? 'Gold' : type === 'platinum' ? 'Platinum' : '–î–µ–±–µ—Ç–æ–≤–∞—è');
    const price = type === 'gold' ? 500 : type === 'platinum' ? 1000 : 0;
    const msg = document.getElementById('add-card-message');
    const activeCard = userCards[activeCardIndex];
    
    if (price > 0 && price > activeCard.balance) return showMessage(msg, `–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤. –ù—É–∂–Ω–æ ${price} TJS.`, false);
    if (price > 0) activeCard.balance -= price;
    
    const newCard = { 
      id: 'card_' + Date.now(), 
      type, 
      number: generateCardNumber(), 
      name, 
      balance: 0, 
      isPrimary: false, 
      pin: '1234', 
      expiry: '12/28' 
    };
    userCards.push(newCard);
    
    if (price > 0) {
      if (!userData.transactions) userData.transactions = [];
      userData.transactions.unshift({ 
        id: Date.now(), 
        type: 'purchase', 
        amount: price, 
        item: type + ' card', 
        timestamp: new Date().toISOString() 
      });
    }
    
    database.ref(`users/${currentUser.uid}`).set(userData).then(() => { 
      showMessage(msg, '–ö–∞—Ä—Ç–∞ —É—Å–ø–µ—à–Ω–æ –≤—ã–ø—É—â–µ–Ω–∞', true); 
      setTimeout(() => { closeAllModals(); updateUI(); }, 1500); 
    });
  });

  // ========== –°–ï–†–í–ò–°–´ (8 –æ—Ç–æ–±—Ä–∞–Ω–Ω—ã—Ö) ==========
  const financialServices = [
    { 
      id: 'doroshop', 
      title: 'DOROShop', 
      description: '–ú–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å —Å –±–µ–∑–æ–ø–∞—Å–Ω—ã–º–∏ –ø–ª–∞—Ç–µ–∂–∞–º–∏ –∏ –æ–Ω–ª–∞–π–Ω-–æ–ø–ª–∞—Ç–æ–π —Ç–æ–≤–∞—Ä–æ–≤', 
      icon: 'fa-solid fa-cart-shopping', 
      url: 'https://dorosfamd.com/DOROShop', 
      badge: '–ü–õ–ê–¢–ï–ñ–ò' 
    },
    { 
      id: 'famdcoin', 
      title: 'FAMDcoin', 
      description: '–ë–∏—Ä–∂–µ–≤–æ–π –º–æ–Ω–∏—Ç–æ—Ä –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏: –∞–∫—Ü–∏–∏ Apple, Nike, NVIDIA...', 
      icon: 'fa-brands fa-bitcoin',
      url: 'https://dorosfamd.com/akci.html', 
      badge: '–ö–†–ò–ü–¢–û' 
    },
    { 
      id: 'payments', 
      title: 'DOROSpay', 
      description: '–ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–µ –ø–µ—Ä–µ–≤–æ–¥—ã –ø–æ –≤—Å–µ–º—É –º–∏—Ä—É, –æ–ø–ª–∞—Ç–∞ —É—Å–ª—É–≥ –∏ –∫–æ–º–º—É–Ω–∞–ª—å–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π', 
      icon: 'fa-solid fa-credit-card', 
      url: 'https://dorosfamd.com/bankd', 
      badge: '–ü–õ–ê–¢–ï–ñ–ò' 
    },
    { 
      id: 'finance', 
      title: '–§–∏–Ω–∞–Ω—Å—ã', 
      description: '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±—é–¥–∂–µ—Ç–æ–º, –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏ –∏ –∫—Ä–µ–¥–∏—Ç–Ω—ã–π —Ä–µ–π—Ç–∏–Ω–≥', 
      icon: 'fa-solid fa-chart-line', 
      url: 'https://dorosfamd.com/fin', 
      badge: '–§–ò–ù–ê–ù–°–´' 
    },
    { 
      id: 'accounting', 
      title: '–ë—É—Ö–≥–∞–ª—Ç–µ—Ä–∏—è', 
      description: '–û–Ω–ª–∞–π–Ω-–±—É—Ö–≥–∞–ª—Ç–µ—Ä–∏—è –¥–ª—è –±–∏–∑–Ω–µ—Å–∞, –Ω–∞–ª–æ–≥–∏ –∏ –æ—Ç—á—ë—Ç–Ω–æ—Å—Ç—å', 
      icon: 'fa-solid fa-calculator', 
      url: 'https://dorosfamd.com/bschool', 
      badge: '–ë–ò–ó–ù–ï–°' 
    },
    { 
      id: 'businessideas', 
      title: '–ò–¥–µ–∏ –¥–ª—è –±–∏–∑–Ω–µ—Å–∞', 
      description: '–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –±–∏–∑–Ω–µ—Å-–∏–¥–µ–π –∏ –ø–æ–∏—Å–∫ –∏–Ω–≤–µ—Å—Ç–æ—Ä–æ–≤', 
      icon: 'fa-regular fa-lightbulb', 
      url: 'https://dorosfamd.com/ideya', 
      badge: '–°–¢–ê–†–¢–ê–ü' 
    },
    { 
      id: 'taxi', 
      title: '–¢–∞–∫—Å–∏ DOROS', 
      description: '–û–ø–ª–∞—Ç–∞ –ø–æ–µ–∑–¥–æ–∫ —Å –∫–∞—Ä—Ç—ã, –±–æ–Ω—É—Å—ã –∏ –∫–µ—à–±—ç–∫', 
      icon: 'fa-solid fa-taxi', 
      url: 'https://famd-sn.github.io/PIXball/client', 
      badge: '–¢–†–ê–ù–°–ü–û–†–¢' 
    },
    { 
      id: 'currency', 
      title: '–ö–æ–Ω–≤–µ—Ä—Ç–µ—Ä –≤–∞–ª—é—Ç', 
      description: '–ê–∫—Ç—É–∞–ª—å–Ω—ã–µ –∫—É—Ä—Å—ã 150+ –≤–∞–ª—é—Ç –∏ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏', 
      icon: 'fa-solid fa-exchange-alt', 
      url: 'https://dorosfamd.com/FAMDvaluta', 
      badge: '–ö–£–†–°–´' 
    }
  ];

  // –†–µ–Ω–¥–µ—Ä —Å–µ—Ä–≤–∏—Å–æ–≤
  const servicesContainer = document.getElementById('services-container');
  if (servicesContainer) {
    servicesContainer.innerHTML = financialServices.map(s => `
      <div class="service-card" onclick="window.open('${s.url}', '_blank')">
        <span class="badge">${s.badge}</span>
        <div class="service-icon"><i class="${s.icon}"></i></div>
        <div class="service-title">${s.title}</div>
        <div class="service-desc">${s.description}</div>
        <div class="service-link">–ü–µ—Ä–µ–π—Ç–∏ <span class="material-icons">arrow_forward</span></div>
      </div>
    `).join('');
  }

  // ========== –ù–ê–í–ò–ì–ê–¶–ò–Ø ==========
  document.querySelectorAll('.nav-item').forEach(item => {
    item.addEventListener('click', function() {
      document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
      this.classList.add('active');
      document.getElementById(this.dataset.tab + '-tab').classList.remove('hidden');
      if (this.dataset.tab === 'qr-scanner') startScanner();
    });
  });

  // ========== –ö–ù–û–ü–ö–ò –î–ï–ô–°–¢–í–ò–ô ==========
  document.getElementById('add-card-btn')?.addEventListener('click', () => openModal('add-card-modal'));
  document.getElementById('logout-btn')?.addEventListener('click', () => auth.signOut());
  document.getElementById('view-all-btn')?.addEventListener('click', showAllTransactions);
  document.querySelectorAll('.modal-close, .close-modal').forEach(b => b.addEventListener('click', closeAllModals));

  // ========== –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ï –§–û–†–ú –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò ==========
  document.getElementById('show-register')?.addEventListener('click', (e) => { e.preventDefault(); toggleAuthForm('reg'); });
  document.getElementById('show-login')?.addEventListener('click', (e) => { e.preventDefault(); toggleAuthForm('login'); });
  document.getElementById('tab-login').addEventListener('click', () => toggleAuthForm('login'));
  document.getElementById('tab-reg').addEventListener('click', () => toggleAuthForm('reg'));

  function toggleAuthForm(type) {
    const loginForm = document.getElementById('login-form');
    const regForm = document.getElementById('register-form');
    const tabs = document.querySelectorAll('.auth-tab');
    if (type === 'login') {
      loginForm.style.display = 'block'; regForm.style.display = 'none';
      tabs[0].classList.add('active'); tabs[1].classList.remove('active');
    } else {
      loginForm.style.display = 'none'; regForm.style.display = 'block';
      tabs[0].classList.remove('active'); tabs[1].classList.add('active');
    }
  }

  // ========== –í–•–û–î / –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø ==========
  document.getElementById('login-btn').addEventListener('click', () => {
    const email = document.getElementById('login-email').value;
    const pass = document.getElementById('login-password').value;
    auth.signInWithEmailAndPassword(email, pass)
      .catch(e => showMessage(document.getElementById('auth-message'), e.message, false));
  });

  document.getElementById('register-btn').addEventListener('click', () => {
    const name = document.getElementById('register-fullname').value;
    const phone = document.getElementById('register-phone').value;
    const email = document.getElementById('register-email').value;
    const pass = document.getElementById('register-password').value;
    if (!name || !phone || !email || pass.length < 6) {
      return showMessage(document.getElementById('auth-message'), '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è, –ø–∞—Ä–æ–ª—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤', false);
    }
    auth.createUserWithEmailAndPassword(email, pass)
      .then(cred => {
        const uid = cred.user.uid;
        const userRecord = { fullName: name, phone, email, cards: [], transactions: [], credits: [] };
        database.ref(`users/${uid}`).set(userRecord).then(() => loadUserData(uid));
      })
      .catch(e => showMessage(document.getElementById('auth-message'), e.message, false));
  });

  // ========== –°–õ–£–®–ê–¢–ï–õ–¨ –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–ò ==========
  auth.onAuthStateChanged(user => {
    if (user) {
      currentUser = user;
      document.getElementById('auth-screen').classList.add('hidden');
      document.getElementById('bank-screen').classList.remove('hidden');
      loadUserData(user.uid);
    } else {
      currentUser = null;
      document.getElementById('auth-screen').classList.remove('hidden');
      document.getElementById('bank-screen').classList.add('hidden');
      closeAllModals();
    }
  });
})();
</script>
</body>
</html>

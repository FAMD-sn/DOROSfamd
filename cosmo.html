<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ö–æ—Å–º–∏—á–µ—Å–∫–∏–π –∑–∞—â–∏—Ç–Ω–∏–∫ - –ü–æ–ª–Ω–∞—è –≤–µ—Ä—Å–∏—è</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        body {
            background: linear-gradient(135deg, #0c0c2e 0%, #1a1a3e 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: white;
            overflow: hidden;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        #gameContainer {
            position: relative;
            width: 100%;
            height: 100%;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        @media (max-width: 768px) {
            #gameContainer {
                max-width: 500px;
            }
        }
        
        #gameCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        
        #ui {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
            pointer-events: none;
        }
        
        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: rgba(10, 10, 30, 0.95);
            z-index: 10;
            padding: 20px;
            text-align: center;
            overflow-y: auto;
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 20px;
            color: #4deeea;
            text-shadow: 0 0 15px #4deeea;
            animation: glow 2s infinite alternate;
        }
        
        @keyframes glow {
            from { text-shadow: 0 0 10px #4deeea; }
            to { text-shadow: 0 0 20px #4deeea; }
        }
        
        h2 {
            font-size: 1.8rem;
            margin-bottom: 15px;
            color: #74ee15;
        }
        
        h3 {
            font-size: 1.4rem;
            margin-bottom: 10px;
            color: #4deeea;
        }
        
        p {
            font-size: 1.1rem;
            margin-bottom: 20px;
            line-height: 1.5;
            max-width: 90%;
        }
        
        /* –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
        @media (max-width: 768px) {
            h1 { font-size: 2rem; }
            h2 { font-size: 1.5rem; }
            h3 { font-size: 1.2rem; }
            p { font-size: 1rem; }
        }
        
        .stats {
            display: flex;
            justify-content: space-around;
            width: 100%;
            padding: 15px;
            font-size: 1rem;
            background-color: rgba(0, 0, 0, 0.6);
            border-radius: 15px;
            margin-bottom: 20px;
            border: 2px solid rgba(77, 238, 234, 0.3);
            flex-wrap: wrap;
        }
        
        .stat {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 5px;
            min-width: 100px;
        }
        
        .stat-label {
            font-size: 0.8rem;
            color: #aaddff;
            margin-bottom: 5px;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #74ee15;
            text-shadow: 0 0 8px #74ee15;
        }
        
        .btn {
            background: linear-gradient(to bottom, #4deeea, #2a9d9a);
            color: #0c0c2e;
            border: none;
            border-radius: 50px;
            padding: 15px 30px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            margin: 10px;
            pointer-events: auto;
            transition: all 0.2s;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
            min-width: 200px;
            position: relative;
            overflow: hidden;
        }
        
        @media (max-width: 768px) {
            .btn {
                padding: 12px 25px;
                font-size: 1rem;
                min-width: 180px;
                margin: 8px;
            }
        }
        
        .btn::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: 0.5s;
        }
        
        .btn:hover::after {
            left: 100%;
        }
        
        .btn:hover, .btn:active {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
            background: linear-gradient(to bottom, #5dfefa, #3abdb9);
        }
        
        .btn:active {
            transform: translateY(-1px);
        }
        
        .btn-small {
            padding: 8px 16px;
            font-size: 0.9rem;
            min-width: auto;
        }
        
        .btn-disabled {
            background: linear-gradient(to bottom, #666, #444);
            color: #888;
            cursor: not-allowed;
        }
        
        .btn-disabled:hover {
            transform: none !important;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4) !important;
            background: linear-gradient(to bottom, #666, #444) !important;
        }
        
        .hidden {
            display: none !important;
        }
        
        /* –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
        .control-panel {
            position: absolute;
            bottom: 25px;
            width: 100%;
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 0 25px;
            pointer-events: none;
            z-index: 3;
        }
        
        @media (min-width: 769px) {
            .control-panel {
                display: none;
            }
        }
        
        .control-btn {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.25);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.4rem;
            color: white;
            pointer-events: auto;
            border: 4px solid rgba(255, 255, 255, 0.4);
            touch-action: manipulation;
            transition: all 0.1s;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .control-btn:active {
            transform: scale(0.95);
            background-color: rgba(255, 255, 255, 0.35);
        }
        
        .fire-btn {
            background: linear-gradient(to bottom, #ff4d4d, #cc0000);
            border-color: rgba(255, 100, 100, 0.9);
            box-shadow: 0 0 15px rgba(255, 100, 100, 0.5);
        }
        
        .fire-btn:active {
            background: linear-gradient(to bottom, #ff6666, #dd2222);
            box-shadow: 0 0 25px rgba(255, 100, 100, 0.7);
        }
        
        .joystick {
            position: relative;
            width: 120px;
            height: 120px;
            pointer-events: auto;
            touch-action: manipulation;
        }
        
        .joystick-base {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.15);
            border: 4px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 0 15px rgba(77, 238, 234, 0.3);
        }
        
        .joystick-head {
            position: absolute;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(255,255,255,0.9) 0%, rgba(200,200,255,0.7) 100%);
            top: 30px;
            left: 30px;
            transition: transform 0.05s;
            border: 3px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.4);
        }
        
        /* –≠–ª–µ–º–µ–Ω—Ç—ã UI */
        .coin-display {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 12px 20px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            border: 2px solid rgba(255, 215, 0, 0.5);
            z-index: 3;
            pointer-events: none;
        }
        
        .coin-icon {
            font-size: 1.5rem;
            margin-right: 8px;
            color: gold;
        }
        
        .coin-amount {
            font-size: 1.5rem;
            font-weight: bold;
            color: gold;
        }
        
        .ship-info {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 12px;
            border-radius: 10px;
            border: 2px solid #4deeea;
            display: flex;
            align-items: center;
            pointer-events: none;
            z-index: 3;
        }
        
        @media (max-width: 768px) {
            .ship-info {
                bottom: 120px;
                right: 10px;
                padding: 8px;
            }
        }
        
        .ship-icon {
            width: 30px;
            height: 30px;
            background: #4deeea;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            font-size: 1.2rem;
            margin-right: 10px;
        }
        
        .ship-text {
            font-size: 1rem;
        }
        
        .ship-level {
            color: #74ee15;
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        /* –ü—Ä–∏—Ü–µ–ª –¥–ª—è –ü–ö */
        #crosshair {
            position: absolute;
            width: 20px;
            height: 20px;
            z-index: 3;
            pointer-events: none;
        }
        
        .crosshair-dot {
            position: absolute;
            width: 6px;
            height: 6px;
            background: #74ee15;
            border-radius: 50%;
            top: 7px;
            left: 7px;
            box-shadow: 0 0 8px #74ee15;
        }
        
        .crosshair-line {
            position: absolute;
            background: rgba(116, 238, 21, 0.7);
        }
        
        .crosshair-h {
            width: 20px;
            height: 2px;
            top: 9px;
            left: 0;
        }
        
        .crosshair-v {
            width: 2px;
            height: 20px;
            top: 0;
            left: 9px;
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <canvas id="gameCanvas"></canvas>
        
        <div id="crosshair">
            <div class="crosshair-line crosshair-h"></div>
            <div class="crosshair-line crosshair-v"></div>
            <div class="crosshair-dot"></div>
        </div>
        
        <div id="ui">
            <div class="stats">
                <div class="stat">
                    <div class="stat-label">–£–†–û–í–ï–ù–¨</div>
                    <div id="levelValue" class="stat-value">1</div>
                </div>
                <div class="stat">
                    <div class="stat-label">–ñ–ò–ó–ù–ò</div>
                    <div id="livesValue" class="stat-value">3</div>
                </div>
                <div class="stat">
                    <div class="stat-label">–°–ö–û–†–û–°–¢–†–ï–õ–¨–ù–û–°–¢–¨</div>
                    <div id="fireRateValue" class="stat-value">1.0x</div>
                </div>
                <div class="stat">
                    <div class="stat-label">–£–†–û–ù</div>
                    <div id="damageValue" class="stat-value">1.0x</div>
                </div>
            </div>
            
            <div class="coin-display">
                <div class="coin-icon">ü™ô</div>
                <div id="coinAmount" class="coin-amount">1000</div>
            </div>
            
            <div class="ship-info" id="shipInfo">
                <div class="ship-icon" id="shipIcon">üöÄ</div>
                <div class="ship-text">
                    –ö–æ—Ä–∞–±–ª—å: <span class="ship-level" id="shipName">–°—Ç–∞—Ä—Ç–æ–≤—ã–π</span>
                </div>
            </div>
            
            <!-- –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö -->
            <div class="control-panel">
                <div class="joystick" id="joystick">
                    <div class="joystick-base"></div>
                    <div class="joystick-head" id="joystickHead"></div>
                </div>
                <div class="control-btn fire-btn" id="fireBtn">FIRE</div>
            </div>
        </div>
        
        <!-- –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é -->
        <div id="mainMenu" class="screen">
            <div class="menu-buttons">
                <h1>–ö–û–°–ú–ò–ß–ï–°–ö–ò–ô –ó–ê–©–ò–¢–ù–ò–ö</h1>
                <p>–ó–∞—Ä–∞–±–∞—Ç—ã–≤–∞–π—Ç–µ –º–æ–Ω–µ—Ç—ã, —É–ª—É—á—à–∞–π—Ç–µ –∫–æ—Ä–∞–±–ª–∏ –∏ –∑–∞—â–∏—Ç–∏—Ç–µ –≥–∞–ª–∞–∫—Ç–∏–∫—É!</p>
                
                <button id="startBtn" class="btn menu-btn">–ù–û–í–ê–Ø –ò–ì–†–ê</button>
                <button id="continueBtn" class="btn menu-btn" style="display: none;">–ü–†–û–î–û–õ–ñ–ò–¢–¨</button>
                <button id="shopBtn" class="btn menu-btn">–ú–ê–ì–ê–ó–ò–ù –£–õ–£–ß–®–ï–ù–ò–ô</button>
                <button id="shipsBtn" class="btn menu-btn">–í–´–ë–û–† –ö–û–†–ê–ë–õ–Ø</button>
                <button id="controlsBtn" class="btn menu-btn">–£–ü–†–ê–í–õ–ï–ù–ò–ï</button>
                <button id="soundToggle" class="btn menu-btn">–ó–í–£–ö: –í–ö–õ</button>
                <button id="joystickToggle" class="btn menu-btn">–í–ö–õ –î–ñ–û–ô–°–¢–ò–ö</button>
            </div>
        </div>
        
        <!-- –≠–∫—Ä–∞–Ω —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
        <div id="controlsScreen" class="screen hidden">
            <button class="back-btn btn btn-small" id="backFromControls">‚Üê –ù–ê–ó–ê–î</button>
            <h2>–£–ü–†–ê–í–õ–ï–ù–ò–ï</h2>
            
            <div class="instructions">
                <div class="controls-info">
                    <div class="control-group">
                        <div class="control-item">
                            <div class="key">W / ‚Üë</div>
                            <div>–î–≤–∏–∂–µ–Ω–∏–µ –≤–≤–µ—Ä—Ö</div>
                        </div>
                        <div class="control-item">
                            <div class="key">S / ‚Üì</div>
                            <div>–î–≤–∏–∂–µ–Ω–∏–µ –≤–Ω–∏–∑</div>
                        </div>
                        <div class="control-item">
                            <div class="key">A / ‚Üê</div>
                            <div>–î–≤–∏–∂–µ–Ω–∏–µ –≤–ª–µ–≤–æ</div>
                        </div>
                        <div class="control-item">
                            <div class="key">D / ‚Üí</div>
                            <div>–î–≤–∏–∂–µ–Ω–∏–µ –≤–ø—Ä–∞–≤–æ</div>
                        </div>
                        <div class="control-item">
                            <div class="key">SHIFT</div>
                            <div>–£—Å–∫–æ—Ä–µ–Ω–∏–µ</div>
                        </div>
                    </div>
                    <div class="control-group">
                        <div class="control-item">
                            <div class="key-mouse">–õ–ö–ú</div>
                            <div>–°—Ç—Ä–µ–ª—å–±–∞</div>
                        </div>
                        <div class="control-item">
                            <div class="key">–ü–†–û–ë–ï–õ</div>
                            <div>–ê–≤—Ç–æ—Å—Ç—Ä–µ–ª—å–±–∞</div>
                        </div>
                        <div class="control-item">
                            <div class="key">P</div>
                            <div>–ü–∞—É–∑–∞</div>
                        </div>
                        <div class="control-item">
                            <div class="key">ESC</div>
                            <div>–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</div>
                        </div>
                        <div class="control-item">
                            <div class="key-mouse">–°–ö–ú</div>
                            <div>–°–ø–µ—Ü. –∞—Ç–∞–∫–∞</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="instructions">
                <h3>–ú–æ–±–∏–ª—å–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:</h3>
                <ul>
                    <li>–î–∂–æ–π—Å—Ç–∏–∫ —Å–ª–µ–≤–∞ - –¥–≤–∏–∂–µ–Ω–∏–µ –∫–æ—Ä–∞–±–ª—è</li>
                    <li>–ö–Ω–æ–ø–∫–∞ FIRE - —Å—Ç—Ä–µ–ª—å–±–∞ (—É–¥–µ—Ä–∂–∞–Ω–∏–µ –¥–ª—è –∞–≤—Ç–æ–æ–≥–Ω—è)</li>
                    <li>–ö–∞—Å–∞–Ω–∏–µ —ç–∫—Ä–∞–Ω–∞ - –ø–∞—É–∑–∞</li>
                </ul>
            </div>
        </div>
        
        <!-- –≠–∫—Ä–∞–Ω –º–∞–≥–∞–∑–∏–Ω–∞ -->
        <div id="shopScreen" class="screen hidden">
            <div class="menu-header">
                <button class="back-btn btn btn-small" id="backFromShop">‚Üê –ù–ê–ó–ê–î</button>
                <div class="current-ship-display">
                    <div class="current-ship-icon" id="currentShipIcon">üöÄ</div>
                    <div class="current-ship-name" id="currentShipName">–°—Ç–∞—Ä—Ç–æ–≤—ã–π</div>
                </div>
            </div>
            
            <h2>–ú–ê–ì–ê–ó–ò–ù –£–õ–£–ß–®–ï–ù–ò–ô</h2>
            <p>–£–ª—É—á—à–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –∫ —Ç–µ–∫—É—â–µ–º—É –∫–æ—Ä–∞–±–ª—é</p>
            
            <div class="tab-container">
                <div class="tab active" data-tab="weapons">–û—Ä—É–∂–∏–µ</div>
                <div class="tab" data-tab="defense">–ó–∞—â–∏—Ç–∞</div>
                <div class="tab" data-tab="special">–û—Å–æ–±—ã–µ</div>
            </div>
            
            <div class="shop-container">
                <div class="shop-categories" id="shopCategories">
                    <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –±—É–¥—É—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω—ã —Å–∫—Ä–∏–ø—Ç–æ–º -->
                </div>
                
                <div class="shop-items">
                    <div class="shop-items-grid" id="shopItemsGrid">
                        <!-- –¢–æ–≤–∞—Ä—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- –≠–∫—Ä–∞–Ω –≤—ã–±–æ—Ä–∞ –∫–æ—Ä–∞–±–ª—è -->
        <div id="shipSelectScreen" class="screen hidden">
            <button class="back-btn btn btn-small" id="backFromShips">‚Üê –ù–ê–ó–ê–î</button>
            <h2>–í–´–ë–û–† –ö–û–†–ê–ë–õ–Ø</h2>
            <p>–ö–∞–∂–¥—ã–π –∫–æ—Ä–∞–±–ª—å –∏–º–µ–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏</p>
            
            <div class="ships-container" id="shipsContainer">
                <!-- –ö–æ—Ä–∞–±–ª–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>
        </div>
        
        <!-- –≠–∫—Ä–∞–Ω –ø–∞—É–∑—ã -->
        <div id="pauseScreen" class="screen hidden">
            <h2>–ü–ê–£–ó–ê</h2>
            <div class="stats">
                <div class="stat">
                    <div class="stat-label">–ú–û–ù–ï–¢–´</div>
                    <div id="pauseCoinsValue" class="stat-value">0</div>
                </div>
                <div class="stat">
                    <div class="stat-label">–ñ–ò–ó–ù–ò</div>
                    <div id="pauseLivesValue" class="stat-value">3</div>
                </div>
                <div class="stat">
                    <div class="stat-label">–£–†–û–í–ï–ù–¨</div>
                    <div id="pauseLevelValue" class="stat-value">1</div>
                </div>
            </div>
            <button id="resumeBtn" class="btn">–ü–†–û–î–û–õ–ñ–ò–¢–¨</button>
            <button id="restartBtn" class="btn">–ù–ê–ß–ê–¢–¨ –ó–ê–ù–û–í–û</button>
            <button id="pauseMenuBtn" class="btn">–ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ</button>
        </div>
        
        <!-- –≠–∫—Ä–∞–Ω –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∏–≥—Ä—ã -->
        <div id="gameOverScreen" class="screen hidden">
            <h2>–ò–ì–†–ê –û–ö–û–ù–ß–ï–ù–ê</h2>
            <p>–í–∞—à –∫–æ—Ä–∞–±–ª—å –±—ã–ª —É–Ω–∏—á—Ç–æ–∂–µ–Ω!</p>
            <div class="stats">
                <div class="stat">
                    <div class="stat-label">–ó–ê–†–ê–ë–û–¢–ê–ù–û –ú–û–ù–ï–¢</div>
                    <div id="finalCoinsValue" class="stat-value">0</div>
                </div>
                <div class="stat">
                    <div class="stat-label">–ü–†–û–ô–î–ï–ù–û –£–†–û–í–ù–ï–ô</div>
                    <div id="finalLevelValue" class="stat-value">1</div>
                </div>
                <div class="stat">
                    <div class="stat-label">–£–ù–ò–ß–¢–û–ñ–ï–ù–û –í–†–ê–ì–û–í</div>
                    <div id="finalEnemiesValue" class="stat-value">0</div>
                </div>
            </div>
            <button id="playAgainBtn" class="btn">–ò–ì–†–ê–¢–¨ –°–ù–û–í–ê</button>
            <button id="gameOverMenuBtn" class="btn">–ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ</button>
        </div>
    </div>

    <script>
        // –°–∏—Å—Ç–µ–º–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
        const gameData = {
            version: '2.0',
            coins: 1000,
            selectedShip: 'ship1',
            unlockedShips: ['ship1'],
            shipUpgrades: {
                ship1: {
                    damage: 0,
                    fireRate: 0,
                    bulletSpeed: 0,
                    specialAttack: 0,
                    health: 0,
                    speed: 0,
                    shield: 0
                },
                ship2: {
                    damage: 0,
                    fireRate: 0,
                    bulletSpeed: 0,
                    specialAttack: 0,
                    health: 0,
                    speed: 0,
                    shield: 0
                },
                ship3: {
                    damage: 0,
                    fireRate: 0,
                    bulletSpeed: 0,
                    specialAttack: 0,
                    health: 0,
                    speed: 0,
                    shield: 0
                }
            },
            purchasedUpgrades: [],
            useJoystick: false
        };

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ localStorage
        function loadGameData() {
            const savedData = localStorage.getItem('spaceDefenderData');
            if (savedData) {
                try {
                    const parsedData = JSON.parse(savedData);
                    if (parsedData.version === gameData.version) {
                        Object.assign(gameData, parsedData);
                    }
                } catch (e) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', e);
                }
            }
            updateCoinDisplay();
            updateCurrentShipDisplay();
            updateJoystickToggle();
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ localStorage
        function saveGameData() {
            localStorage.setItem('spaceDefenderData', JSON.stringify(gameData));
        }

        // –û—Å–Ω–æ–≤–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–≥—Ä—ã
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const crosshair = document.getElementById('crosshair');
        const coinAmount = document.getElementById('coinAmount');
        const shipInfo = document.getElementById('shipInfo');
        const shipIcon = document.getElementById('shipIcon');
        const shipName = document.getElementById('shipName');
        
        // –≠–ª–µ–º–µ–Ω—Ç—ã –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        const levelValue = document.getElementById('levelValue');
        const livesValue = document.getElementById('livesValue');
        const fireRateValue = document.getElementById('fireRateValue');
        const damageValue = document.getElementById('damageValue');
        
        // –≠–ª–µ–º–µ–Ω—Ç—ã —ç–∫—Ä–∞–Ω–æ–≤
        const pauseCoinsValue = document.getElementById('pauseCoinsValue');
        const pauseLivesValue = document.getElementById('pauseLivesValue');
        const pauseLevelValue = document.getElementById('pauseLevelValue');
        const finalCoinsValue = document.getElementById('finalCoinsValue');
        const finalLevelValue = document.getElementById('finalLevelValue');
        const finalEnemiesValue = document.getElementById('finalEnemiesValue');
        const currentShipIcon = document.getElementById('currentShipIcon');
        const currentShipName = document.getElementById('currentShipName');
        
        // –≠–ª–µ–º–µ–Ω—Ç—ã –º–æ–±–∏–ª—å–Ω–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        const fireBtn = document.getElementById('fireBtn');
        const joystick = document.getElementById('joystick');
        const joystickHead = document.getElementById('joystickHead');
        const joystickToggle = document.getElementById('joystickToggle');
        
        // –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã
        let game = {
            running: false,
            paused: false,
            coinsEarned: 0,
            level: 1,
            enemiesDestroyed: 0,
            soundEnabled: true,
            mouseX: 0,
            mouseY: 0,
            mouseDown: false,
            spaceDown: false,
            middleMouseDown: false,
            keys: {},
            player: null,
            enemies: [],
            bullets: [],
            enemyBullets: [],
            particles: [],
            lastEnemySpawn: 0,
            enemySpawnRate: 2000,
            enemySpawnCount: 0,
            specialAttackCharge: 0,
            maxSpecialAttackCharge: 100,
            joystick: { x: 0, y: 0, active: false },
            autoFire: false,
            autoFireInterval: null
        };

        // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–æ—Ä–∞–±–ª–µ–π
        const ships = {
            ship1: {
                id: 'ship1',
                name: '–°—Ç–∞—Ä—Ç–æ–≤—ã–π',
                description: '–ë–∞–∑–æ–≤—ã–π –∫–æ—Ä–∞–±–ª—å —Å —Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞–º–∏',
                price: 0,
                baseStats: {
                    speed: 5,
                    boostSpeed: 8,
                    health: 3,
                    damage: 1.0,
                    fireRate: 1.0,
                    bulletSpeed: 12,
                    specialAttackPower: 1.0,
                    model: 'üöÄ'
                },
                color: '#4deeea'
            },
            ship2: {
                id: 'ship2',
                name: '–°–∫–æ—Ä–æ—Å—Ç–Ω–æ–π',
                description: '–ë—ã—Å—Ç—Ä—ã–π –∫–æ—Ä–∞–±–ª—å —Å –ø–æ–≤—ã—à–µ–Ω–Ω–æ–π —Å–∫–æ—Ä–æ—Å—Ç—Ä–µ–ª—å–Ω–æ—Å—Ç—å—é',
                price: 500,
                baseStats: {
                    speed: 7,
                    boostSpeed: 10,
                    health: 2,
                    damage: 0.8,
                    fireRate: 1.5,
                    bulletSpeed: 15,
                    specialAttackPower: 0.8,
                    model: 'üõ∏'
                },
                color: '#74ee15'
            },
            ship3: {
                id: 'ship3',
                name: '–¢—è–∂–µ–ª—ã–π',
                description: '–ú–æ—â–Ω—ã–π –∫–æ—Ä–∞–±–ª—å —Å –≤—ã—Å–æ–∫–æ–π –∑–∞—â–∏—Ç–æ–π –∏ —É—Ä–æ–Ω–æ–º',
                price: 1000,
                baseStats: {
                    speed: 3,
                    boostSpeed: 5,
                    health: 5,
                    damage: 1.5,
                    fireRate: 0.7,
                    bulletSpeed: 10,
                    specialAttackPower: 1.5,
                    model: 'üõ∞Ô∏è'
                },
                color: '#ff4d6d'
            }
        };

        // –ü–æ–ª–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —É–ª—É—á—à–µ–Ω–∏–π —Å –≤—Å–µ–º–∏ —É—Ä–æ–≤–Ω—è–º–∏
        const upgrades = {
            weapons: {
                damage: [
                    { 
                        id: 'damage1', 
                        name: '–£—Å–∏–ª–µ–Ω–∏–µ –æ—Ä—É–∂–∏—è I', 
                        description: '–£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —É—Ä–æ–Ω –Ω–∞ 20%', 
                        price: 100, 
                        effectValue: 0.2, 
                        maxLevel: 5,
                        currentLevel: 0
                    },
                    { 
                        id: 'damage2', 
                        name: '–£—Å–∏–ª–µ–Ω–∏–µ –æ—Ä—É–∂–∏—è II', 
                        description: '–£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —É—Ä–æ–Ω –Ω–∞ 40%', 
                        price: 200, 
                        effectValue: 0.4, 
                        maxLevel: 5,
                        currentLevel: 0,
                        requires: 'damage1'
                    },
                    { 
                        id: 'damage3', 
                        name: '–£—Å–∏–ª–µ–Ω–∏–µ –æ—Ä—É–∂–∏—è III', 
                        description: '–£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —É—Ä–æ–Ω –Ω–∞ 60%', 
                        price: 300, 
                        effectValue: 0.6, 
                        maxLevel: 5,
                        currentLevel: 0,
                        requires: 'damage2'
                    },
                    { 
                        id: 'damage4', 
                        name: '–£—Å–∏–ª–µ–Ω–∏–µ –æ—Ä—É–∂–∏—è IV', 
                        description: '–£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —É—Ä–æ–Ω –Ω–∞ 80%', 
                        price: 400, 
                        effectValue: 0.8, 
                        maxLevel: 5,
                        currentLevel: 0,
                        requires: 'damage3'
                    },
                    { 
                        id: 'damage5', 
                        name: '–£—Å–∏–ª–µ–Ω–∏–µ –æ—Ä—É–∂–∏—è V', 
                        description: '–£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —É—Ä–æ–Ω –Ω–∞ 100%', 
                        price: 500, 
                        effectValue: 1.0, 
                        maxLevel: 5,
                        currentLevel: 0,
                        requires: 'damage4'
                    }
                ],
                fireRate: [
                    { 
                        id: 'fireRate1', 
                        name: '–ë—ã—Å—Ç—Ä–∞—è –ø–µ—Ä–µ–∑–∞—Ä—è–¥–∫–∞ I', 
                        description: '–£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —Å–∫–æ—Ä–æ—Å—Ç—Ä–µ–ª—å–Ω–æ—Å—Ç—å –Ω–∞ 10%', 
                        price: 150, 
                        effectValue: 0.1, 
                        maxLevel: 5,
                        currentLevel: 0
                    },
                    { 
                        id: 'fireRate2', 
                        name: '–ë—ã—Å—Ç—Ä–∞—è –ø–µ—Ä–µ–∑–∞—Ä—è–¥–∫–∞ II', 
                        description: '–£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —Å–∫–æ—Ä–æ—Å—Ç—Ä–µ–ª—å–Ω–æ—Å—Ç—å –Ω–∞ 20%', 
                        price: 250, 
                        effectValue: 0.2, 
                        maxLevel: 5,
                        currentLevel: 0,
                        requires: 'fireRate1'
                    },
                    { 
                        id: 'fireRate3', 
                        name: '–ë—ã—Å—Ç—Ä–∞—è –ø–µ—Ä–µ–∑–∞—Ä—è–¥–∫–∞ III', 
                        description: '–£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —Å–∫–æ—Ä–æ—Å—Ç—Ä–µ–ª—å–Ω–æ—Å—Ç—å –Ω–∞ 30%', 
                        price: 350, 
                        effectValue: 0.3, 
                        maxLevel: 5,
                        currentLevel: 0,
                        requires: 'fireRate2'
                    },
                    { 
                        id: 'fireRate4', 
                        name: '–ë—ã—Å—Ç—Ä–∞—è –ø–µ—Ä–µ–∑–∞—Ä—è–¥–∫–∞ IV', 
                        description: '–£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —Å–∫–æ—Ä–æ—Å—Ç—Ä–µ–ª—å–Ω–æ—Å—Ç—å –Ω–∞ 40%', 
                        price: 450, 
                        effectValue: 0.4, 
                        maxLevel: 5,
                        currentLevel: 0,
                        requires: 'fireRate3'
                    },
                    { 
                        id: 'fireRate5', 
                        name: '–ë—ã—Å—Ç—Ä–∞—è –ø–µ—Ä–µ–∑–∞—Ä—è–¥–∫–∞ V', 
                        description: '–£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —Å–∫–æ—Ä–æ—Å—Ç—Ä–µ–ª—å–Ω–æ—Å—Ç—å –Ω–∞ 50%', 
                        price: 550, 
                        effectValue: 0.5, 
                        maxLevel: 5,
                        currentLevel: 0,
                        requires: 'fireRate4'
                    }
                ],
                bulletSpeed: [
                    { 
                        id: 'bulletSpeed1', 
                        name: '–£—Å–∫–æ—Ä–µ–Ω–Ω—ã–µ –ø–∞—Ç—Ä–æ–Ω—ã I', 
                        description: '–£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —Å–∫–æ—Ä–æ—Å—Ç—å –ø—É–ª—å –Ω–∞ 15%', 
                        price: 120, 
                        effectValue: 0.15, 
                        maxLevel: 3,
                        currentLevel: 0
                    },
                    { 
                        id: 'bulletSpeed2', 
                        name: '–£—Å–∫–æ—Ä–µ–Ω–Ω—ã–µ –ø–∞—Ç—Ä–æ–Ω—ã II', 
                        description: '–£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —Å–∫–æ—Ä–æ—Å—Ç—å –ø—É–ª—å –Ω–∞ 30%', 
                        price: 240, 
                        effectValue: 0.3, 
                        maxLevel: 3,
                        currentLevel: 0,
                        requires: 'bulletSpeed1'
                    },
                    { 
                        id: 'bulletSpeed3', 
                        name: '–£—Å–∫–æ—Ä–µ–Ω–Ω—ã–µ –ø–∞—Ç—Ä–æ–Ω—ã III', 
                        description: '–£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —Å–∫–æ—Ä–æ—Å—Ç—å –ø—É–ª—å –Ω–∞ 45%', 
                        price: 360, 
                        effectValue: 0.45, 
                        maxLevel: 3,
                        currentLevel: 0,
                        requires: 'bulletSpeed2'
                    }
                ],
                specialAttack: [
                    { 
                        id: 'specialAttack1', 
                        name: '–£—Å–∏–ª–µ–Ω–∏–µ —Å–ø–µ—Ü. –∞—Ç–∞–∫–∏ I', 
                        description: '–£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –º–æ—â–Ω–æ—Å—Ç—å —Å–ø–µ—Ü. –∞—Ç–∞–∫–∏ –Ω–∞ 25%', 
                        price: 200, 
                        effectValue: 0.25, 
                        maxLevel: 3,
                        currentLevel: 0
                    },
                    { 
                        id: 'specialAttack2', 
                        name: '–£—Å–∏–ª–µ–Ω–∏–µ —Å–ø–µ—Ü. –∞—Ç–∞–∫–∏ II', 
                        description: '–£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –º–æ—â–Ω–æ—Å—Ç—å —Å–ø–µ—Ü. –∞—Ç–∞–∫–∏ –Ω–∞ 50%', 
                        price: 400, 
                        effectValue: 0.5, 
                        maxLevel: 3,
                        currentLevel: 0,
                        requires: 'specialAttack1'
                    },
                    { 
                        id: 'specialAttack3', 
                        name: '–£—Å–∏–ª–µ–Ω–∏–µ —Å–ø–µ—Ü. –∞—Ç–∞–∫–∏ III', 
                        description: '–£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –º–æ—â–Ω–æ—Å—Ç—å —Å–ø–µ—Ü. –∞—Ç–∞–∫–∏ –Ω–∞ 75%', 
                        price: 600, 
                        effectValue: 0.75, 
                        maxLevel: 3,
                        currentLevel: 0,
                        requires: 'specialAttack2'
                    }
                ]
            },
            defense: {
                health: [
                    { 
                        id: 'health1', 
                        name: '–£—Å–∏–ª–µ–Ω–Ω—ã–π –∫–æ—Ä–ø—É—Å I', 
                        description: '–£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –∑–¥–æ—Ä–æ–≤—å–µ –Ω–∞ 1', 
                        price: 150, 
                        effectValue: 1, 
                        maxLevel: 5,
                        currentLevel: 0
                    },
                    { 
                        id: 'health2', 
                        name: '–£—Å–∏–ª–µ–Ω–Ω—ã–π –∫–æ—Ä–ø—É—Å II', 
                        description: '–£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –∑–¥–æ—Ä–æ–≤—å–µ –Ω–∞ 2', 
                        price: 250, 
                        effectValue: 2, 
                        maxLevel: 5,
                        currentLevel: 0,
                        requires: 'health1'
                    },
                    { 
                        id: 'health3', 
                        name: '–£—Å–∏–ª–µ–Ω–Ω—ã–π –∫–æ—Ä–ø—É—Å III', 
                        description: '–£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –∑–¥–æ—Ä–æ–≤—å–µ –Ω–∞ 3', 
                        price: 350, 
                        effectValue: 3, 
                        maxLevel: 5,
                        currentLevel: 0,
                        requires: 'health2'
                    },
                    { 
                        id: 'health4', 
                        name: '–£—Å–∏–ª–µ–Ω–Ω—ã–π –∫–æ—Ä–ø—É—Å IV', 
                        description: '–£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –∑–¥–æ—Ä–æ–≤—å–µ –Ω–∞ 4', 
                        price: 450, 
                        effectValue: 4, 
                        maxLevel: 5,
                        currentLevel: 0,
                        requires: 'health3'
                    },
                    { 
                        id: 'health5', 
                        name: '–£—Å–∏–ª–µ–Ω–Ω—ã–π –∫–æ—Ä–ø—É—Å V', 
                        description: '–£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –∑–¥–æ—Ä–æ–≤—å–µ –Ω–∞ 5', 
                        price: 550, 
                        effectValue: 5, 
                        maxLevel: 5,
                        currentLevel: 0,
                        requires: 'health4'
                    }
                ],
                shield: [
                    { 
                        id: 'shield1', 
                        name: '–≠–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–∏–π —â–∏—Ç I', 
                        description: '–î–æ–±–∞–≤–ª—è–µ—Ç —â–∏—Ç, –ø–æ–≥–ª–æ—â–∞—é—â–∏–π 1 —É—Ä–æ–Ω', 
                        price: 300, 
                        effectValue: 1, 
                        maxLevel: 3,
                        currentLevel: 0
                    },
                    { 
                        id: 'shield2', 
                        name: '–≠–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–∏–π —â–∏—Ç II', 
                        description: '–î–æ–±–∞–≤–ª—è–µ—Ç —â–∏—Ç, –ø–æ–≥–ª–æ—â–∞—é—â–∏–π 2 —É—Ä–æ–Ω–∞', 
                        price: 600, 
                        effectValue: 2, 
                        maxLevel: 3,
                        currentLevel: 0,
                        requires: 'shield1'
                    },
                    { 
                        id: 'shield3', 
                        name: '–≠–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–∏–π —â–∏—Ç III', 
                        description: '–î–æ–±–∞–≤–ª—è–µ—Ç —â–∏—Ç, –ø–æ–≥–ª–æ—â–∞—é—â–∏–π 3 —É—Ä–æ–Ω–∞', 
                        price: 900, 
                        effectValue: 3, 
                        maxLevel: 3,
                        currentLevel: 0,
                        requires: 'shield2'
                    }
                ]
            },
            special: {
                speed: [
                    { 
                        id: 'speed1', 
                        name: '–£–ª—É—á—à–µ–Ω–Ω—ã–µ –¥–≤–∏–≥–∞—Ç–µ–ª–∏ I', 
                        description: '–£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —Å–∫–æ—Ä–æ—Å—Ç—å –Ω–∞ 10%', 
                        price: 100, 
                        effectValue: 0.1, 
                        maxLevel: 5,
                        currentLevel: 0
                    },
                    { 
                        id: 'speed2', 
                        name: '–£–ª—É—á—à–µ–Ω–Ω—ã–µ –¥–≤–∏–≥–∞—Ç–µ–ª–∏ II', 
                        description: '–£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —Å–∫–æ—Ä–æ—Å—Ç—å –Ω–∞ 20%', 
                        price: 200, 
                        effectValue: 0.2, 
                        maxLevel: 5,
                        currentLevel: 0,
                        requires: 'speed1'
                    },
                    { 
                        id: 'speed3', 
                        name: '–£–ª—É—á—à–µ–Ω–Ω—ã–µ –¥–≤–∏–≥–∞—Ç–µ–ª–∏ III', 
                        description: '–£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —Å–∫–æ—Ä–æ—Å—Ç—å –Ω–∞ 30%', 
                        price: 300, 
                        effectValue: 0.3, 
                        maxLevel: 5,
                        currentLevel: 0,
                        requires: 'speed2'
                    },
                    { 
                        id: 'speed4', 
                        name: '–£–ª—É—á—à–µ–Ω–Ω—ã–µ –¥–≤–∏–≥–∞—Ç–µ–ª–∏ IV', 
                        description: '–£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —Å–∫–æ—Ä–æ—Å—Ç—å –Ω–∞ 40%', 
                        price: 400, 
                        effectValue: 0.4, 
                        maxLevel: 5,
                        currentLevel: 0,
                        requires: 'speed3'
                    },
                    { 
                        id: 'speed5', 
                        name: '–£–ª—É—á—à–µ–Ω–Ω—ã–µ –¥–≤–∏–≥–∞—Ç–µ–ª–∏ V', 
                        description: '–£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —Å–∫–æ—Ä–æ—Å—Ç—å –Ω–∞ 50%', 
                        price: 500, 
                        effectValue: 0.5, 
                        maxLevel: 5,
                        currentLevel: 0,
                        requires: 'speed4'
                    }
                ]
            }
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞–Ω–≤–∞—Å–∞
        function initCanvas() {
            const container = document.getElementById('gameContainer');
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
            if (gameData.useJoystick) {
                crosshair.style.display = 'none';
                document.querySelector('.control-panel').style.display = 'flex';
            } else {
                crosshair.style.display = 'block';
                document.querySelector('.control-panel').style.display = 'none';
            }
        }

        // –ö–ª–∞—Å—Å –∏–≥—Ä–æ–∫–∞
        class Player {
            constructor(shipId) {
                this.shipId = shipId;
                this.shipData = ships[shipId];
                this.upgrades = gameData.shipUpgrades[shipId];
                
                // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ —Å —É—á–µ—Ç–æ–º —É–ª—É—á—à–µ–Ω–∏–π
                const stats = this.calculateStats();
                
                this.x = canvas.width / 2;
                this.y = canvas.height - 120;
                this.width = 50;
                this.height = 70;
                this.speed = stats.speed;
                this.boostSpeed = stats.boostSpeed;
                this.color = this.shipData.color;
                this.maxHealth = stats.health;
                this.health = this.maxHealth;
                this.shield = stats.shield;
                this.maxShield = stats.shield;
                this.lastShot = 0;
                this.shootDelay = 300 / stats.fireRate;
                this.bulletSpeed = stats.bulletSpeed;
                this.damageMultiplier = stats.damage;
                this.specialAttackPower = stats.specialAttackPower;
                this.invincible = false;
                this.invincibleTime = 0;
                this.specialAttackCharging = false;
                this.specialAttackReady = false;
            }
            
            calculateStats() {
                const base = this.shipData.baseStats;
                const upgrades = this.upgrades;
                
                return {
                    speed: base.speed * (1 + upgrades.speed * 0.1),
                    boostSpeed: base.boostSpeed * (1 + upgrades.speed * 0.1),
                    health: base.health + upgrades.health,
                    damage: base.damage * (1 + upgrades.damage * 0.2),
                    fireRate: base.fireRate * (1 + upgrades.fireRate * 0.1),
                    bulletSpeed: base.bulletSpeed * (1 + upgrades.bulletSpeed * 0.15),
                    specialAttackPower: base.specialAttackPower * (1 + upgrades.specialAttack * 0.25),
                    shield: upgrades.shield
                };
            }
            
            draw() {
                ctx.save();
                
                // –†–∏—Å—É–µ–º —â–∏—Ç, –µ—Å–ª–∏ –µ—Å—Ç—å
                if (this.shield > 0) {
                    ctx.strokeStyle = `rgba(77, 238, 234, ${0.3 + this.shield / this.maxShield * 0.3})`;
                    ctx.lineWidth = 3;
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, Math.max(this.width, this.height) + 10, 0, Math.PI * 2);
                    ctx.stroke();
                }
                
                // –†–∏—Å—É–µ–º –∫–æ—Ä–ø—É—Å –∫–æ—Ä–∞–±–ª—è
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.moveTo(this.x, this.y - this.height/2);
                ctx.lineTo(this.x - this.width/2, this.y + this.height/2);
                ctx.lineTo(this.x + this.width/2, this.y + this.height/2);
                ctx.closePath();
                ctx.fill();
                
                // –†–∏—Å—É–µ–º –∫–∞–±–∏–Ω—É
                ctx.fillStyle = '#74ee15';
                ctx.beginPath();
                ctx.arc(this.x, this.y - 15, 15, 0, Math.PI * 2);
                ctx.fill();
                
                // –†–∏—Å—É–µ–º –¥–≤–∏–≥–∞—Ç–µ–ª–∏
                ctx.fillStyle = '#ff4d4d';
                ctx.fillRect(this.x - 15, this.y + this.height/2 - 10, 10, 15);
                ctx.fillRect(this.x + 5, this.y + this.height/2 - 10, 10, 15);
                
                // –≠—Ñ—Ñ–µ–∫—Ç –Ω–µ–≤–∏–¥–∏–º–æ—Å—Ç–∏
                if (this.invincible && Math.floor(Date.now() / 200) % 2 === 0) {
                    ctx.strokeStyle = 'rgba(255, 255, 255, 0.7)';
                    ctx.lineWidth = 3;
                    ctx.stroke();
                }
                
                // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–π –∞—Ç–∞–∫–∏
                if (this.specialAttackReady) {
                    ctx.fillStyle = 'rgba(255, 215, 0, 0.7)';
                    ctx.beginPath();
                    ctx.arc(this.x, this.y - this.height/2 - 20, 12, 0, Math.PI * 2);
                    ctx.fill();
                    
                    ctx.fillStyle = 'gold';
                    ctx.font = 'bold 14px Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText('!', this.x, this.y - this.height/2 - 20);
                }
                
                ctx.restore();
            }
            
            update() {
                // –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ
                let speed = game.keys['Shift'] ? this.boostSpeed : this.speed;
                
                if (gameData.useJoystick && game.joystick.active) {
                    // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∂–æ–π—Å—Ç–∏–∫–æ–º
                    this.x += game.joystick.x * speed;
                    this.y += game.joystick.y * speed;
                } else {
                    // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π (WASD –∏–ª–∏ —Å—Ç—Ä–µ–ª–æ—á–∫–∏)
                    if (game.keys['w'] || game.keys['ArrowUp']) {
                        this.y -= speed;
                    }
                    if (game.keys['s'] || game.keys['ArrowDown']) {
                        this.y += speed;
                    }
                    if (game.keys['a'] || game.keys['ArrowLeft']) {
                        this.x -= speed;
                    }
                    if (game.keys['d'] || game.keys['ArrowRight']) {
                        this.x += speed;
                    }
                }
                
                // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–≤–∏–∂–µ–Ω–∏—è
                this.x = Math.max(this.width/2, Math.min(canvas.width - this.width/2, this.x));
                this.y = Math.max(this.height/2, Math.min(canvas.height - this.height/2, this.y));
                
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –Ω–µ–≤–∏–¥–∏–º–æ—Å—Ç–∏
                if (this.invincible && Date.now() > this.invincibleTime) {
                    this.invincible = false;
                }
                
                // –°—Ç—Ä–µ–ª—å–±–∞
                if ((game.autoFire || game.spaceDown || game.mouseDown) && 
                    Date.now() - this.lastShot > this.shootDelay) {
                    this.shoot();
                }
                
                // –ó–∞—Ä—è–¥–∫–∞ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–π –∞—Ç–∞–∫–∏
                if (game.middleMouseDown && !this.specialAttackReady) {
                    this.specialAttackCharging = true;
                    game.specialAttackCharge = Math.min(game.maxSpecialAttackCharge, game.specialAttackCharge + 1);
                    
                    if (game.specialAttackCharge >= game.maxSpecialAttackCharge) {
                        this.specialAttackReady = true;
                        this.specialAttackCharging = false;
                    }
                } else {
                    this.specialAttackCharging = false;
                }
                
                // –ê–∫—Ç–∏–≤–∞—Ü–∏—è —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–π –∞—Ç–∞–∫–∏
                if (!game.middleMouseDown && this.specialAttackReady) {
                    this.useSpecialAttack();
                    this.specialAttackReady = false;
                    game.specialAttackCharge = 0;
                }
                
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI
                livesValue.textContent = this.health;
                fireRateValue.textContent = (1 / (this.shootDelay / 300)).toFixed(1) + 'x';
                damageValue.textContent = this.damageMultiplier.toFixed(1) + 'x';
            }
            
            shoot() {
                const now = Date.now();
                if (now - this.lastShot < this.shootDelay) return;
                
                this.lastShot = now;
                
                if (gameData.useJoystick) {
                    // –°—Ç—Ä–µ–ª—å–±–∞ –ø—Ä—è–º–æ –≤–≤–µ—Ä—Ö –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –¥–∂–æ–π—Å—Ç–∏–∫–∞
                    game.bullets.push(new Bullet(
                        this.x, 
                        this.y - this.height/2, 
                        0, 
                        -this.bulletSpeed, 
                        this.color, 
                        this.damageMultiplier
                    ));
                } else {
                    // –°—Ç—Ä–µ–ª—å–±–∞ –≤ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –∫—É—Ä—Å–æ—Ä–∞
                    const dx = game.mouseX - this.x;
                    const dy = game.mouseY - this.y;
                    const distance = Math.sqrt(dx*dx + dy*dy);
                    
                    if (distance === 0) return;
                    
                    const speed = this.bulletSpeed;
                    const vx = (dx / distance) * speed;
                    const vy = (dy / distance) * speed;
                    
                    game.bullets.push(new Bullet(
                        this.x, 
                        this.y - this.height/2, 
                        vx, 
                        vy, 
                        this.color, 
                        this.damageMultiplier
                    ));
                }
            }
            
            useSpecialAttack() {
                // –°–æ–∑–¥–∞–Ω–∏–µ –º–æ—â–Ω–æ–π –≤–æ–ª–Ω–æ–≤–æ–π –∞—Ç–∞–∫–∏
                for (let i = 0; i < 360; i += 15) {
                    const angle = (i * Math.PI) / 180;
                    const vx = Math.cos(angle) * 8;
                    const vy = Math.sin(angle) * 8;
                    game.bullets.push(new Bullet(
                        this.x, 
                        this.y, 
                        vx, 
                        vy, 
                        '#ff4d4d', 
                        this.damageMultiplier * this.specialAttackPower, 
                        true
                    ));
                }
                
                // –°–æ–∑–¥–∞–Ω–∏–µ —ç—Ñ—Ñ–µ–∫—Ç–∞ –≤–∑—Ä—ã–≤–∞
                for (let i = 0; i < 30; i++) {
                    game.particles.push(new Particle(
                        this.x, 
                        this.y, 
                        '#ff4d4d',
                        (Math.random() - 0.5) * 15,
                        (Math.random() - 0.5) * 15,
                        6
                    ));
                }
            }
            
            takeDamage() {
                if (this.invincible) return;
                
                // –°–Ω–∞—á–∞–ª–∞ –ø–æ–≥–ª–æ—â–∞–µ–º —É—Ä–æ–Ω —â–∏—Ç–æ–º
                if (this.shield > 0) {
                    this.shield--;
                    return;
                }
                
                // –ó–∞—Ç–µ–º –∑–¥–æ—Ä–æ–≤—å–µ
                this.health--;
                
                if (this.health <= 0) {
                    gameOver();
                } else {
                    // –í—Ä–µ–º–µ–Ω–Ω–∞—è –Ω–µ–≤–∏–¥–∏–º–æ—Å—Ç—å –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è —É—Ä–æ–Ω–∞
                    this.invincible = true;
                    this.invincibleTime = Date.now() + 2000;
                }
            }
        }

        // –ö–ª–∞—Å—Å –ø—É–ª–∏
        class Bullet {
            constructor(x, y, vx, vy, color, damageMultiplier = 1.0, special = false) {
                this.x = x;
                this.y = y;
                this.vx = vx;
                this.vy = vy;
                this.width = special ? 8 : 6;
                this.height = special ? 25 : 20;
                this.color = color;
                this.damageMultiplier = damageMultiplier;
                this.special = special;
                this.active = true;
            }
        
            draw() {
                ctx.save();
                
                if (this.special) {
                    // –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –ø—É–ª—è
                    ctx.fillStyle = this.color;
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.width, 0, Math.PI * 2);
                    ctx.fill();
                    
                    ctx.shadowColor = this.color;
                    ctx.shadowBlur = 15;
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.width, 0, Math.PI * 2);
                    ctx.fill();
                } else {
                    // –û–±—ã—á–Ω–∞—è –ø—É–ª—è
                    ctx.fillStyle = this.color;
                    
                    const angle = Math.atan2(this.vy, this.vx);
                    ctx.translate(this.x, this.y);
                    ctx.rotate(angle + Math.PI/2);
                    
                    ctx.fillRect(-this.width/2, -this.height/2, this.width, this.height);
                    
                    ctx.shadowColor = this.color;
                    ctx.shadowBlur = 10;
                    ctx.fillRect(-this.width/2, -this.height/2, this.width, this.height);
                }
                
                ctx.restore();
            }
            
            update() {
                this.x += this.vx;
                this.y += this.vy;
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã—Ö–æ–¥–∞ –∑–∞ –ø—Ä–µ–¥–µ–ª—ã —ç–∫—Ä–∞–Ω–∞
                if (this.y < -50 || this.y > canvas.height + 50 || 
                    this.x < -50 || this.x > canvas.width + 50) {
                    this.active = false;
                }
            }
        }

        // –ö–ª–∞—Å—Å –≤—Ä–∞–≥–∞
        class Enemy {
            constructor(x, y, type = 1) {
                this.x = x;
                this.y = y;
                this.type = type;
                this.width = type === 1 ? 40 : (type === 2 ? 60 : 80);
                this.height = type === 1 ? 40 : (type === 2 ? 60 : 80);
                this.speed = type === 1 ? 2.5 : (type === 2 ? 1.8 : 1.2);
                this.color = type === 1 ? '#ff4d6d' : (type === 2 ? '#ffaa00' : '#aa00ff');
                this.health = type === 1 ? 1 : (type === 2 ? 3 : 10);
                this.maxHealth = this.health;
                this.lastShot = 0;
                this.shootDelay = type === 1 ? 2000 : (type === 2 ? 1500 : 3000);
                this.coinReward = type === 1 ? 10 : (type === 2 ? 25 : 50);
                this.pattern = Math.floor(Math.random() * 3);
                this.patternTime = 0;
            }
            
            draw() {
                ctx.save();
                
                // –†–∏—Å—É–µ–º –≤—Ä–∞–∂–µ—Å–∫–∏–π –∫–æ—Ä–∞–±–ª—å
                if (this.type === 1) {
                    // –ú–∞–ª–µ–Ω—å–∫–∏–π –≤—Ä–∞–≥
                    ctx.fillStyle = this.color;
                    ctx.beginPath();
                    ctx.moveTo(this.x, this.y - this.height/2);
                    ctx.lineTo(this.x - this.width/2, this.y + this.height/2);
                    ctx.lineTo(this.x + this.width/2, this.y + this.height/2);
                    ctx.closePath();
                    ctx.fill();
                } else if (this.type === 2) {
                    // –°—Ä–µ–¥–Ω–∏–π –≤—Ä–∞–≥
                    ctx.fillStyle = this.color;
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.width/2, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // –î–µ—Ç–∞–ª–∏
                    ctx.fillStyle = '#ffdd99';
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.width/4, 0, Math.PI * 2);
                    ctx.fill();
                } else {
                    // –ë–æ–ª—å—à–æ–π –≤—Ä–∞–≥ (–±–æ—Å—Å)
                    ctx.fillStyle = this.color;
                    ctx.beginPath();
                    ctx.roundRect(this.x - this.width/2, this.y - this.height/2, this.width, this.height, 10);
                    ctx.fill();
                    
                    // –û–∫–Ω–∞
                    ctx.fillStyle = '#ff99ff';
                    for (let i = 0; i < 3; i++) {
                        ctx.beginPath();
                        ctx.arc(this.x - 15 + i * 15, this.y, 5, 0, Math.PI * 2);
                        ctx.fill();
                    }
                }
                
                // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–¥–æ—Ä–æ–≤—å—è –¥–ª—è –≤—Ä–∞–≥–æ–≤ 2 –∏ 3 —Ç–∏–ø–∞
                if (this.type > 1) {
                    const barWidth = this.width;
                    const barHeight = 6;
                    const barX = this.x - barWidth/2;
                    const barY = this.y - this.height/2 - 10;
                    
                    // –§–æ–Ω –ø–æ–ª–æ—Å–∫–∏ –∑–¥–æ—Ä–æ–≤—å—è
                    ctx.fillStyle = '#333';
                    ctx.fillRect(barX, barY, barWidth, barHeight);
                    
                    // –ó–¥–æ—Ä–æ–≤—å–µ
                    const healthWidth = (this.health / this.maxHealth) * barWidth;
                    ctx.fillStyle = this.type === 2 ? '#ffaa00' : '#aa00ff';
                    ctx.fillRect(barX, barY, healthWidth, barHeight);
                }
                
                ctx.restore();
            }
            
            update() {
                this.patternTime += 0.05;
                
                // –î–≤–∏–∂–µ–Ω–∏–µ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø–∞—Ç—Ç–µ—Ä–Ω–∞
                if (this.pattern === 0) {
                    // –ü—Ä—è–º–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ –≤–Ω–∏–∑
                    this.y += this.speed;
                } else if (this.pattern === 1) {
                    // –°–∏–Ω—É—Å–æ–∏–¥–∞–ª—å–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ
                    this.y += this.speed;
                    this.x += Math.sin(this.patternTime) * 2;
                } else {
                    // –î–≤–∏–∂–µ–Ω–∏–µ –ø–æ —Å–ø–∏—Ä–∞–ª–∏
                    this.y += this.speed * 0.7;
                    this.x += Math.cos(this.patternTime) * 3;
                }
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã—Ö–æ–¥–∞ –∑–∞ –ø—Ä–µ–¥–µ–ª—ã —ç–∫—Ä–∞–Ω–∞
                return this.y > canvas.height + this.height;
            }
            
            takeDamage(damage = 1) {
                this.health -= damage;
                return this.health <= 0;
            }
        }

        // –ö–ª–∞—Å—Å —á–∞—Å—Ç–∏—Ü –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–æ–≤
        class Particle {
            constructor(x, y, color, vx = 0, vy = 0, radius = null) {
                this.x = x;
                this.y = y;
                this.vx = vx || (Math.random() - 0.5) * 6;
                this.vy = vy || (Math.random() - 0.5) * 6;
                this.radius = radius || Math.random() * 4 + 2;
                this.color = color;
                this.life = 1;
                this.decay = 0.02;
            }
            
            draw() {
                ctx.save();
                ctx.globalAlpha = this.life;
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                ctx.fill();
                ctx.restore();
            }
            
            update() {
                this.x += this.vx;
                this.y += this.vy;
                this.life -= this.decay;
                return this.life > 0;
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–≥—Ä—ã
        function initGame() {
            // –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–≥—Ä—ã
            game.coinsEarned = 0;
            game.level = 1;
            game.enemiesDestroyed = 0;
            game.enemies = [];
            game.bullets = [];
            game.enemyBullets = [];
            game.particles = [];
            game.lastEnemySpawn = Date.now();
            game.enemySpawnRate = 2000;
            game.enemySpawnCount = 0;
            game.specialAttackCharge = 0;
            game.joystick = { x: 0, y: 0, active: false };
            
            // –°–æ–∑–¥–∞–Ω–∏–µ –∏–≥—Ä–æ–∫–∞ —Å –≤—ã–±—Ä–∞–Ω–Ω—ã–º –∫–æ—Ä–∞–±–ª–µ–º
            game.player = new Player(gameData.selectedShip);
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI
            levelValue.textContent = game.level;
            livesValue.textContent = game.player.health;
            fireRateValue.textContent = (1 / (game.player.shootDelay / 300)).toFixed(1) + 'x';
            damageValue.textContent = game.player.damageMultiplier.toFixed(1) + 'x';
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–æ—Ä–∞–±–ª–µ
            updateShipInfo();
            
            // –°–∫—Ä—ã—Ç–∏–µ –≤—Å–µ—Ö —ç–∫—Ä–∞–Ω–æ–≤
            hideAllScreens();
            
            // –ü–æ–∫–∞–∑–∞—Ç—å –∏–≥—Ä–æ–≤—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
            if (!gameData.useJoystick) {
                crosshair.style.display = 'block';
            }
            shipInfo.style.display = 'flex';
            
            // –ó–∞–ø—É—Å–∫ –∏–≥—Ä–æ–≤–æ–≥–æ —Ü–∏–∫–ª–∞
            game.running = true;
            game.paused = false;
            requestAnimationFrame(gameLoop);
        }

        // –ò–≥—Ä–æ–≤–æ–π —Ü–∏–∫–ª
        function gameLoop() {
            if (!game.running || game.paused) return;
            
            // –û—á–∏—Å—Ç–∫–∞ –∫–∞–Ω–≤–∞—Å–∞
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // –†–∏—Å–æ–≤–∞–Ω–∏–µ —Ñ–æ–Ω–∞
            drawBackground();
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏ –æ—Ç—Ä–∏—Å–æ–≤–∫–∞ –∏–≥—Ä–æ–∫–∞
            game.player.update();
            game.player.draw();
            
            // –°–ø–∞–≤–Ω –≤—Ä–∞–≥–æ–≤
            const now = Date.now();
            if (now - game.lastEnemySpawn > game.enemySpawnRate) {
                spawnEnemy();
                game.lastEnemySpawn = now;
                game.enemySpawnCount++;
                
                // –£–≤–µ–ª–∏—á–µ–Ω–∏–µ —á–∞—Å—Ç–æ—Ç—ã —Å–ø–∞–≤–Ω–∞ —Å–æ –≤—Ä–µ–º–µ–Ω–µ–º
                if (game.enemySpawnCount % 5 === 0) {
                    game.enemySpawnRate = Math.max(800, game.enemySpawnRate - 100);
                }
            }
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏ –æ—Ç—Ä–∏—Å–æ–≤–∫–∞ –≤—Ä–∞–≥–æ–≤
            for (let i = game.enemies.length - 1; i >= 0; i--) {
                const enemy = game.enemies[i];
                
                if (enemy.update()) {
                    // –£–¥–∞–ª–µ–Ω–∏–µ –≤—Ä–∞–≥–æ–≤, –≤—ã—à–µ–¥—à–∏—Ö –∑–∞ –ø—Ä–µ–¥–µ–ª—ã —ç–∫—Ä–∞–Ω–∞
                    game.enemies.splice(i, 1);
                    continue;
                }
                
                enemy.draw();
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏—è —Å –∏–≥—Ä–æ–∫–æ–º
                if (!game.player.invincible && checkCollision(game.player, enemy)) {
                    game.player.takeDamage();
                    createExplosion(enemy.x, enemy.y, enemy.color);
                    game.enemies.splice(i, 1);
                    continue;
                }
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏—è —Å –ø—É–ª—è–º–∏ –∏–≥—Ä–æ–∫–∞
                for (let j = game.bullets.length - 1; j >= 0; j--) {
                    const bullet = game.bullets[j];
                    
                    if (checkCollision(bullet, enemy)) {
                        const damage = bullet.special ? 3 * bullet.damageMultiplier : bullet.damageMultiplier;
                        if (enemy.takeDamage(damage)) {
                            // –£–Ω–∏—á—Ç–æ–∂–µ–Ω–∏–µ –≤—Ä–∞–≥–∞
                            game.coinsEarned += enemy.coinReward;
                            game.enemiesDestroyed++;
                            updateCoinDisplay();
                            createExplosion(enemy.x, enemy.y, enemy.color);
                            game.enemies.splice(i, 1);
                        }
                        
                        if (!bullet.special) {
                            game.bullets.splice(j, 1);
                        }
                        break;
                    }
                }
            }
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏ –æ—Ç—Ä–∏—Å–æ–≤–∫–∞ –ø—É–ª—å –∏–≥—Ä–æ–∫–∞
            for (let i = game.bullets.length - 1; i >= 0; i--) {
                const bullet = game.bullets[i];
                bullet.update();
                
                if (!bullet.active) {
                    game.bullets.splice(i, 1);
                } else {
                    bullet.draw();
                }
            }
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏ –æ—Ç—Ä–∏—Å–æ–≤–∫–∞ —á–∞—Å—Ç–∏—Ü
            for (let i = game.particles.length - 1; i >= 0; i--) {
                const particle = game.particles[i];
                
                if (!particle.update()) {
                    game.particles.splice(i, 1);
                } else {
                    particle.draw();
                }
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ—Ö–æ–¥–∞ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–≤–µ–Ω—å
            if (game.enemiesDestroyed >= game.level * 10) {
                nextLevel();
            }
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ –ø—Ä–∏—Ü–µ–ª–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è –ü–ö)
            if (!gameData.useJoystick) {
                updateCrosshair();
            }
            
            // –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –∏–≥—Ä–æ–≤–æ–≥–æ —Ü–∏–∫–ª–∞
            requestAnimationFrame(gameLoop);
        }

        // –§—É–Ω–∫—Ü–∏—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ —Ñ–æ–Ω–∞
        function drawBackground() {
            // –¢–µ–º–Ω—ã–π —Ñ–æ–Ω
            ctx.fillStyle = '#0a0a1e';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // –†–∏—Å—É–µ–º –∑–≤–µ–∑–¥—ã
            ctx.fillStyle = 'white';
            for (let i = 0; i < 200; i++) {
                const alpha = 0.3 + 0.7 * Math.sin(Date.now() / 1000 + i * 0.1);
                ctx.globalAlpha = alpha;
                
                const x = (i * 23) % canvas.width;
                const y = (i * 17) % canvas.height;
                const size = (i % 4) + 1;
                
                ctx.fillRect(x, y, size, size);
            }
            
            ctx.globalAlpha = 1;
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –≤–∑—Ä—ã–≤–∞
        function createExplosion(x, y, color) {
            for (let i = 0; i < 20; i++) {
                game.particles.push(new Particle(x, y, color));
            }
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–π
        function checkCollision(obj1, obj2) {
            return obj1.x - obj1.width/2 < obj2.x + obj2.width/2 &&
                   obj1.x + obj1.width/2 > obj2.x - obj2.width/2 &&
                   obj1.y - obj1.height/2 < obj2.y + obj2.height/2 &&
                   obj1.y + obj1.height/2 > obj2.y - obj2.height/2;
        }

        // –°–ø–∞–≤–Ω –≤—Ä–∞–≥–∞
        function spawnEnemy() {
            let type;
            const rand = Math.random();
            
            if (game.level < 3) {
                type = rand < 0.7 ? 1 : 2;
            } else if (game.level < 5) {
                type = rand < 0.5 ? 1 : (rand < 0.9 ? 2 : 3);
            } else {
                type = rand < 0.3 ? 1 : (rand < 0.7 ? 2 : 3);
            }
            
            const x = Math.random() * (canvas.width - 100) + 50;
            const y = -50;
            
            game.enemies.push(new Enemy(x, y, type));
        }

        // –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–≤–µ–Ω—å
        function nextLevel() {
            game.level++;
            levelValue.textContent = game.level;
            
            // –°–±—Ä–æ—Å –ø–æ–∑–∏—Ü–∏–∏ –∏–≥—Ä–æ–∫–∞
            game.player.x = canvas.width / 2;
            game.player.y = canvas.height - 120;
            game.player.invincible = true;
            game.player.invincibleTime = Date.now() + 2000;
            
            // –£–≤–µ–ª–∏—á–µ–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏ –≤—Ä–∞–≥–æ–≤
            game.enemySpawnRate = Math.max(600, game.enemySpawnRate - 100);
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –º–æ–Ω–µ—Ç
        function updateCoinDisplay() {
            coinAmount.textContent = gameData.coins + game.coinsEarned;
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–æ—Ä–∞–±–ª–µ
        function updateShipInfo() {
            const ship = ships[gameData.selectedShip];
            shipIcon.textContent = ship.baseStats.model;
            shipName.textContent = ship.name;
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ –∫–æ—Ä–∞–±–ª—è
        function updateCurrentShipDisplay() {
            const ship = ships[gameData.selectedShip];
            currentShipIcon.textContent = ship.baseStats.model;
            currentShipName.textContent = ship.name;
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ –ø—Ä–∏—Ü–µ–ª–∞
        function updateCrosshair() {
            crosshair.style.left = (game.mouseX - 10) + 'px';
            crosshair.style.top = (game.mouseY - 10) + 'px';
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ –¥–∂–æ–π—Å—Ç–∏–∫–∞
        function updateJoystickToggle() {
            if (joystickToggle) {
                joystickToggle.textContent = gameData.useJoystick ? '–í–´–ö–õ –î–ñ–û–ô–°–¢–ò–ö' : '–í–ö–õ –î–ñ–û–ô–°–¢–ò–ö';
            }
        }

        // –ö–æ–Ω–µ—Ü –∏–≥—Ä—ã
        function gameOver() {
            game.running = false;
            clearInterval(game.autoFireInterval);
            
            // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –º–æ–Ω–µ—Ç
            gameData.coins += game.coinsEarned;
            saveGameData();
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ–∏–Ω–∞–ª—å–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
            finalCoinsValue.textContent = game.coinsEarned;
            finalLevelValue.textContent = game.level;
            finalEnemiesValue.textContent = game.enemiesDestroyed;
            
            // –°–∫—Ä—ã—Ç–∏–µ –∏–≥—Ä–æ–≤—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
            crosshair.style.display = 'none';
            shipInfo.style.display = 'none';
            
            // –ü–æ–∫–∞–∑ —ç–∫—Ä–∞–Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∏–≥—Ä—ã
            showScreen('gameOverScreen');
        }

        // –ü–∞—É–∑–∞ –∏–≥—Ä—ã
        function pauseGame() {
            if (!game.running) return;
            
            game.paused = !game.paused;
            
            if (game.paused) {
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –Ω–∞ —ç–∫—Ä–∞–Ω–µ –ø–∞—É–∑—ã
                pauseCoinsValue.textContent = gameData.coins + game.coinsEarned;
                pauseLivesValue.textContent = game.player.health;
                pauseLevelValue.textContent = game.level;
                
                // –°–∫—Ä—ã—Ç–∏–µ –∏–≥—Ä–æ–≤—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
                crosshair.style.display = 'none';
                
                // –ü–æ–∫–∞–∑ —ç–∫—Ä–∞–Ω–∞ –ø–∞—É–∑—ã
                showScreen('pauseScreen');
            } else {
                // –°–∫—Ä—ã—Ç–∏–µ —ç–∫—Ä–∞–Ω–∞ –ø–∞—É–∑—ã
                hideAllScreens();
                
                // –ü–æ–∫–∞–∑–∞—Ç—å –∏–≥—Ä–æ–≤—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
                if (!gameData.useJoystick) {
                    crosshair.style.display = 'block';
                }
                
                // –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –∏–≥—Ä—ã
                requestAnimationFrame(gameLoop);
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–π —ç–∫—Ä–∞–Ω
        function showScreen(screenId) {
            // –°–∫—Ä—ã—Ç—å –≤—Å–µ —ç–∫—Ä–∞–Ω—ã
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.add('hidden');
            });
            
            // –ü–æ–∫–∞–∑–∞—Ç—å –Ω—É–∂–Ω—ã–π —ç–∫—Ä–∞–Ω
            document.getElementById(screenId).classList.remove('hidden');
            
            // –ï—Å–ª–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é, –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–≥—Ä—É
            if (screenId === 'mainMenu') {
                game.running = false;
                game.paused = false;
                clearInterval(game.autoFireInterval);
                crosshair.style.display = 'none';
                shipInfo.style.display = 'none';
                
                // –ü–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫—É –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è, –µ—Å–ª–∏ –∏–≥—Ä–∞ –±—ã–ª–∞ –∑–∞–ø—É—â–µ–Ω–∞
                const continueBtn = document.getElementById('continueBtn');
                continueBtn.style.display = game.player ? 'block' : 'none';
            }
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö, –µ—Å–ª–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–∞–≥–∞–∑–∏–Ω –∏–ª–∏ –≤—ã–±–æ—Ä –∫–æ—Ä–∞–±–ª–µ–π
            if (screenId === 'shopScreen') {
                loadShop();
                updateCurrentShipDisplay();
            } else if (screenId === 'shipSelectScreen') {
                loadShips();
            }
        }

        // –°–∫—Ä—ã—Ç—å –≤—Å–µ —ç–∫—Ä–∞–Ω—ã
        function hideAllScreens() {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.add('hidden');
            });
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –º–∞–≥–∞–∑–∏–Ω–∞
        function loadShop() {
            // –û—á–∏—Å—Ç–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
            const shopCategories = document.getElementById('shopCategories');
            shopCategories.innerHTML = '';
            
            // –û—á–∏—Å—Ç–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤
            const shopItemsGrid = document.getElementById('shopItemsGrid');
            shopItemsGrid.innerHTML = '';
            
            // –ü–æ–ª—É—á–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ–π –≤–∫–ª–∞–¥–∫–∏
            const activeTab = document.querySelector('.tab.active');
            if (!activeTab) return;
            
            const tabType = activeTab.dataset.tab;
            const categoryUpgrades = upgrades[tabType];
            
            // –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
            Object.keys(categoryUpgrades).forEach(category => {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'shop-category';
                categoryDiv.dataset.category = category;
                
                // –ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                let categoryName = '';
                switch(category) {
                    case 'damage': categoryName = '–£—Ä–æ–Ω'; break;
                    case 'fireRate': categoryName = '–°–∫–æ—Ä–æ—Å—Ç—Ä–µ–ª—å–Ω–æ—Å—Ç—å'; break;
                    case 'bulletSpeed': categoryName = '–°–∫–æ—Ä–æ—Å—Ç—å –ø—É–ª—å'; break;
                    case 'specialAttack': categoryName = '–°–ø–µ—Ü. –∞—Ç–∞–∫–∞'; break;
                    case 'health': categoryName = '–ó–¥–æ—Ä–æ–≤—å–µ'; break;
                    case 'shield': categoryName = '–©–∏—Ç'; break;
                    case 'speed': categoryName = '–°–∫–æ—Ä–æ—Å—Ç—å'; break;
                }
                
                categoryDiv.textContent = categoryName;
                
                // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –ø–µ—Ä–≤—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é
                if (Object.keys(categoryUpgrades)[0] === category) {
                    categoryDiv.classList.add('active');
                    loadCategoryItems(category, categoryUpgrades[category]);
                }
                
                categoryDiv.addEventListener('click', function() {
                    document.querySelectorAll('.shop-category').forEach(c => c.classList.remove('active'));
                    this.classList.add('active');
                    loadCategoryItems(category, categoryUpgrades[category]);
                });
                
                shopCategories.appendChild(categoryDiv);
            });
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        function loadCategoryItems(category, items) {
            const shopItemsGrid = document.getElementById('shopItemsGrid');
            shopItemsGrid.innerHTML = '';
            
            const currentLevel = gameData.shipUpgrades[gameData.selectedShip][category] || 0;
            
            items.forEach(upgrade => {
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å —É–ª—É—á—à–µ–Ω–∏—è –∏–∑ –¥–∞–Ω–Ω—ã—Ö –∏–≥—Ä—ã
                const upgradeLevel = currentLevel >= upgrade.maxLevel ? upgrade.maxLevel : currentLevel;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∫—É–ø–ª–µ–Ω–æ –ª–∏ —ç—Ç–æ —É–ª—É—á—à–µ–Ω–∏–µ
                const isPurchased = currentLevel >= upgrade.maxLevel;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è
                let requirementsMet = true;
                if (upgrade.requires) {
                    const requiredUpgrade = items.find(u => u.id === upgrade.requires);
                    if (requiredUpgrade) {
                        requirementsMet = gameData.purchasedUpgrades.includes(upgrade.requires) || 
                                         gameData.shipUpgrades[gameData.selectedShip][category] >= 
                                         items.findIndex(u => u.id === upgrade.id);
                    }
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –º–æ–∂–Ω–æ –ª–∏ –∫—É–ø–∏—Ç—å
                const canPurchase = !isPurchased && gameData.coins >= upgrade.price && requirementsMet && 
                                  currentLevel === items.findIndex(u => u.id === upgrade.id);
                
                const shopItem = document.createElement('div');
                shopItem.className = 'shop-item';
                shopItem.innerHTML = `
                    <div class="shop-item-header">
                        <div class="shop-item-title">${upgrade.name}</div>
                        <div class="shop-item-price">
                            <span class="coin-small">ü™ô</span>${upgrade.price}
                        </div>
                    </div>
                    <div class="shop-item-description">${upgrade.description}</div>
                    <div class="shop-item-stats">
                        <div class="stat-bar">
                            <div>–¢–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å:</div>
                            <div class="upgrade-level">
                                <div class="level-indicator">
                                    ${Array.from({length: upgrade.maxLevel}, (_, i) => 
                                        `<div class="level-dot ${i < upgradeLevel ? 'active' : ''}"></div>`
                                    ).join('')}
                                </div>
                                <div class="stat-value-bar">${upgradeLevel}/${upgrade.maxLevel}</div>
                            </div>
                        </div>
                    </div>
                    ${isPurchased ? 
                        '<div class="purchased-badge">–ú–ê–ö–°–ò–ú–ê–õ–¨–ù–´–ô –£–†–û–í–ï–ù–¨</div>' :
                        (!requirementsMet ? 
                            '<div class="btn btn-small btn-disabled">–¢–†–ï–ë–£–ï–¢–°–Ø –ü–†–ï–î–´–î–£–©–ï–ï –£–õ–£–ß–®–ï–ù–ò–ï</div>' :
                            `<button class="btn btn-small ${canPurchase ? '' : 'btn-disabled'}" 
                                    data-upgrade="${upgrade.id}" data-price="${upgrade.price}" data-category="${category}">
                                ${canPurchase ? '–ö–£–ü–ò–¢–¨' : '–ù–ï–î–û–°–¢–ê–¢–û–ß–ù–û –ú–û–ù–ï–¢'}
                            </button>`
                        )
                    }
                `;
                
                shopItemsGrid.appendChild(shopItem);
            });
            
            // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –ø–æ–∫—É–ø–∫–∏
            document.querySelectorAll('.shop-item .btn:not(.btn-disabled)').forEach(btn => {
                btn.addEventListener('click', function() {
                    const upgradeId = this.dataset.upgrade;
                    const price = parseInt(this.dataset.price);
                    const category = this.dataset.category;
                    
                    if (gameData.coins >= price) {
                        gameData.coins -= price;
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º —É–ª—É—á—à–µ–Ω–∏–µ –≤ —Å–ø–∏—Å–æ–∫ –∫—É–ø–ª–µ–Ω–Ω—ã—Ö
                        if (!gameData.purchasedUpgrades.includes(upgradeId)) {
                            gameData.purchasedUpgrades.push(upgradeId);
                        }
                        
                        // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —É—Ä–æ–≤–µ–Ω—å —É–ª—É—á—à–µ–Ω–∏—è –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                        gameData.shipUpgrades[gameData.selectedShip][category] += 1;
                        
                        saveGameData();
                        updateCoinDisplay();
                        
                        // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ–∫—É—â—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é
                        const activeTab = document.querySelector('.tab.active');
                        if (activeTab) {
                            const tabType = activeTab.dataset.tab;
                            loadCategoryItems(category, upgrades[tabType][category]);
                        }
                    }
                });
            });
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –∫–æ—Ä–∞–±–ª–µ–π
        function loadShips() {
            const shipsContainer = document.getElementById('shipsContainer');
            shipsContainer.innerHTML = '';
            
            Object.values(ships).forEach(ship => {
                const isUnlocked = gameData.unlockedShips.includes(ship.id);
                const isSelected = gameData.selectedShip === ship.id;
                const canPurchase = !isUnlocked && gameData.coins >= ship.price;
                
                const shipCard = document.createElement('div');
                shipCard.className = `ship-card ${isSelected ? 'selected' : ''} ${!isUnlocked ? 'ship-locked' : ''}`;
                shipCard.innerHTML = `
                    <div class="ship-name">${ship.name}</div>
                    <div class="ship-preview">
                        <div class="ship-model">${ship.baseStats.model}</div>
                    </div>
                    <div class="ship-description">${ship.description}</div>
                    <div class="ship-stats">
                        <div class="ship-stat">
                            <div class="ship-stat-name">–°–∫–æ—Ä–æ—Å—Ç—å:</div>
                            <div class="ship-stat-value">${ship.baseStats.speed}</div>
                        </div>
                        <div class="ship-stat">
                            <div class="ship-stat-name">–ó–¥–æ—Ä–æ–≤—å–µ:</div>
                            <div class="ship-stat-value">${ship.baseStats.health}</div>
                        </div>
                        <div class="ship-stat">
                            <div class="ship-stat-name">–£—Ä–æ–Ω:</div>
                            <div class="ship-stat-value">${ship.baseStats.damage.toFixed(1)}</div>
                        </div>
                        <div class="ship-stat">
                            <div class="ship-stat-name">–°–∫–æ—Ä–æ—Å—Ç—Ä–µ–ª—å–Ω–æ—Å—Ç—å:</div>
                            <div class="ship-stat-value">${ship.baseStats.fireRate.toFixed(1)}</div>
                        </div>
                    </div>
                    ${isUnlocked ? 
                        (isSelected ? 
                            '<div class="selected-badge">–í–´–ë–†–ê–ù</div>' :
                            `<button class="btn btn-small select-ship-btn" data-ship="${ship.id}">–í–´–ë–†–ê–¢–¨</button>`
                        ) :
                        `<div class="ship-price">ü™ô ${ship.price}</div>
                         <button class="btn btn-small purchase-ship-btn ${canPurchase ? '' : 'btn-disabled'}" 
                                 data-ship="${ship.id}" data-price="${ship.price}">
                            ${canPurchase ? '–ö–£–ü–ò–¢–¨' : '–ù–ï–î–û–°–¢–ê–¢–û–ß–ù–û –ú–û–ù–ï–¢'}
                         </button>`
                    }
                `;
                
                shipsContainer.appendChild(shipCard);
            });
            
            // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –≤—ã–±–æ—Ä–∞ –∫–æ—Ä–∞–±–ª—è
            document.querySelectorAll('.select-ship-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const shipId = this.dataset.ship;
                    gameData.selectedShip = shipId;
                    saveGameData();
                    updateShipInfo();
                    updateCurrentShipDisplay();
                    loadShips();
                });
            });
            
            // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –ø–æ–∫—É–ø–∫–∏ –∫–æ—Ä–∞–±–ª—è
            document.querySelectorAll('.purchase-ship-btn:not(.btn-disabled)').forEach(btn => {
                btn.addEventListener('click', function() {
                    const shipId = this.dataset.ship;
                    const price = parseInt(this.dataset.price);
                    
                    if (gameData.coins >= price) {
                        gameData.coins -= price;
                        gameData.unlockedShips.push(shipId);
                        gameData.selectedShip = shipId;
                        
                        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —É–ª—É—á—à–µ–Ω–∏–π –¥–ª—è –Ω–æ–≤–æ–≥–æ –∫–æ—Ä–∞–±–ª—è
                        if (!gameData.shipUpgrades[shipId]) {
                            gameData.shipUpgrades[shipId] = {
                                damage: 0,
                                fireRate: 0,
                                bulletSpeed: 0,
                                specialAttack: 0,
                                health: 0,
                                speed: 0,
                                shield: 0
                            };
                        }
                        
                        saveGameData();
                        updateCoinDisplay();
                        updateShipInfo();
                        updateCurrentShipDisplay();
                        loadShips();
                    }
                });
            });
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        function initControls() {
            // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –¥–≤–∏–∂–µ–Ω–∏—è –º—ã—à–∏ (—Ç–æ–ª—å–∫–æ –¥–ª—è –ü–ö)
            document.addEventListener('mousemove', (e) => {
                const rect = canvas.getBoundingClientRect();
                game.mouseX = e.clientX - rect.left;
                game.mouseY = e.clientY - rect.top;
                
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ –ø—Ä–∏—Ü–µ–ª–∞
                if (game.running && !game.paused && !gameData.useJoystick) {
                    updateCrosshair();
                }
            });
            
            // –ù–∞–∂–∞—Ç–∏–µ –õ–ö–ú (–ü–ö)
            document.addEventListener('mousedown', (e) => {
                if (e.button === 0 && !gameData.useJoystick) {
                    game.mouseDown = true;
                } else if (e.button === 1 && !gameData.useJoystick) {
                    game.middleMouseDown = true;
                    e.preventDefault();
                }
            });
            
            // –û—Ç–ø—É—Å–∫–∞–Ω–∏–µ –õ–ö–ú (–ü–ö)
            document.addEventListener('mouseup', (e) => {
                if (e.button === 0 && !gameData.useJoystick) {
                    game.mouseDown = false;
                } else if (e.button === 1 && !gameData.useJoystick) {
                    game.middleMouseDown = false;
                }
            });
            
            // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –Ω–∞–∂–∞—Ç–∏–π –∫–ª–∞–≤–∏—à (–ü–ö)
            document.addEventListener('keydown', (e) => {
                const key = e.key.toLowerCase();
                game.keys[key] = true;
                
                // –ü—Ä–æ–±–µ–ª –¥–ª—è –∞–≤—Ç–æ—Å—Ç—Ä–µ–ª—å–±—ã
                if (key === ' ' && game.running && !game.paused) {
                    game.spaceDown = true;
                    e.preventDefault();
                }
                
                // –ü–∞—É–∑–∞ –ø–æ P
                if ((key === 'p' || key === 'escape') && game.running) {
                    pauseGame();
                    e.preventDefault();
                }
                
                // ESC –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –º–µ–Ω—é
                if (key === 'escape' && !game.running) {
                    showScreen('mainMenu');
                    e.preventDefault();
                }
            });
            
            // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –æ—Ç–ø—É—Å–∫–∞–Ω–∏—è –∫–ª–∞–≤–∏—à (–ü–ö)
            document.addEventListener('keyup', (e) => {
                const key = e.key.toLowerCase();
                game.keys[key] = false;
                
                if (key === ' ') {
                    game.spaceDown = false;
                }
            });
            
            // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é –ø–æ –ü–ö–ú
            canvas.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                return false;
            });
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∂–æ–π—Å—Ç–∏–∫–∞ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö –∏–ª–∏ –ø—Ä–∏ –≤–∫–ª—é—á–µ–Ω–Ω–æ–º –¥–∂–æ–π—Å—Ç–∏–∫–µ
            if (gameData.useJoystick) {
                initJoystick();
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∂–æ–π—Å—Ç–∏–∫–∞
        function initJoystick() {
            let joystickPressed = false;
            const joystickRect = joystick.getBoundingClientRect();
            const joystickCenterX = joystickRect.width / 2;
            const joystickCenterY = joystickRect.height / 2;
            const maxDistance = 40;
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–∞—Å–∞–Ω–∏–π –¥–ª—è –¥–∂–æ–π—Å—Ç–∏–∫–∞
            joystick.addEventListener('touchstart', handleJoystickStart);
            joystick.addEventListener('touchmove', handleJoystickMove);
            joystick.addEventListener('touchend', handleJoystickEnd);
            
            // –î–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –º—ã—à–∏ –Ω–∞ –ü–ö –ø—Ä–∏ –≤–∫–ª—é—á–µ–Ω–Ω–æ–º –¥–∂–æ–π—Å—Ç–∏–∫–µ
            joystick.addEventListener('mousedown', handleJoystickStart);
            document.addEventListener('mousemove', handleJoystickMove);
            document.addEventListener('mouseup', handleJoystickEnd);
            
            function handleJoystickStart(e) {
                e.preventDefault();
                joystickPressed = true;
                game.joystick.active = true;
                updateJoystick(e);
            }
            
            function handleJoystickMove(e) {
                if (!joystickPressed) return;
                e.preventDefault();
                updateJoystick(e);
            }
            
            function handleJoystickEnd(e) {
                e.preventDefault();
                joystickPressed = false;
                game.joystick.active = false;
                game.joystick.x = 0;
                game.joystick.y = 0;
                joystickHead.style.transform = 'translate(0, 0)';
            }
            
            function updateJoystick(e) {
                const rect = joystick.getBoundingClientRect();
                let clientX, clientY;
                
                if (e.type.includes('touch')) {
                    clientX = e.touches[0].clientX;
                    clientY = e.touches[0].clientY;
                } else {
                    clientX = e.clientX;
                    clientY = e.clientY;
                }
                
                const x = clientX - rect.left - joystickCenterX;
                const y = clientY - rect.top - joystickCenterY;
                const distance = Math.sqrt(x*x + y*y);
                
                if (distance > maxDistance) {
                    const angle = Math.atan2(y, x);
                    game.joystick.x = Math.cos(angle);
                    game.joystick.y = Math.sin(angle);
                    
                    const limitedX = Math.cos(angle) * maxDistance;
                    const limitedY = Math.sin(angle) * maxDistance;
                    joystickHead.style.transform = `translate(${limitedX}px, ${limitedY}px)`;
                } else {
                    game.joystick.x = x / maxDistance;
                    game.joystick.y = y / maxDistance;
                    joystickHead.style.transform = `translate(${x}px, ${y}px)`;
                }
            }
            
            // –ö–Ω–æ–ø–∫–∞ –æ–≥–Ω—è —Å –∞–≤—Ç–æ—Å—Ç—Ä–µ–ª—å–±–æ–π
            fireBtn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                if (game.running && !game.paused) {
                    game.autoFire = true;
                    clearInterval(game.autoFireInterval);
                    game.autoFireInterval = setInterval(() => {
                        if (game.running && !game.paused && game.autoFire) {
                            if (game.player) game.player.shoot();
                        }
                    }, game.player ? game.player.shootDelay : 300);
                }
            });
            
            fireBtn.addEventListener('touchend', (e) => {
                e.preventDefault();
                game.autoFire = false;
                clearInterval(game.autoFireInterval);
            });
            
            fireBtn.addEventListener('touchcancel', (e) => {
                e.preventDefault();
                game.autoFire = false;
                clearInterval(game.autoFireInterval);
            });
            
            // –î–ª—è –ü–ö –ø—Ä–∏ –≤–∫–ª—é—á–µ–Ω–Ω–æ–º –¥–∂–æ–π—Å—Ç–∏–∫–µ
            fireBtn.addEventListener('mousedown', (e) => {
                e.preventDefault();
                if (game.running && !game.paused) {
                    game.autoFire = true;
                    clearInterval(game.autoFireInterval);
                    game.autoFireInterval = setInterval(() => {
                        if (game.running && !game.paused && game.autoFire) {
                            if (game.player) game.player.shoot();
                        }
                    }, game.player ? game.player.shootDelay : 300);
                }
            });
            
            document.addEventListener('mouseup', (e) => {
                game.autoFire = false;
                clearInterval(game.autoFireInterval);
            });
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        function initUI() {
            // –ö–Ω–æ–ø–∫–∞ "–ù–æ–≤–∞—è –∏–≥—Ä–∞"
            document.getElementById('startBtn').addEventListener('click', () => {
                initGame();
            });
            
            // –ö–Ω–æ–ø–∫–∞ "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å"
            document.getElementById('continueBtn').addEventListener('click', () => {
                if (game.player) {
                    hideAllScreens();
                    if (!gameData.useJoystick) {
                        crosshair.style.display = 'block';
                    }
                    shipInfo.style.display = 'flex';
                    game.running = true;
                    game.paused = false;
                    requestAnimationFrame(gameLoop);
                }
            });
            
            // –ö–Ω–æ–ø–∫–∞ "–ú–∞–≥–∞–∑–∏–Ω"
            document.getElementById('shopBtn').addEventListener('click', () => {
                showScreen('shopScreen');
            });
            
            // –ö–Ω–æ–ø–∫–∞ "–ö–æ—Ä–∞–±–ª–∏"
            document.getElementById('shipsBtn').addEventListener('click', () => {
                showScreen('shipSelectScreen');
            });
            
            // –ö–Ω–æ–ø–∫–∞ "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ"
            document.getElementById('controlsBtn').addEventListener('click', () => {
                showScreen('controlsScreen');
            });
            
            // –ö–Ω–æ–ø–∫–∞ "–ó–≤—É–∫"
            document.getElementById('soundToggle').addEventListener('click', function() {
                game.soundEnabled = !game.soundEnabled;
                this.textContent = game.soundEnabled ? '–ó–í–£–ö: –í–ö–õ' : '–ó–í–£–ö: –í–´–ö–õ';
            });
            
            // –ö–Ω–æ–ø–∫–∞ "–î–∂–æ–π—Å—Ç–∏–∫"
            if (joystickToggle) {
                joystickToggle.addEventListener('click', function() {
                    gameData.useJoystick = !gameData.useJoystick;
                    saveGameData();
                    
                    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–∏–¥–∏–º–æ—Å—Ç–∏ —ç–ª–µ–º–µ–Ω—Ç–æ–≤
                    if (gameData.useJoystick) {
                        crosshair.style.display = 'none';
                        document.querySelector('.control-panel').style.display = 'flex';
                        initJoystick(); // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –¥–∂–æ–π—Å—Ç–∏–∫
                    } else {
                        crosshair.style.display = 'block';
                        document.querySelector('.control-panel').style.display = 'none';
                        // –°–±—Ä–æ—Å–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–∂–æ–π—Å—Ç–∏–∫–∞
                        game.joystick = { x: 0, y: 0, active: false };
                        joystickHead.style.transform = 'translate(0, 0)';
                    }
                    
                    updateJoystickToggle();
                });
            }
            
            // –ö–Ω–æ–ø–∫–∞ "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å" –≤ –ø–∞—É–∑–µ
            document.getElementById('resumeBtn').addEventListener('click', () => {
                pauseGame();
            });
            
            // –ö–Ω–æ–ø–∫–∞ "–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ" –≤ –ø–∞—É–∑–µ
            document.getElementById('restartBtn').addEventListener('click', () => {
                initGame();
            });
            
            // –ö–Ω–æ–ø–∫–∞ "–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é" –≤ –ø–∞—É–∑–µ
            document.getElementById('pauseMenuBtn').addEventListener('click', () => {
                showScreen('mainMenu');
            });
            
            // –ö–Ω–æ–ø–∫–∞ "–ò–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞" –≤ –∫–æ–Ω—Ü–µ –∏–≥—Ä—ã
            document.getElementById('playAgainBtn').addEventListener('click', () => {
                initGame();
            });
            
            // –ö–Ω–æ–ø–∫–∞ "–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é" –≤ –∫–æ–Ω—Ü–µ –∏–≥—Ä—ã
            document.getElementById('gameOverMenuBtn').addEventListener('click', () => {
                showScreen('mainMenu');
            });
            
            // –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥" –∏–∑ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
            document.getElementById('backFromControls').addEventListener('click', () => {
                showScreen('mainMenu');
            });
            
            // –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥" –∏–∑ –º–∞–≥–∞–∑–∏–Ω–∞
            document.getElementById('backFromShop').addEventListener('click', () => {
                showScreen('mainMenu');
            });
            
            // –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥" –∏–∑ –≤—ã–±–æ—Ä–∞ –∫–æ—Ä–∞–±–ª–µ–π
            document.getElementById('backFromShips').addEventListener('click', () => {
                showScreen('mainMenu');
            });
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–∫–ª–∞–¥–æ–∫ –≤ –º–∞–≥–∞–∑–∏–Ω–µ
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    loadShop();
                });
            });
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('load', () => {
            initCanvas();
            initControls();
            initUI();
            loadGameData();
            
            // –ü–æ–∫–∞–∑–∞—Ç—å –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
            showScreen('mainMenu');
            
            // –ê–¥–∞–ø—Ç–∞—Ü–∏—è –∫ –∏–∑–º–µ–Ω–µ–Ω–∏—é —Ä–∞–∑–º–µ—Ä–∞ —ç–∫—Ä–∞–Ω–∞
            window.addEventListener('resize', initCanvas);
            
            // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ —Å–∫—Ä–æ–ª–ª–∞ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö
            document.addEventListener('touchmove', (e) => {
                if (e.target.closest('.joystick') || e.target.closest('.control-btn') || 
                    e.target === canvas) {
                    e.preventDefault();
                }
            }, { passive: false });
        });
    </script>
</body>
</html>